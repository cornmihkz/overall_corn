---
title: "corn_variety_edit"
author: "Mihkail Cornell"
date: "2023-09-05"
output: html_document
---
```{r}
knitr::opts_chunk$set(echo = TRUE, fig.width=8, fig.height=5)
library("dplyr")
library("ggpubr")
library("tidymodels")
library("tidyverse")
library("ggpubr")
library("broom")
library("multcompView")
library("car")
library("rstatix")
library("FSA")
library("rcompanion")
library("dunn.test")
library("fuzzyjoin")
library("stringdist")

total_in_bpi <- 2898 # no. of validated entries

letters_height <- 64
mean_height <- 66
crop_growth_stages <- c("emergence", "single_leaf", "seedling", "early_whorl", "mid_whorl", 
                       "late_whorl", "tasseling", "silking", "maturity")
stage_labels <- c("Emergence", "Single leaf", "Seedling", "Early Whorl", "Mid whorl",
                        "Late whorl", "Tasseling", "Silking", "Maturity")

plot_width <- 4
plot_height <- 7
plot_dpi <- 250

set.seed(123)
insect_raw$Variety %>% unique()
```

```Corn variety engineering```
```{r}
corn_variety_edit <-
  insect_raw %>%
  mutate(variety_edited = case_when(str_detect(Variety, "^[OPV]+([_ ])+([WC]+|[WwHhIiTtEe]+)$") ~ "OPV White",
                             str_detect(Variety, "^[OPV]+([ _]*)+[YyEeLlOoWw]+") ~ "OPV Yellow",
                             str_detect(Variety, "^(M[ACHOacho]+)[_ ]*(F1)+") ~ "Macho F1",
                             str_detect(Variety, "^(S+[WwEeEeTt])(\\s)*([CcOoRrNn]+)") ~ "Sweet Corn Hybrid",
                             str_detect(Variety, "M[aALlAaGgKkIiTt]") ~ "Malagkit",
                             str_detect(Variety, "\\b(Y+[EeLlLlOoWw_* COoRrNn]+)+") ~ "Yellow Corn Hybrid",
                             str_detect(Variety, "(FILIPINA_703)+|(Filipina 703)+") ~ "Filipina 703-HY",
                             str_detect(Variety, "^([Cn])+") ~ "Cn 224-OPV White",
                             str_detect(Variety, "^\\(HYBRID YELLOW CORN\\)|^[Yellow Corn Hybrid]$") ~ "Hybrid Yellow Corn",
                             str_detect(Variety, "^([Mem]+[ei]s+)+") ~ "Memphis Native White Corn",
                             str_detect(Variety, "^((FILIPINA_802)+|(Fi[l+Äº]+[iu]+(pi)+[n ]+a+(\\s|-))*802)+") ~ "Filipina 802-Hybrid White",
                             str_detect(Variety, "[NK]+[ ]*[6410]+") ~ "NK6410 BT/GT Hybrid",
                             str_detect(Variety, "B[Rr][Ii]+[GgHhTt]") ~ "Bright Jane",
                             str_detect(Variety, "^J") ~ "J505",
                             str_detect(Variety, "^(Native) ([Ww]hite)$") ~ "Native White",
                             str_detect(Variety, "^(P+|[Pioneer]+)") ~ "Pioneer 266",
                             str_detect(Variety, "^(NSIC GM)") ~ "NSIC GM CN38",
                             str_detect(Variety, "^[Super 999]+") ~ "Super 999-HY",
                             str_detect(Variety, "\\b(Supreme 5150)+") ~ "Supreme 5150-HY",
                             str_detect(Variety, "B118G") ~ "B118G-Hybrid Yellow",
                             str_detect(Variety, "T+[INIGinig]+[u]*[IiBb]") ~ "Tiniguib",
                             str_detect(Variety, "G[LUTINOUSlutinous]") ~ "Glutinous White",
                             str_detect(Variety, "Bio [Ss]eed") ~ "Bio Seed",
                             str_detect(Variety, "(BioCorn 108)+") ~ "BioCorn 108-HY",
         TRUE ~ Variety)) 


```


```{r}
corn_varieties <-
  corn_variety_edit %>% 
  group_by(variety_edited) %>% 
  summarize(varieties_count = n()) %>% 
  arrange(desc(varieties_count))

write.csv(corn_varieties, "corn_varieties.csv")

number_sampled_plants <- 20
percent_100 <- 100
# corn_variety_edit$variety %>% unique()


corn_varieties %>%
  slice(1:5) %>%
  ggplot(aes(fct_reorder(variety_edited,
                         desc(varieties_count)), 
             varieties_count,
             fill = variety_edited)) +
  geom_col(show.legend = FALSE,
           width = 0.8) +
  geom_text(aes(label=varieties_count), vjust = 1.5, size = 8) +
  labs(x = "Top 5 Corn Varieties",
       y = "Number of Corn Varietes Planted") +
  scale_y_continuous(breaks = seq(0, 700, 25)) +
  theme(plot.background = element_rect(fill = NULL),
        axis.title = element_text(size = 16),
        axis.text = element_text(size = 12,
                                 margin = margin(r = 2, l = 2)))
ggsave("../write_ups/Top 5 Corn Varieties.png", width = 8, height = 5, dpi = 250)
```

```Rating of 1 is classified as No damage to very slight```
```Corn Borer, Semi-looper, earworm```
```Borer```
```{r}
# Corn borer
borer_df_ev <- 
  insect_raw %>%
  select(FarmID, `Collection Date`, Province, Municipality, Barangay, `Crop Stage`, Treatment, `Corn Type`, Variety, contains("Corn Borer - Damage Rating ")) %>%
  filter(Municipality != "Santa Rita" & Municipality != "Hilongos" & Municipality != "Tomas Oppus")

borer_df_ev$collect_date <- 
  as.Date(borer_df_ev$`Collection Date`, "%B %d, %Y")

borer_dmg_ev <-
  borer_df_ev %>% 
  mutate(Year = year(collect_date), Month = month(collect_date))

borer_joined_ev <-
  borer_dmg_ev %>% 
  left_join(monthly_averages, by=c('Year', 'Month')) %>%
  # mutate_at(c(9:28), as.factor) %>%
  # mutate(across(contains("Corn Borer - Damage Rating "), 
  #        ~ case_when( . < 2 ~ "No",
  #                     . < 4 ~ "Light",
  #                     . < 6 ~ "Moderate",
  #                     . < 8 ~ "Severe",
  #                     . < 10 ~ "High"), 
  #        .names="Class_Infest_{.col}")) %>%
  # mutate(across(contains("Class_Infest_Corn Borer - Damage Rating "), ~classification_dmg(.))) %>%
  # # get the modal observation rating
  #  mutate(Modeborer_class_infest = getmode(c_across(contains("Class_Infest_Corn Borer - Damage Rating ")))) %>%
  # # create ranks column
  # mutate(borer_mode_classification = rank(Modeborer_class_infest)) %>%
  rowwise() %>%
  mutate(sum_no = sum(c_across(starts_with("Corn Borer - Damage Rating ")) == "1"),
         sum_light = sum(c_across(starts_with("Corn Borer - Damage Rating ")) == "3"),
         sum_moderate = sum(c_across(starts_with("Corn Borer - Damage Rating ")) == "5"),
         sum_severe = sum(c_across(starts_with("Corn Borer - Damage Rating ")) == "7"),
         sum_high = sum(c_across(starts_with("Corn Borer - Damage Rating ")) == "9"),
         average_damage_borer = (((3 * sum_light) + (5 * sum_moderate) + (7 * sum_severe) + (9 * sum_high)) / (number_sampled_plants)),
         damage_rating_borer = (((3 * sum_light) + (5 * sum_moderate) + (7 * sum_severe) + (9 * sum_high)) / (number_sampled_plants * 9)) * percent_100,
         incidence_borer = ((sum(c_across(sum_light:sum_high))) * percent_100) / number_sampled_plants,
         )


#View(borer_joined_ev)

# borer_joined_ev %>%
#   count(Province, Municipality, `Corn Type`)

summary_borer <-
  borer_joined_ev %>%
  group_by(Year, Month, Province, Municipality, `Corn Type`,
           Barangay, Treatment, `Crop Stage`) %>%
  select(-`Crop Stage`) %>%
  remove_missing(na.rm=TRUE) %>%
  summarise(total_count_samples_borer = n() * number_sampled_plants,
            sum_avg_dmg_borer = sum(average_damage_borer),
            sum_dmg_rate_borer = sum(damage_rating_borer),
            sum_incidence_borer = sum(incidence_borer),
            percent_incidence_borer = (sum_incidence_borer / total_count_samples_borer) * percent_100)

#View(summary_borer)


summary_borer$crop_stage <- 
  factor(summary_borer$`Crop Stage`, 
         levels = c("Early Whorl", "Late Whorl", "Maturity", "Mid Whorl", "Seedling (3 - 4 Leaves)",
                    "Silking", "Single Leaf", "Tasseling", "Emergence"),
         labels = c("early_whorl", "late_whorl", "maturity", "mid_whorl", "seedling", 
                    "silking", "single_leaf", "tasseling", "emergence"))

summary_borer$order_treat <- ordered(summary_borer$Treatment,
                                     levels = c("BRFR", "RFR", "ARFR"),
                                     labels = c("B", "R", "A"))

summary_borer$factor_corn <- factor(summary_borer$`Corn Type`, 
                                    labels=c("N", "G"), 
                                    levels = c("Non - GM Corn", "GM CORN"))

ggqqplot(summary_borer$percent_incidence_borer)

library("nortest")
library("rcompanion")
library("moments")
library("stats")
library("MASS")
library("agricolae")
library("DescTools")

# Kolmogorov Smirnov test for normality samples > 50
ks_test_borer <- ks.test(summary_borer$percent_incidence_borer, 'pnorm')

# Anderson-Darling Test is a goodness-of-fit test that determines how well your data fits a given distribution. 
# This test is most typically used to see if your data follow a normal distribution or not.
# It is a modification of the Kolmogorov-Smirnov (K-S) test and 
# gives more weight to the tails than does the K-S test.
ad_test_borer <- ad.test(summary_borer$percent_incidence_borer)

skew_borer <- skewness(summary_borer$percent_incidence_borer)
kurt_borer <- kurtosis(summary_borer$percent_incidence_borer)

# Jarque-Bera Normality Test performs a goodness-of-fit test that 
# determines whether or not sample data have skewness and 
# kurtosis that matches a normal distribution.
jarq_borer <- jarque.test(summary_borer$percent_incidence_borer)

# Kruskall Wallis applied to one-way, non-normal data with more than two groups
kruskal_fertilizer_borer <- kruskal.test(percent_incidence_borer ~ order_treat, summary_borer)

# Mann-Whitney U test for differences between two independent treatments or conditions.   
# The continuous response variable of interest is not normally distributed.
utest_corn_borer <- wilcox.test(percent_incidence_borer ~ factor_corn, summary_borer)

# The Friedman test determines if there are differences among groups for two-way data structured in a specific way, namely in an unreplicated complete block design.  
# In this design, one variable serves as the treatment or group variable, 
# and another variable serves as the blocking variable.
# fried_fert_corn_borer <- summary_borer %>% friedman_test(percent_incidence_borer ~ order_treat |factor_corn)


# Null hypothesis is variances across all samples are equal. 
# Leveneâs test is an alternative to Bartlettâs test when the data is not normally distributed.
levenes_fertilizer_borer <- leveneTest(percent_incidence_borer ~ Treatment, summary_borer)
levenes_corntype_borer <- leveneTest(percent_incidence_borer ~ `Corn Type`, summary_borer)
levenes_municipality_borer <- leveneTest(percent_incidence_borer ~ Municipality, summary_borer)
levenes_province_borer <- leveneTest(percent_incidence_borer ~ Province, summary_borer)
levenes_fert_corn_borer <- leveneTest(percent_incidence_borer ~ interaction(Treatment, `Corn Type`), summary_borer)
levenes_stage_borer <- leveneTest(percent_incidence_borer ~ `Crop Stage`, summary_borer)

# AnOVa
aov_fert_borer <- aov(percent_incidence_borer ~ order_treat, summary_borer)
aov_corn_borer <- aov(percent_incidence_borer ~ factor_corn, summary_borer)
ttest_corn_borer <- t.test(percent_incidence_borer ~ factor_corn, summary_borer)

# Two way AnOVa
twoway_fert_corn_borer <- aov(percent_incidence_borer ~ order_treat + factor_corn, summary_borer) 
tukey_fert_corn_borer <- TukeyHSD(twoway_fert_corn_borer)

# AnOVa with Interaction
aov_fert_corn_inter_borer <- aov(percent_incidence_borer ~ order_treat*factor_corn, summary_borer)
tukey_fert_corn_inter_borer <- TukeyHSD(aov_fert_corn_inter_borer)

aov_fert_borer %>% summary()
aov_corn_borer %>% summary()
ttest_corn_borer
twoway_fert_corn_borer %>% summary()
print(tukey_fert_corn_borer)
aov_fert_corn_inter_borer %>% summary()
print(tukey_fert_corn_inter_borer)

TukeyHSD(aov_fert_borer)
TukeyHSD(aov_corn_borer)

twoway_fert_corn_borer_letters <- multcompLetters4(twoway_fert_corn_borer, tukey_fert_corn_borer)
aov_fert_corn_borer_letters <- multcompLetters4(aov_fert_corn_inter_borer, tukey_fert_corn_inter_borer)

# kruskall-wallis test by province
attach(summary_borer)
kruskal_province_borer     <- kruskal.test(percent_incidence_borer ~ Province, summary_borer)
kruskal_borer_province_groups <- kruskal(percent_incidence_borer, Province, p.adj = "bonferroni")$groups

# kruskall-wallis test by corn stage
kruskal_stage_borer  <- kruskal.test(percent_incidence_borer ~ `Crop Stage`, summary_borer)
kruskal_stage_groups <- kruskal(percent_incidence_borer, crop_stage, p.adj = "bonferroni")$groups
detach(summary_borer)

# Create transformed objects using bestNormalize
library("bestNormalize")
bestNorm_borer <- predict(bestNormalize(summary_borer$percent_incidence_borer, out_of_sample = FALSE, loo = TRUE))
borer_joined_ev$trans_incidence_borer <- predict(bestNormalize(borer_joined_ev$incidence_borer, out_of_sample = FALSE, loo = TRUE))


borer_ev <-
  borer_joined_ev %>%
  mutate(Province = factor(Province),
         Municipality = factor(Municipality),
         crop_stage = factor(`Crop Stage`),
         treatment = factor(Treatment),
         corn_type = factor(`Corn Type`, labels=c("N", "G"), levels=c("Non - GM Corn", "GM CORN")),
         incidence_borer = as.numeric(incidence_borer))


cor_borer_wind_incidence <- cor(borer_ev$mean_wind, borer_ev$incidence_borer, method = "pearson", use = "pairwise.complete.obs")

cor_borer_temp_incidence <- cor(borer_ev$mean_temp, borer_ev$incidence_borer, method = "pearson", use = "pairwise.complete.obs")

cor_borer_humid_incidence <- cor(borer_ev$mean_humid, borer_ev$incidence_borer, method = "pearson", use = "pairwise.complete.obs")

cor_borer_rain_incidence <- cor(borer_ev$mean_rain, borer_ev$incidence_borer, method = "pearson", use = "pairwise.complete.obs")



# lm
lm_rain_borer  <- lm(incidence_borer ~ mean_rain, data = borer_joined_ev)
lm_wind_borer  <- lm(incidence_borer ~ mean_wind, data = borer_joined_ev)
lm_humid_borer <- lm(incidence_borer ~ mean_humid, data = borer_joined_ev)
lm_temp_borer  <- lm(incidence_borer ~ mean_temp, data = borer_joined_ev)


temp_borer_eqn <- sprintf(
    "italic(y) == %.3g + %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_temp_borer)[1],
    coef(lm_temp_borer)[2],
    round(cor_borer_temp_incidence, 3)
  )

rain_borer_eqn <- sprintf(
    "italic(y) == %.3g + %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_rain_borer)[1],
    coef(lm_rain_borer)[2],
    round(cor_borer_rain_incidence, 3)
  )


wind_borer_eqn <- sprintf(
    "italic(y) == %.3g + %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_wind_borer)[1],
    coef(lm_wind_borer)[2],
    round(cor_borer_wind_incidence, 3)
  )


humid_borer_eqn <- sprintf(
    "italic(y) == %.3g + %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_humid_borer)[1],
    coef(lm_humid_borer)[2],
    round(cor_borer_humid_incidence, 3)
  )


borer_joined_ev %>%
  ggplot(aes(mean_temp, incidence_borer)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.5) +
  labs(x = "Monthly Average temperature (C)", 
       y = "Incidence Borer",
       title = "Temperature and Incidence of Corn Borer") +
  annotate("label", x = 27, y = 8,  
           label = temp_borer_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_temperature", filename = "Corn Borer vs Temperature.png", dpi=plot_dpi)


borer_joined_ev %>%
  ggplot(aes(mean_wind, incidence_borer)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.5) +
  labs(x = "Monthly Average Wind Speed (km/h)", 
       y = "Incidence Borer",
       title = "Wind Speed and Incidence of Corn Borer") +
  annotate("label", x = 7, y = 8,  
           label = wind_borer_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_wind_speed", filename = "Corn Borer vs Wind.png", dpi=plot_dpi)


borer_joined_ev %>%
  ggplot(aes(mean_humid, incidence_borer)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.7) +
  labs(x = "Monthly Average Humidity (%)", 
       y = "Incidence Borer",
       title = "Humidity and Incidence of Corn Borer") +
  annotate("label", x = 60, y = 8,  
           label = humid_borer_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_humidity", filename = "Corn Borer vs Humidity.png", dpi=plot_dpi)


borer_joined_ev %>%
  ggplot(aes(mean_rain, incidence_borer)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.5) +
  labs(x = "Monthly Average Rainfall (mm)", 
       y = "Incidence Borer",
       title = "Rainfall and Incidence of Corn Borer") +
  annotate("label", x = 0.4, y = 10,  
           label = rain_borer_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_rainfall", filename = "Corn Borer vs Rain.png", dpi=plot_dpi)


# by corn type Mann-Whitney U test
utest_corn_borer <- wilcox.test(percent_incidence_borer ~ factor_corn, summary_borer)

DunnTest_corn_type_borer <- DunnTest(percent_incidence_borer ~ factor_corn, summary_borer)
dunn_borer_corn_type_groups <- dunnTest(percent_incidence_borer ~ factor_corn, summary_borer,
                                         method="none")
dunn_borer_corn_type_groups <- dunn_borer_corn_type_groups$res
cld_borer_corn_type <- cldList(comparison = dunn_borer_corn_type_groups$Comparison,
                                p.value = dunn_borer_corn_type_groups$P.adj,
                                threshold = 0.05)[1:2]
cld_borer_corn_type$factor_corn <- cld_borer_corn_type$Group
cld_borer_corn_type <- as.data.frame.list(cld_borer_corn_type)

summary_borer_corntype_bp <-
  summary_borer %>% 
  group_by(factor_corn) %>% 
  summarise(w=mean(percent_incidence_borer), sd = mean_sd(percent_incidence_borer)) %>% 
  arrange(desc(w)) %>% 
  left_join(cld_borer_corn_type, by=c("factor_corn"))
  

summary_borer %>%
  ggplot(aes(factor_corn, percent_incidence_borer)) + 
  geom_boxplot(aes(fill=factor_corn), show.legend=FALSE) +
  geom_text(data = summary_borer_corntype_bp, aes(label = Letter,
                y = sd$ymax), vjust = -1, hjust = -0.5, color="red", size = 5) +
  geom_text(data = summary_borer_corntype_bp, aes(label = round(w, 2), y = sd$ymax-5), vjust = -1, hjust=-1, alpha = 0.75, color = "darkblue") +
  labs(x = "Corn Type (GM or Non-GM)", 
       y = "Percent Incidence Borer",
       title = "Effect of Corn Type to Borer Incidence") +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_corn_type", filename = "Corn Borer Percent Incidence vs Corn Type.png", dpi=plot_dpi)


# by fertilizer type
summary_borer_fert_bp <-
  summary_borer %>% 
  group_by(order_treat) %>% 
  summarise(w=mean(percent_incidence_borer), sd = mean_sd(percent_incidence_borer)) %>% 
  arrange(desc(w))

summary_borer_fert_bp$treatment_cld <- 
  as.data.frame.list(twoway_fert_corn_borer_letters$order_treat)$Letters

summary_borer %>%
  ggplot(aes(order_treat, percent_incidence_borer)) + 
  geom_boxplot(aes(fill=order_treat), show.legend=FALSE) +
  geom_text(data = summary_borer_fert_bp, aes(label = treatment_cld,
                y = sd$ymax), vjust = -1, hjust = -0.5, color="red", size = 5) +
  geom_text(data = summary_borer_fert_bp, aes(label = round(w, 2), y = sd$ymax - 5), vjust = -1, hjust = -0.5, alpha = 0.75, color = "darkblue") +
  labs(x = "Fertilizer Treatment Rate", 
       y = "Percent Incidence Borer",
       title = "Effect of Fertilizer Treatment Rate to Borer Incidence") + 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_fertilizer_rate", filename = "Corn Borer Percent Incidence vs Fertilizer Treatment.png", dpi=plot_dpi)


# by province
# kruskall-wallis test by province
attach(summary_borer)
kruskal_province_borer<- kruskal.test(percent_incidence_borer ~ factor(Province), 
                                        summary_borer)
DunnTest_province_borer <- DunnTest(percent_incidence_borer ~ Province, summary_borer)
dunn_borer_province_groups <- dunnTest(percent_incidence_borer ~ factor(Province),
                                         method="bonferroni")
dunn_borer_province_groups <- dunn_borer_province_groups$res
cld_borer_province <- cldList(comparison = dunn_borer_province_groups$Comparison,
                                p.value = dunn_borer_province_groups$P.adj,
                                threshold = 0.05)[1:2]
cld_borer_province$Province <- cld_borer_province$Group
cld_borer_province <- as.data.frame.list(cld_borer_province)

#  values on boxplots geom_text

detach("package:MASS", unload = TRUE)
summary_borer_province_bp <-
  summary_borer %>% 
  group_by(Province) %>% 
  summarise(w=mean(percent_incidence_borer), sd = mean_sd(percent_incidence_borer)) %>% 
  arrange(desc(w)) %>%
  fuzzy_left_join(cld_borer_province, 
                  by=c("Province"), 
                  match_fun = list(function(x, y) stringdist(x, y) < 2))  %>%
  mutate(Province = Province.x)
  
summary_borer_province_bp <- summary_borer_province_bp %>% select(-c(Province.x, Province.y))


summary_borer <- summary_borer %>% left_join(summary_borer_province_bp, by=c("Province"))


summary_borer %>%
  ggplot(aes(Province, percent_incidence_borer)) + 
  geom_boxplot(aes(fill=Province), show.legend = FALSE) +
  geom_text(data = summary_borer_province_bp, aes(y = sd$ymax, label = Letter), 
            vjust = -1, hjust = -0.5, color="red", size = 4) +
  geom_text(data = summary_borer_province_bp, aes(label = round(w, 2), y = sd$ymax - 5), 
            vjust = -1, hjust = -0.5, alpha = 0.75, color = "darkblue") +
  labs(x = "Provinces", 
       y = "Percent Incidence Corn Borer",
       title = "Provinces to Corn Borer Incidence") + 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1") 
ggsave(path = "../pests_province", filename = "Corn Borer Percent Incidence vs Province.png", dpi=plot_dpi)



# by Crop stage
# kruskall-wallis test by corn stage
library("MASS")
attach(summary_borer)
kruskal_crop_stage_borer<- kruskal.test(percent_incidence_borer ~ factor(crop_stage), 
                                        summary_borer)
DunnTest_crop_stage_borer <- DunnTest(percent_incidence_borer ~ crop_stage, summary_borer)
dunn_borer_crop_stage_groups <- dunnTest(percent_incidence_borer ~ factor(crop_stage),
                                         method="bonferroni")
dunn_borer_crop_stage_groups <- dunn_borer_crop_stage_groups$res
cld_borer_crop_stage <- cldList(comparison = dunn_borer_crop_stage_groups$Comparison,
                                p.value = dunn_borer_crop_stage_groups$P.adj,
                                threshold = 0.05)[1:2]
cld_borer_crop_stage$crop_stage <- cld_borer_crop_stage$Group
cld_borer_crop_stage <- as.data.frame.list(cld_borer_crop_stage)

#  values on boxplots geom_text
summary_borer_crop_stage_bp <-
  summary_borer %>% 
  group_by(crop_stage) %>% 
  summarise(w=mean(percent_incidence_borer), sd = mean_sd(percent_incidence_borer)) %>% 
  arrange(desc(w)) %>%
  fuzzy_left_join(cld_borer_crop_stage, 
                  by=c("crop_stage"), 
                  match_fun = list(function(x, y) stringdist(x, y) < 2))  %>%
  mutate(crop_stage = crop_stage.x) 

detach("package:MASS", unload = TRUE)
summary_borer_crop_stage_bp <- summary_borer_crop_stage_bp %>% select(-c(crop_stage.x, crop_stage.y))
summary_borer <- summary_borer %>% left_join(summary_borer_crop_stage_bp, by=c("crop_stage")) %>% drop_na()


summary_borer %>%
  ggplot(aes(crop_stage, percent_incidence_borer)) + 
  geom_boxplot(aes(fill=`Crop Stage`), show.legend=FALSE) +
  geom_text(data = summary_borer_crop_stage_bp, aes(label = Letter, y = sd$ymax ), 
            vjust = -1, hjust = -0.5, color="red", size = 4) +
  geom_text(data = summary_borer_crop_stage_bp, aes(label = round(w, 2), y = sd$ymax - 5), 
            vjust = -1, hjust = -0.1, alpha = 0.75, color = "darkblue") +
  scale_x_discrete(limits = crop_growth_stages, labels = stage_labels) +
  labs(x = "Corn Growth Stages", 
       y = "Percent Incidence Borer",
       title = "Corn Crop Growth Stages and Corn Borer Incidence",
       caption = "Emergence NOT COUNTED") + 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), ) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_crop_stage", filename = "Corn Borer Percent Incidence vs Crop Growth Stages.png", dpi=plot_dpi)

detach("package:agricolae", unload = TRUE)
detach("package:rcompanion", unload = TRUE)
detach("package:nortest", unload = TRUE)
detach("package:DescTools", unload = TRUE)
detach("package:stats", unload = TRUE)
```

```Rating of 1 is classified as No damage to very slight```
```Corn Borer, Semi-looper, earworm```
```Semilooper```
```{r}
# Semi-looper
semilooper_df_ev <- 
  insect_raw %>%
  select(FarmID, `Collection Date`, Province, Municipality, Barangay, `Crop Stage`, Treatment, `Corn Type`, Variety, contains("Semi-looper - Damage Rating ")) %>%
  filter(Municipality != "Santa Rita" & Municipality != "Hilongos" & Municipality != "Tomas Oppus")

semilooper_df_ev$collect_date <- 
  as.Date(semilooper_df_ev$`Collection Date`, "%B %d, %Y")

semilooper_dmg_ev <-
  semilooper_df_ev %>% 
  mutate(Year = year(collect_date), Month = month(collect_date))

semilooper_joined_ev <-
  semilooper_dmg_ev %>% 
  left_join(monthly_averages, by=c('Year', 'Month')) %>%
  rowwise() %>%
  mutate(sum_no = sum(c_across(starts_with("Semi-looper - Damage Rating ")) == "1"),
         sum_light = sum(c_across(starts_with("Semi-looper - Damage Rating ")) == "3"),
         sum_moderate = sum(c_across(starts_with("Semi-looper - Damage Rating ")) == "5"),
         sum_severe = sum(c_across(starts_with("Semi-looper - Damage Rating ")) == "7"),
         sum_high = sum(c_across(starts_with("Semi-looper - Damage Rating ")) == "9"),
         average_damage_semilooper = (((3 * sum_light) + (5 * sum_moderate) + (7 * sum_severe) + (9 * sum_high)) / (number_sampled_plants)),
         damage_rating_semilooper = (((3 * sum_light) + (5 * sum_moderate) + (7 * sum_severe) + (9 * sum_high)) / (number_sampled_plants * 9)) * percent_100,
         incidence_semilooper = ((sum(c_across(sum_light:sum_high))) * percent_100) / number_sampled_plants,
         )


#View(semilooper_joined_ev)

summary_semilooper <-
  semilooper_joined_ev %>%
  group_by(Year, Month, Province, Municipality, `Corn Type`,             
           Barangay, Treatment, `Crop Stage`) %>%
  select(-`Crop Stage`) %>%
  remove_missing(na.rm=TRUE) %>%
  summarise(total_count_samples_semilooper = n() * number_sampled_plants,
            sum_avg_dmg_semilooper = sum(average_damage_semilooper),
            sum_dmg_rate_semilooper = sum(damage_rating_semilooper),
            sum_incidence_semilooper = sum(incidence_semilooper),
            percent_incidence_semilooper = (sum_incidence_semilooper / total_count_samples_semilooper) * percent_100)

#View(summary_semilooper)


summary_semilooper$crop_stage <- 
  factor(summary_semilooper$`Crop Stage`, 
         levels = c("Early Whorl", "Late Whorl", "Maturity", "Mid Whorl", "Seedling (3 - 4 Leaves)",
                    "Silking", "Single Leaf", "Tasseling", "Emergence"),
         labels = c("early_whorl", "late_whorl", "maturity", "mid_whorl", "seedling", 
                    "silking", "single_leaf", "tasseling", "emergence"))

summary_semilooper$order_treat <- ordered(summary_semilooper$Treatment,
                                     levels = c("BRFR", "RFR", "ARFR"),
                                     labels = c("B", "R", "A"))

summary_semilooper$factor_corn <- factor(summary_semilooper$`Corn Type`, 
                                    labels=c("N", "G"), 
                                    levels = c("Non - GM Corn", "GM CORN"))

ggqqplot(summary_semilooper$percent_incidence_semilooper)

library("nortest")
library("rcompanion")
library("moments")
library("stats")
library("MASS")
library("agricolae")
library("DescTools")

# Kolmogorov Smirnov test for normality samples > 50
ks_test_semilooper <- ks.test(summary_semilooper$percent_incidence_semilooper, 'pnorm')

# Anderson-Darling Test is a goodness-of-fit test that determines how well your data fits a given distribution. 
# This test is most typically used to see if your data follow a normal distribution or not.
# It is a modification of the Kolmogorov-Smirnov (K-S) test and 
# gives more weight to the tails than does the K-S test.
ad_test_semilooper <- ad.test(summary_semilooper$percent_incidence_semilooper)

skew_semilooper <- skewness(summary_semilooper$percent_incidence_semilooper)
kurt_semilooper <- kurtosis(summary_semilooper$percent_incidence_semilooper)

# Jarque-Bera Normality Test performs a goodness-of-fit test that 
# determines whether or not sample data have skewness and 
# kurtosis that matches a normal distribution.
jarq_semilooper <- jarque.test(summary_semilooper$percent_incidence_semilooper)

# Kruskall Wallis applied to one-way, non-normal data with more than two groups
kruskal_fertilizer_semilooper <- kruskal.test(percent_incidence_semilooper ~ order_treat, summary_semilooper)

# Mann-Whitney U test for differences between two independent treatments or conditions.   
# The continuous response variable of interest is not normally distributed.
utest_corn_semilooper <- wilcox.test(percent_incidence_semilooper ~ factor_corn, summary_semilooper)

# The Friedman test determines if there are differences among groups for two-way data structured in a specific way, namely in an unreplicated complete block design.  
# In this design, one variable serves as the treatment or group variable, 
# and another variable serves as the blocking variable.
# fried_fert_corn_semilooper <- summary_semilooper %>% friedman_test(percent_incidence_semilooper ~ order_treat |factor_corn)


# Null hypothesis is variances across all samples are equal. 
# Leveneâs test is an alternative to Bartlettâs test when the data is not normally distributed.
levenes_fertilizer_semilooper <- leveneTest(percent_incidence_semilooper ~ Treatment, summary_semilooper)
levenes_corntype_semilooper <- leveneTest(percent_incidence_semilooper ~ `Corn Type`, summary_semilooper)
levenes_municipality_semilooper <- leveneTest(percent_incidence_semilooper ~ Municipality, summary_semilooper)
levenes_province_semilooper <- leveneTest(percent_incidence_semilooper ~ Province, summary_semilooper)
levenes_fert_corn_semilooper <- leveneTest(percent_incidence_semilooper ~ interaction(Treatment, `Corn Type`), summary_semilooper)
levenes_stage_semilooper <- leveneTest(percent_incidence_semilooper ~ `Crop Stage`, summary_semilooper)

# AnOVa
aov_fert_semilooper <- aov(percent_incidence_semilooper ~ order_treat, summary_semilooper)
aov_corn_semilooper <- aov(percent_incidence_semilooper ~ factor_corn, summary_semilooper)

# Two way AnOVa
twoway_fert_corn_semilooper <- aov(percent_incidence_semilooper ~ order_treat + factor_corn, summary_semilooper) 
tukey_fert_corn_semilooper <- TukeyHSD(twoway_fert_corn_semilooper)

# AnOVa with Interaction
aov_fert_corn_inter_semilooper <- aov(percent_incidence_semilooper ~ order_treat*factor_corn, summary_semilooper)
tukey_fert_corn_inter_semilooper <- TukeyHSD(aov_fert_corn_inter_semilooper)

twoway_fert_corn_semilooper %>% summary()
print(tukey_fert_corn_semilooper)
aov_fert_corn_inter_semilooper %>% summary()
print(tukey_fert_corn_inter_semilooper)

twoway_fert_corn_semilooper_letters <- multcompLetters4(twoway_fert_corn_semilooper, tukey_fert_corn_semilooper)
aov_fert_corn_semilooper_letters <- multcompLetters4(aov_fert_corn_inter_semilooper, tukey_fert_corn_inter_semilooper)

aov_province_semilooper   <- aov(percent_incidence_semilooper ~ Province, summary_semilooper)
tukey_province_semilooper <- TukeyHSD(aov_province_semilooper)

aov_stage_semilooper   <- aov(percent_incidence_semilooper ~ crop_stage, summary_semilooper)
tukey_stage_semilooper <- TukeyHSD(aov_stage_semilooper)

aov_fert_semilooper %>% summary() # NOT significant
aov_corn_semilooper %>% summary() # NOT significant
aov_province_semilooper %>% summary() # significant
aov_stage_semilooper %>% summary() # significant

TukeyHSD(aov_fert_semilooper)
TukeyHSD(aov_corn_semilooper)
TukeyHSD(aov_province_semilooper)
TukeyHSD(aov_stage_semilooper)

# Create transformed objects using bestNormalize
library("bestNormalize")
bestNorm_semilooper <- predict(bestNormalize(summary_semilooper$percent_incidence_semilooper, out_of_sample = FALSE, loo = TRUE))
semilooper_joined_ev$trans_incidence_semilooper <- predict(bestNormalize(semilooper_joined_ev$incidence_semilooper, out_of_sample = FALSE, loo = TRUE))


semilooper_ev <-
  semilooper_joined_ev %>%
  mutate(Province = factor(Province),
         Municipality = factor(Municipality),
         crop_stage = factor(`Crop Stage`),
         treatment = factor(Treatment),
         corn_type = factor(`Corn Type`, labels=c("N", "G"), levels=c("Non - GM Corn", "GM CORN")),
         incidence_semilooper = as.numeric(incidence_semilooper))


cor_semilooper_wind_incidence <- cor(semilooper_ev$mean_wind, semilooper_ev$incidence_semilooper, method = "pearson", use = "pairwise.complete.obs")

cor_semilooper_temp_incidence <- cor(semilooper_ev$mean_temp, semilooper_ev$incidence_semilooper, method = "pearson", use = "pairwise.complete.obs")

cor_semilooper_humid_incidence <- cor(semilooper_ev$mean_humid, semilooper_ev$incidence_semilooper, method = "pearson", use = "pairwise.complete.obs")

cor_semilooper_rain_incidence <- cor(semilooper_ev$mean_rain, semilooper_ev$incidence_semilooper, method = "pearson", use = "pairwise.complete.obs")



# lm
lm_rain_semilooper  <- lm(incidence_semilooper ~ mean_rain, data = semilooper_joined_ev)
lm_wind_semilooper  <- lm(incidence_semilooper ~ mean_wind, data = semilooper_joined_ev)
lm_humid_semilooper <- lm(incidence_semilooper ~ mean_humid, data = semilooper_joined_ev)
lm_temp_semilooper  <- lm(incidence_semilooper ~ mean_temp, data = semilooper_joined_ev)


temp_semilooper_eqn <- sprintf(
    "italic(y) == %.3g + %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_temp_semilooper)[1],
    coef(lm_temp_semilooper)[2],
    round(cor_semilooper_temp_incidence, 3)
  )

rain_semilooper_eqn <- sprintf(
    "italic(y) == %.3g + %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_rain_semilooper)[1],
    coef(lm_rain_semilooper)[2],
    round(cor_semilooper_rain_incidence, 3)
  )


wind_semilooper_eqn <- sprintf(
    "italic(y) == %.3g + %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_wind_semilooper)[1],
    coef(lm_wind_semilooper)[2],
    round(cor_semilooper_wind_incidence, 3)
  )


humid_semilooper_eqn <- sprintf(
    "italic(y) == %.3g + %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_humid_semilooper)[1],
    coef(lm_humid_semilooper)[2],
    round(cor_semilooper_humid_incidence, 3)
  )


semilooper_joined_ev %>%
  ggplot(aes(mean_temp, incidence_semilooper)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.5) +
  labs(x = "Monthly Average temperature (C)", 
       y = "Incidence Semi-looper",
       title = "Temperature and Incidence of Semi-looper") +
  annotate("label", x = 27, y = 8,  
           label = temp_semilooper_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_temperature", filename = "Semi-looper vs Temperature.png", dpi=plot_dpi)


semilooper_joined_ev %>%
  ggplot(aes(mean_wind, incidence_semilooper)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.5) +
  labs(x = "Monthly Average Wind Speed (km/h)", 
       y = "Incidence Semi-looper",
       title = "Wind Speed and Incidence of Semi-looper") +
  annotate("label", x = 7, y = 8,  
           label = wind_semilooper_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_wind_speed", filename = "Semi-looper vs Wind.png", dpi=plot_dpi)


semilooper_joined_ev %>%
  ggplot(aes(mean_humid, incidence_semilooper)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.7) +
  labs(x = "Monthly Average Humidity (%)", 
       y = "Incidence Semi-looper",
       title = "Humidity and Incidence of Semi-looper") +
  annotate("label", x = 60, y = 8,  
           label = humid_semilooper_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_humidity", filename = "Semi-looper vs Humidity.png", dpi=plot_dpi)


semilooper_joined_ev %>%
  ggplot(aes(mean_rain, incidence_semilooper)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.5) +
  labs(x = "Monthly Average Rainfall (mm)", 
       y = "Incidence Semi-looper",
       title = "Rainfall and Incidence of Semi-looper") +
  annotate("label", x = 0.4, y = 10,  
           label = rain_semilooper_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_rainfall", filename = "Semi-looper vs Rain.png", dpi=plot_dpi)


# by corn type T-test
ttest_corn_semilooper <- t.test(percent_incidence_semilooper ~ factor_corn, summary_semilooper)

DunnTest_corn_type_semilooper <- DunnTest(percent_incidence_semilooper ~ factor_corn, summary_semilooper)
dunn_semilooper_corn_type_groups <- dunnTest(percent_incidence_semilooper ~ factor_corn, summary_semilooper,
                                         method="none")
dunn_semilooper_corn_type_groups <- dunn_semilooper_corn_type_groups$res
cld_semilooper_corn_type <- cldList(comparison = dunn_semilooper_corn_type_groups$Comparison,
                                p.value = dunn_semilooper_corn_type_groups$P.adj,
                                threshold = 0.05)[1:2]
cld_semilooper_corn_type$factor_corn <- cld_borer_corn_type$Group
cld_semilooper_corn_type <- as.data.frame.list(cld_borer_corn_type)

summary_semilooper_corntype_bp <-
  summary_semilooper %>% 
  group_by(factor_corn) %>% 
  summarise(w=mean(percent_incidence_semilooper), sd = mean_sd(percent_incidence_semilooper)) %>% 
  arrange(desc(w)) %>%
  left_join(cld_semilooper_corn_type, by=c("factor_corn"))

summary_semilooper %>%
  ggplot(aes(factor_corn, percent_incidence_semilooper)) + 
  geom_boxplot(aes(fill=factor_corn), show.legend=FALSE) +
  geom_text(data = summary_semilooper_corntype_bp, aes(label = Letter,
                y = sd$ymax), vjust = -1, hjust = -0.5, color="red", size = 5) +
  geom_text(data = summary_semilooper_corntype_bp, aes(label = round(w, 2), y = sd$ymax-5), vjust = -1, hjust=-1, alpha = 0.75, color = "darkblue") +
  labs(x = "Corn Type (GM or Non-GM)", 
       y = "Percent Incidence Semi-looper",
       title = "Effect of Corn Type to Semi-looper Incidence") +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_corn_type", filename = "Semi-looper Percent Incidence vs Corn Type.png", dpi=plot_dpi)

# by fertilizer treatment
summary_semilooper_fert_bp <-
  summary_semilooper %>% 
  group_by(order_treat) %>% 
  summarise(w=mean(percent_incidence_semilooper), sd = mean_sd(percent_incidence_semilooper)) %>% 
  arrange(desc(w))

summary_semilooper_fert_bp$treatment_cld <- 
  as.data.frame.list(twoway_fert_corn_semilooper_letters$order_treat)$Letters

summary_semilooper %>%
  ggplot(aes(order_treat, percent_incidence_semilooper)) + 
  geom_boxplot(aes(fill=order_treat), show.legend=FALSE) +
  geom_text(data = summary_semilooper_fert_bp, aes(label = treatment_cld,
                y = sd$ymax), vjust = -1, hjust = -0.5, color="red", size = 5) +
  geom_text(data = summary_semilooper_fert_bp, aes(label = round(w, 2), y = sd$ymax - 5), vjust = -1, hjust = -0.5, alpha = 0.75, color = "darkblue") +
  labs(x = "Fertilizer Treatment Rate", 
       y = "Percent Incidence Semi-looper",
       title = "Effect of Fertilizer Treatment Rate to Semi-looper Incidence") + 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_fertilizer_rate", filename = "Semi-looper Percent Incidence vs Fertilizer Treatment.png", dpi=plot_dpi)

# by province
# Letters by province
tukey_province_semilooper_letters <- 
  multcompLetters4(aov_province_semilooper, tukey_province_semilooper)

summary_semilooper_province_bp <-
  summary_semilooper %>% 
  group_by(Province) %>% 
  summarise(w=mean(percent_incidence_semilooper), sd = mean_sd(percent_incidence_semilooper)) %>% 
  arrange(desc(w))

summary_semilooper_province_bp$province_cld <- 
  as.data.frame.list(tukey_province_semilooper_letters$Province)$Letters


summary_semilooper %>%
  ggplot(aes(Province, percent_incidence_semilooper)) + 
  geom_boxplot(aes(fill=Province), show.legend = FALSE) +
  geom_text(data = summary_semilooper_province_bp, aes(y = sd$ymax, label = province_cld), 
            vjust = -1, hjust = -0.5, color="red", size = 4) +
  geom_text(data = summary_semilooper_province_bp, aes(label = round(w, 2), y = sd$ymax - 5), 
            vjust = -1, hjust = -0.5, alpha = 0.75, color = "darkblue") +
  labs(x = "Provinces", 
       y = "Percent Incidence Semi-looper",
       title = "Provinces to Semi-looper Incidence") + 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1") 
ggsave(path = "../pests_province", filename = "Semi-looper Percent Incidence vs Province.png", dpi=plot_dpi)



# by Crop stage
tukey_crop_stage_semilooper_letters <- 
  multcompLetters4(aov_stage_semilooper, tukey_stage_semilooper)

summary_semilooper_crop_stage_bp <-
  summary_semilooper %>% 
  group_by(crop_stage) %>% 
  summarise(w=mean(percent_incidence_semilooper), sd = mean_sd(percent_incidence_semilooper)) %>% 
  arrange(desc(w))

summary_semilooper_crop_stage_bp$crop_stage_cld <- 
  as.data.frame.list(tukey_crop_stage_semilooper_letters$crop_stage)$Letters

summary_semilooper %>%
  ggplot(aes(crop_stage, percent_incidence_semilooper)) + 
  geom_boxplot(aes(fill=`Crop Stage`), show.legend=FALSE) +
  geom_text(data = summary_semilooper_crop_stage_bp, aes(label = crop_stage_cld, y = sd$ymax ), 
            vjust = -1, hjust = -0.5, color="red", size = 4) +
  geom_text(data = summary_semilooper_crop_stage_bp, aes(label = round(w, 2), y = sd$ymax - 5), 
            vjust = -1, hjust = -0.1, alpha = 0.75, color = "darkblue") +
  scale_x_discrete(limits = crop_growth_stages, labels = stage_labels) +
  labs(x = "Corn Growth Stages", 
       y = "Percent Incidence Semi-looper",
       title = "Corn Crop Growth Stages and Semi-looper Incidence",
       caption = "Emergence NOT COUNTED") + 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), ) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_crop_stage", filename = "Semi-looper Percent Incidence vs Crop Growth Stages.png", dpi=plot_dpi)

detach("package:agricolae", unload = TRUE)
detach("package:rcompanion", unload = TRUE)
detach("package:nortest", unload = TRUE)
detach("package:MASS", unload = TRUE)
detach("package:DescTools", unload = TRUE)
detach("package:stats", unload = TRUE)
```


```Rating of 1 is classified as No damage to very slight```
```Corn Borer, Semi-looper, earworm```
```Earworm```
```{r}
# Corn earworm
earworm_df_ev <- 
  insect_raw %>%
  select(FarmID, `Collection Date`, Province, Municipality, Barangay, `Crop Stage`, Treatment, `Corn Type`, Variety, contains("Corn Earworm - Damage Rating ")) %>%
  filter(Municipality != "Santa Rita" & Municipality != "Hilongos" & Municipality != "Tomas Oppus")

earworm_df_ev$collect_date <- 
  as.Date(earworm_df_ev$`Collection Date`, "%B %d, %Y")

earworm_dmg_ev <-
  earworm_df_ev %>% 
  mutate(Year = year(collect_date), Month = month(collect_date))

earworm_joined_ev <-
  earworm_dmg_ev %>% 
  left_join(monthly_averages, by=c('Year', 'Month')) %>%
  rowwise() %>%
  mutate(sum_no = sum(c_across(starts_with("Corn Earworm - Damage Rating ")) == "1"),
         sum_light = sum(c_across(starts_with("Corn Earworm - Damage Rating ")) == "3"),
         sum_moderate = sum(c_across(starts_with("Corn Earworm - Damage Rating ")) == "5"),
         sum_severe = sum(c_across(starts_with("Corn Earworm - Damage Rating ")) == "7"),
         sum_high = sum(c_across(starts_with("Corn Earworm - Damage Rating ")) == "9"),
         average_damage_earworm = (((3 * sum_light) + (5 * sum_moderate) + (7 * sum_severe) + (9 * sum_high)) / (number_sampled_plants)),
         damage_rating_earworm = (((3 * sum_light) + (5 * sum_moderate) + (7 * sum_severe) + (9 * sum_high)) / (number_sampled_plants * 9)) * percent_100,
         incidence_earworm = ((sum(c_across(sum_light:sum_high))) * percent_100) / number_sampled_plants,
         )


#View(earworm_joined_ev)

summary_earworm <-
  earworm_joined_ev %>%
  group_by(Year, Month, Province, Municipality, `Corn Type`,             
           Barangay, Treatment, `Crop Stage`) %>%
  select(-`Crop Stage`) %>%
  remove_missing(na.rm=TRUE) %>%
  summarise(total_count_samples_earworm = n() * number_sampled_plants,
            sum_avg_dmg_earworm = sum(average_damage_earworm),
            sum_dmg_rate_earworm = sum(damage_rating_earworm),
            sum_incidence_earworm = sum(incidence_earworm),
            percent_incidence_earworm = (sum_incidence_earworm / total_count_samples_earworm) * percent_100)

#View(summary_earworm)


summary_earworm$crop_stage <- 
  factor(summary_earworm$`Crop Stage`, 
         levels = c("Early Whorl", "Late Whorl", "Maturity", "Mid Whorl", "Seedling (3 - 4 Leaves)",
                    "Silking", "Single Leaf", "Tasseling", "Emergence"),
         labels = c("early_whorl", "late_whorl", "maturity", "mid_whorl", "seedling", 
                    "silking", "single_leaf", "tasseling", "emergence"))

summary_earworm$order_treat <- ordered(summary_earworm$Treatment,
                                     levels = c("BRFR", "RFR", "ARFR"),
                                     labels = c("B", "R", "A"))

summary_earworm$factor_corn <- factor(summary_earworm$`Corn Type`, 
                                    labels=c("N", "G"), 
                                    levels = c("Non - GM Corn", "GM CORN"))

ggqqplot(summary_earworm$percent_incidence_earworm)

library("nortest")
library("rcompanion")
library("moments")
library("stats")
library("MASS")
library("agricolae")
library("DescTools")

# Kolmogorov Smirnov test for normality samples > 50
ks_test_earworm <- ks.test(summary_earworm$percent_incidence_earworm, 'pnorm')

# Anderson-Darling Test is a goodness-of-fit test that determines how well your data fits a given distribution. 
# This test is most typically used to see if your data follow a normal distribution or not.
# It is a modification of the Kolmogorov-Smirnov (K-S) test and 
# gives more weight to the tails than does the K-S test.
ad_test_earworm <- ad.test(summary_earworm$percent_incidence_earworm)

skew_earworm <- skewness(summary_earworm$percent_incidence_earworm)
kurt_earworm <- kurtosis(summary_earworm$percent_incidence_earworm)

# Jarque-Bera Normality Test performs a goodness-of-fit test that 
# determines whether or not sample data have skewness and 
# kurtosis that matches a normal distribution.
jarq_earworm <- jarque.test(summary_earworm$percent_incidence_earworm)

# Kruskall Wallis applied to one-way, non-normal data with more than two groups
kruskal_fertilizer_earworm <- kruskal.test(percent_incidence_earworm ~ order_treat, summary_earworm)

# Mann-Whitney U test for differences between two independent treatments or conditions.   
# The continuous response variable of interest is not normally distributed.
utest_corn_earworm <- wilcox.test(percent_incidence_earworm ~ factor_corn, summary_earworm)

# The Friedman test determines if there are differences among groups for two-way data structured in a specific way, namely in an unreplicated complete block design.  
# In this design, one variable serves as the treatment or group variable, 
# and another variable serves as the blocking variable.
# fried_fert_corn_earworm <- summary_earworm %>% friedman_test(percent_incidence_earworm ~ order_treat |factor_corn)


# Null hypothesis is variances across all samples are equal. 
# Leveneâs test is an alternative to Bartlettâs test when the data is not normally distributed.
levenes_fertilizer_earworm <- leveneTest(percent_incidence_earworm ~ Treatment, summary_earworm)
levenes_corntype_earworm <- leveneTest(percent_incidence_earworm ~ `Corn Type`, summary_earworm)
levenes_municipality_earworm <- leveneTest(percent_incidence_earworm ~ Municipality, summary_earworm)
levenes_province_earworm <- leveneTest(percent_incidence_earworm ~ Province, summary_earworm)
levenes_fert_corn_earworm <- leveneTest(percent_incidence_earworm ~ interaction(Treatment, `Corn Type`), summary_earworm)
levenes_stage_earworm <- leveneTest(percent_incidence_earworm ~ `Crop Stage`, summary_earworm)

# AnOVa
aov_fert_earworm <- aov(percent_incidence_earworm ~ order_treat, summary_earworm)
aov_province_earworm <- aov(percent_incidence_earworm ~ Province, summary_earworm)
ttest_corn_earworm <- t.test(percent_incidence_earworm ~ factor_corn, summary_earworm)

# Two way AnOVa
twoway_fert_corn_earworm <- aov(percent_incidence_earworm ~ order_treat + factor_corn, summary_earworm) 
tukey_fert_corn_earworm <- TukeyHSD(twoway_fert_corn_earworm)

# AnOVa with Interaction
aov_fert_corn_inter_earworm <- aov(percent_incidence_earworm ~ order_treat*factor_corn, summary_earworm)
tukey_fert_corn_inter_earworm <- TukeyHSD(aov_fert_corn_inter_earworm)


summmary_stats_earworm_province <- 
  summary_earworm %>% 
  group_by(Province) %>% 
  get_summary_stats(type="mean")
aov_province_earworm %>% summary()

summmary_stats_earworm_corntype <- 
  summary_earworm %>% 
  group_by(`Corn Type`) %>% 
  get_summary_stats(type="mean")
ttest_corn_earworm


summmary_stats_earworm_fert <- 
  summary_earworm %>% 
  group_by(order_treat) %>% 
  get_summary_stats(type="mean")
aov_fert_earworm %>% summary()

aov_fert_earworm %>% summary()
aov_province_earworm %>% summary()
ttest_corn_earworm


twoway_fert_corn_earworm %>% summary()
print(tukey_fert_corn_earworm)
aov_fert_corn_inter_earworm %>% summary()
print(tukey_fert_corn_inter_earworm)

TukeyHSD(aov_fert_earworm)
TukeyHSD(aov_corn_earworm)

twoway_fert_corn_earworm_letters <- multcompLetters4(twoway_fert_corn_earworm, tukey_fert_corn_earworm)
aov_fert_corn_earworm_letters <- multcompLetters4(aov_fert_corn_inter_earworm, tukey_fert_corn_inter_earworm)


# Create transformed objects using bestNormalize
library("bestNormalize")
bestNorm_earworm <- predict(bestNormalize(summary_earworm$percent_incidence_earworm, out_of_sample = FALSE, loo = TRUE))
earworm_joined_ev$trans_incidence_earworm <- predict(bestNormalize(earworm_joined_ev$incidence_earworm, out_of_sample = FALSE, loo = TRUE))

earworm_ev <-
  earworm_joined_ev %>%
  mutate(Province = factor(Province),
         Municipality = factor(Municipality),
         crop_stage = factor(`Crop Stage`),
         treatment = factor(Treatment),
         corn_type = factor(`Corn Type`, labels=c("N", "G"), levels=c("Non - GM Corn", "GM CORN")),
         incidence_earworm = as.numeric(incidence_earworm))


cor_earworm_wind_incidence <- cor(earworm_ev$mean_wind, earworm_ev$incidence_earworm, method = "pearson", use = "pairwise.complete.obs")

cor_earworm_temp_incidence <- cor(earworm_ev$mean_temp, earworm_ev$incidence_earworm, method = "pearson", use = "pairwise.complete.obs")

cor_earworm_humid_incidence <- cor(earworm_ev$mean_humid, earworm_ev$incidence_earworm, method = "pearson", use = "pairwise.complete.obs")

cor_earworm_rain_incidence <- cor(earworm_ev$mean_rain, earworm_ev$incidence_earworm, method = "pearson", use = "pairwise.complete.obs")



# lm
lm_rain_earworm  <- lm(incidence_earworm ~ mean_rain, data = earworm_joined_ev)
lm_wind_earworm  <- lm(incidence_earworm ~ mean_wind, data = earworm_joined_ev)
lm_humid_earworm <- lm(incidence_earworm ~ mean_humid, data = earworm_joined_ev)
lm_temp_earworm  <- lm(incidence_earworm ~ mean_temp, data = earworm_joined_ev)


temp_earworm_eqn <- sprintf(
    "italic(y) == %.3g %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_temp_earworm)[1],
    coef(lm_temp_earworm)[2],
    round(cor_earworm_temp_incidence, 3)
  )

rain_earworm_eqn <- sprintf(
    "italic(y) == %.3g %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_rain_earworm)[1],
    coef(lm_rain_earworm)[2],
    round(cor_earworm_rain_incidence, 3)
  )


wind_earworm_eqn <- sprintf(
    "italic(y) == %.3g %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_wind_earworm)[1],
    coef(lm_wind_earworm)[2],
    round(cor_earworm_wind_incidence, 3)
  )


humid_earworm_eqn <- sprintf(
    "italic(y) == %.3g %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_humid_earworm)[1],
    coef(lm_humid_earworm)[2],
    round(cor_earworm_humid_incidence, 3)
  )


earworm_joined_ev %>%
  ggplot(aes(mean_temp, incidence_earworm)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.5) +
  labs(x = "Monthly Average temperature (C)", 
       y = "Incidence Earworm",
       title = "Temperature and Incidence of Corn Earworm") +
  annotate("label", x = 27, y = 8,  
           label = temp_earworm_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_temperature", filename = "Corn Earworm vs Temperature.png", dpi=plot_dpi)


earworm_joined_ev %>%
  ggplot(aes(mean_wind, incidence_earworm)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.5) +
  labs(x = "Monthly Average Wind Speed (km/h)", 
       y = "Incidence Earworm",
       title = "Wind Speed and Incidence of Corn Earworm") +
  annotate("label", x = 7, y = 8,  
           label = wind_earworm_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_wind_speed", filename = "Corn Earworm vs Wind.png", dpi=plot_dpi)


earworm_joined_ev %>%
  ggplot(aes(mean_humid, incidence_earworm)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.7) +
  labs(x = "Monthly Average Humidity (%)", 
       y = "Incidence Earworm",
       title = "Humidity and Incidence of Corn Earworm") +
  annotate("label", x = 60, y = 8,  
           label = humid_earworm_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_humidity", filename = "Corn Earworm vs Humidity.png", dpi=plot_dpi)


earworm_joined_ev %>%
  ggplot(aes(mean_rain, incidence_earworm)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.5) +
  labs(x = "Monthly Average Rainfall (mm)", 
       y = "Incidence Earworm",
       title = "Rainfall and Incidence of Corn Earworm") +
  annotate("label", x = 0.4, y = 10,  
           label = rain_earworm_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_rainfall", filename = "Corn Earworm vs Rain.png", dpi=plot_dpi)


# by corn type T-test
ttest_corn_earworm <- t.test(percent_incidence_earworm ~ factor_corn, summary_earworm)

DunnTest_corn_type_earworm <- DunnTest(percent_incidence_earworm ~ factor_corn, summary_earworm)
dunn_earworm_corn_type_groups <- dunnTest(percent_incidence_earworm ~ factor_corn, summary_earworm,
                                         method="none")
dunn_earworm_corn_type_groups <- dunn_earworm_corn_type_groups$res
cld_earworm_corn_type <- cldList(comparison = dunn_earworm_corn_type_groups$Comparison,
                                p.value = dunn_earworm_corn_type_groups$P.adj,
                                threshold = 0.05)[1:2]
cld_earworm_corn_type$factor_corn <- cld_borer_corn_type$Group
cld_earworm_corn_type <- as.data.frame.list(cld_borer_corn_type)

summary_earworm_corntype_bp <-
  summary_earworm %>% 
  group_by(factor_corn) %>% 
  summarise(w=mean(percent_incidence_earworm), sd = mean_sd(percent_incidence_earworm)) %>% 
  arrange(desc(w)) %>%
  left_join(cld_earworm_corn_type, by=c("factor_corn"))


summary_earworm %>%
  ggplot(aes(factor_corn, percent_incidence_earworm)) + 
  geom_boxplot(aes(fill=factor_corn), show.legend=FALSE) +
  geom_text(data = summary_earworm_corntype_bp, aes(label = Letter,
                y = sd$ymax), vjust = -1, hjust = -0.5, color="red", size = 5) +
  geom_text(data = summary_earworm_corntype_bp, aes(label = round(w, 2), y = sd$ymax-5), vjust = -1, hjust=-1, alpha = 0.75, color = "darkblue") +
  labs(x = "Corn Type (GM or Non-GM)", 
       y = "Percent Incidence Earworm",
       title = "Effect of Corn Type to Earworm Incidence") +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_corn_type", filename = "Corn Earworm Percent Incidence vs Corn Type.png", dpi=plot_dpi)



# by fertilizer treatment rate
summary_earworm_fert_bp <-
  summary_earworm %>% 
  group_by(order_treat) %>% 
  summarise(w=mean(percent_incidence_earworm), sd = mean_sd(percent_incidence_earworm)) %>% 
  arrange(desc(w))

summary_earworm_fert_bp$treatment_cld <- 
  as.data.frame.list(twoway_fert_corn_earworm_letters$order_treat)$Letters

summary_earworm %>%
  ggplot(aes(order_treat, percent_incidence_earworm)) + 
  geom_boxplot(aes(fill=order_treat), show.legend=FALSE) +
  geom_text(data = summary_earworm_fert_bp, aes(label = treatment_cld,
                y = sd$ymax), vjust = -1, hjust = -0.5, color="red", size = 5) +
  geom_text(data = summary_earworm_fert_bp, aes(label = round(w, 2), y = sd$ymax - 5), vjust = -1, hjust = -0.5, alpha = 0.75, color = "darkblue") +
  labs(x = "Fertilizer Treatment Rate", 
       y = "Percent Incidence Earworm",
       title = "Effect of Fertilizer Treatment Rate to Earworm Incidence") + 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_fertilizer_rate", filename = "Corn Earworm Percent Incidence vs Fertilizer Treatment.png", dpi=plot_dpi)

# by province
# kruskall-wallis test by province
attach(summary_earworm)
kruskal_province_earworm<- kruskal.test(percent_incidence_earworm ~ factor(Province), 
                                        summary_earworm)
DunnTest_province_earworm <- DunnTest(percent_incidence_earworm ~ Province, summary_earworm)
dunn_earworm_province_groups <- dunnTest(percent_incidence_earworm ~ factor(Province),
                                         method="bonferroni")
dunn_earworm_province_groups <- dunn_earworm_province_groups$res
cld_earworm_province <- cldList(comparison = dunn_earworm_province_groups$Comparison,
                                p.value = dunn_earworm_province_groups$P.adj,
                                threshold = 0.05)[1:2]
cld_earworm_province$Province <- cld_earworm_province$Group
cld_earworm_province <- as.data.frame.list(cld_earworm_province)

#  values on boxplots geom_text

detach("package:MASS", unload = TRUE)
summary_earworm_province_bp <-
  summary_earworm %>% 
  group_by(Province) %>% 
  summarise(w=mean(percent_incidence_earworm), sd = mean_sd(percent_incidence_earworm)) %>% 
  arrange(desc(w)) %>%
  fuzzy_left_join(cld_earworm_province, 
                  by=c("Province"), 
                  match_fun = list(function(x, y) stringdist(x, y) < 2))  %>%
  mutate(Province = Province.x)
  
summary_earworm_province_bp <- summary_earworm_province_bp %>% select(-c(Province.x, Province.y))


summary_earworm <- summary_earworm %>% left_join(summary_earworm_province_bp, by=c("Province"))


summary_earworm %>%
  ggplot(aes(Province, percent_incidence_earworm)) + 
  geom_boxplot(aes(fill=Province), show.legend = FALSE) +
  geom_text(data = summary_earworm_province_bp, aes(y = sd$ymax, label = Letter), 
            vjust = -1, hjust = -0.5, color="red", size = 4) +
  geom_text(data = summary_earworm_province_bp, aes(label = round(w, 2), y = sd$ymax - 5), 
            vjust = -1, hjust = -0.5, alpha = 0.75, color = "darkblue") +
  labs(x = "Provinces", 
       y = "Percent Incidence Earworm",
       title = "Provinces to Earworm Incidence") + 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1") 
ggsave(path = "../pests_province", filename = "Corn Earworm Percent Incidence vs Province.png", dpi=plot_dpi)



# by Crop stage
# kruskall-wallis test by corn stage
library("MASS")
attach(summary_earworm)
kruskal_crop_stage_earworm<- kruskal.test(percent_incidence_earworm ~ factor(crop_stage), 
                                        summary_earworm)
DunnTest_crop_stage_earworm <- DunnTest(percent_incidence_earworm ~ crop_stage, summary_earworm)
dunn_earworm_crop_stage_groups <- dunnTest(percent_incidence_earworm ~ factor(crop_stage),
                                         method="bonferroni")
dunn_earworm_crop_stage_groups <- dunn_earworm_crop_stage_groups$res
cld_earworm_crop_stage <- cldList(comparison = dunn_earworm_crop_stage_groups$Comparison,
                                p.value = dunn_earworm_crop_stage_groups$P.adj,
                                threshold = 0.05)[1:2]
cld_earworm_crop_stage$crop_stage <- cld_earworm_crop_stage$Group
cld_earworm_crop_stage <- as.data.frame.list(cld_earworm_crop_stage)

#  values on boxplots geom_text
summary_earworm_crop_stage_bp <-
  summary_earworm %>% 
  group_by(crop_stage) %>% 
  summarise(w=mean(percent_incidence_earworm), sd = mean_sd(percent_incidence_earworm)) %>% 
  arrange(desc(w)) %>%
  fuzzy_left_join(cld_earworm_crop_stage, 
                  by=c("crop_stage"), 
                  match_fun = list(function(x, y) stringdist(x, y) < 2))  %>%
  mutate(crop_stage = crop_stage.x) 

detach("package:MASS", unload = TRUE)
summary_earworm_crop_stage_bp <- summary_earworm_crop_stage_bp %>% select(-c(crop_stage.x, crop_stage.y))
summary_earworm <- summary_earworm %>% left_join(summary_earworm_crop_stage_bp, by=c("crop_stage")) %>% drop_na()


summary_earworm %>%
  ggplot(aes(crop_stage, percent_incidence_earworm)) + 
  geom_boxplot(aes(fill=`Crop Stage`), show.legend=FALSE) +
  geom_text(data = summary_earworm_crop_stage_bp, aes(label = Letter, y = sd$ymax ), 
            vjust = -1, hjust = -0.5, color="red", size = 4) +
  geom_text(data = summary_earworm_crop_stage_bp, aes(label = round(w, 2), y = sd$ymax - 5), 
            vjust = -1, hjust = -0.1, alpha = 0.75, color = "darkblue") +
  scale_x_discrete(limits = crop_growth_stages, labels = stage_labels) +
  labs(x = "Corn Growth Stages", 
       y = "Percent Incidence Earworm",
       title = "Corn Crop Growth Stages and Earworm Incidence",
       caption = "Emergence NOT COUNTED") + 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), ) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_crop_stage", filename = "Corn Earworm Percent Incidence vs Crop Growth Stages.png", dpi=plot_dpi)

detach("package:agricolae", unload = TRUE)
detach("package:rcompanion", unload = TRUE)
detach("package:nortest", unload = TRUE)
detach("package:DescTools", unload = TRUE)
detach("package:stats", unload = TRUE)
```


```Rating of 1 is classified as No damage or No infestation ONLY```
```Corn Planthopper, borer, Leaf feeders(Armyworm, cutworm)```
```rating of 1 is not included in computation on damage rating and incidence```
```Hopper```
```{r}
# Hopper
hopper_df_ev <- 
  insect_raw %>%
  select(FarmID, `Collection Date`, Province, Municipality, Barangay, `Crop Stage`, Treatment, `Corn Type`, Variety, contains("Corn Plant Hopper - Damage Rating ")) %>%
  filter(Municipality != "Santa Rita" & Municipality != "Hilongos" & Municipality != "Tomas Oppus")

hopper_df_ev$collect_date <- 
  as.Date(hopper_df_ev$`Collection Date`, "%B %d, %Y")

hopper_dmg_ev <-
  hopper_df_ev %>% 
  mutate(Year = year(collect_date), Month = month(collect_date))

hopper_joined_ev <-
  hopper_dmg_ev %>% 
  left_join(monthly_averages, by=c('Year', 'Month')) %>%
  rowwise() %>%
  mutate(sum_no = sum(c_across(starts_with("Corn Plant Hopper - Damage Rating ")) == "1"),
         sum_light = sum(c_across(starts_with("Corn Plant Hopper - Damage Rating ")) == "3"),
         sum_moderate = sum(c_across(starts_with("Corn Plant Hopper - Damage Rating ")) == "5"),
         sum_severe = sum(c_across(starts_with("Corn Plant Hopper - Damage Rating ")) == "7"),
         sum_high = sum(c_across(starts_with("Corn Plant Hopper - Damage Rating ")) == "9"),
         average_damage_hopper = (((3 * sum_light) + (5 * sum_moderate) + (7 * sum_severe) + (9 * sum_high)) / (number_sampled_plants)),
         damage_rating_hopper = (((3 * sum_light) + (5 * sum_moderate) + (7 * sum_severe) + (9 * sum_high)) / (number_sampled_plants * 9)) * percent_100,
         incidence_hopper = ((sum(c_across(sum_light:sum_high))) * percent_100) / number_sampled_plants,
         )


#View(hopper_joined_ev)

summary_hopper <-
  hopper_joined_ev %>%
  group_by(Year, Month, Province, Municipality, `Corn Type`,             
           Barangay, Treatment, `Crop Stage`) %>%
  select(-`Crop Stage`) %>%
  remove_missing(na.rm=TRUE) %>%
  summarise(total_count_samples_hopper = n() * number_sampled_plants,
            sum_avg_dmg_hopper = sum(average_damage_hopper),
            sum_dmg_rate_hopper = sum(damage_rating_hopper),
            sum_incidence_hopper = sum(incidence_hopper),
            percent_incidence_hopper = (sum_incidence_hopper / total_count_samples_hopper) * percent_100)

#View(summary_hopper)


summary_hopper$crop_stage <- 
  factor(summary_hopper$`Crop Stage`, 
         levels = c("Early Whorl", "Late Whorl", "Maturity", "Mid Whorl", "Seedling (3 - 4 Leaves)",
                    "Silking", "Single Leaf", "Tasseling", "Emergence"),
         labels = c("early_whorl", "late_whorl", "maturity", "mid_whorl", "seedling", 
                    "silking", "single_leaf", "tasseling", "emergence"))

summary_hopper$order_treat <- ordered(summary_hopper$Treatment,
                                     levels = c("BRFR", "RFR", "ARFR"),
                                     labels = c("B", "R", "A"))

summary_hopper$factor_corn <- factor(summary_hopper$`Corn Type`, 
                                    labels=c("N", "G"), 
                                    levels = c("Non - GM Corn", "GM CORN"))

ggqqplot(summary_hopper$percent_incidence_hopper)

library("nortest")
library("rcompanion")
library("moments")
library("stats")
library("MASS")
library("agricolae")
library("DescTools")

# Kolmogorov Smirnov test for normality samples > 50
ks_test_hopper <- ks.test(summary_hopper$percent_incidence_hopper, 'pnorm')

# Anderson-Darling Test is a goodness-of-fit test that determines how well your data fits a given distribution. 
# This test is most typically used to see if your data follow a normal distribution or not.
# It is a modification of the Kolmogorov-Smirnov (K-S) test and 
# gives more weight to the tails than does the K-S test.
ad_test_hopper <- ad.test(summary_hopper$percent_incidence_hopper)

skew_hopper <- skewness(summary_hopper$percent_incidence_hopper)
kurt_hopper <- kurtosis(summary_hopper$percent_incidence_hopper)

# Jarque-Bera Normality Test performs a goodness-of-fit test that 
# determines whether or not sample data have skewness and 
# kurtosis that matches a normal distribution.
jarq_hopper <- jarque.test(summary_hopper$percent_incidence_hopper)

# Kruskall Wallis applied to one-way, non-normal data with more than two groups
kruskal_fertilizer_hopper <- kruskal.test(percent_incidence_hopper ~ order_treat, summary_hopper)

# Mann-Whitney U test for differences between two independent treatments or conditions.   
# The continuous response variable of interest is not normally distributed.
utest_corn_hopper <- wilcox.test(percent_incidence_hopper ~ factor_corn, summary_hopper)

# The Friedman test determines if there are differences among groups for two-way data structured in a specific way, namely in an unreplicated complete block design.  
# In this design, one variable serves as the treatment or group variable, 
# and another variable serves as the blocking variable.
# fried_fert_corn_hopper <- summary_hopper %>% friedman_test(percent_incidence_hopper ~ order_treat |factor_corn)


# Null hypothesis is variances across all samples are equal. 
# Leveneâs test is an alternative to Bartlettâs test when the data is not normally distributed.
levenes_fertilizer_hopper <- leveneTest(percent_incidence_hopper ~ Treatment, summary_hopper)
levenes_corntype_hopper <- leveneTest(percent_incidence_hopper ~ `Corn Type`, summary_hopper)
levenes_municipality_hopper <- leveneTest(percent_incidence_hopper ~ Municipality, summary_hopper)
levenes_province_hopper <- leveneTest(percent_incidence_hopper ~ Province, summary_hopper)
levenes_fert_corn_hopper <- leveneTest(percent_incidence_hopper ~ interaction(Treatment, `Corn Type`), summary_hopper)
levenes_stage_hopper <- leveneTest(percent_incidence_hopper ~ `Crop Stage`, summary_hopper)

# AnOVa
aov_fert_hopper <- aov(percent_incidence_hopper ~ order_treat, summary_hopper)
aov_corn_hopper <- aov(percent_incidence_hopper ~ factor_corn, summary_hopper)
ttest_corn_hopper <- t.test(percent_incidence_hopper ~ factor_corn, summary_hopper)

# Two way AnOVa
twoway_fert_corn_hopper <- aov(percent_incidence_hopper ~ order_treat + factor_corn, summary_hopper) 
tukey_fert_corn_hopper <- TukeyHSD(twoway_fert_corn_hopper)

# AnOVa with Interaction
aov_fert_corn_inter_hopper <- aov(percent_incidence_hopper ~ order_treat*factor_corn, summary_hopper)
tukey_fert_corn_inter_hopper <- TukeyHSD(aov_fert_corn_inter_hopper)

aov_fert_hopper %>% summary()
aov_corn_hopper %>% summary()
ttest_corn_hopper
twoway_fert_corn_hopper %>% summary()
print(tukey_fert_corn_hopper)
aov_fert_corn_inter_hopper %>% summary()
print(tukey_fert_corn_inter_hopper)

TukeyHSD(aov_fert_hopper)
TukeyHSD(aov_corn_hopper)

twoway_fert_corn_hopper_letters <- multcompLetters4(twoway_fert_corn_hopper, tukey_fert_corn_hopper)
aov_fert_corn_hopper_letters <- multcompLetters4(aov_fert_corn_inter_hopper, tukey_fert_corn_inter_hopper)


# Create transformed objects using bestNormalize
library("bestNormalize")
bestNorm_hopper <- predict(bestNormalize(summary_hopper$percent_incidence_hopper, out_of_sample = FALSE, loo = TRUE))
hopper_joined_ev$trans_incidence_hopper <- predict(bestNormalize(hopper_joined_ev$incidence_hopper, out_of_sample = FALSE, loo = TRUE))

hopper_ev <-
  hopper_joined_ev %>%
  mutate(Province = factor(Province),
         Municipality = factor(Municipality),
         crop_stage = factor(`Crop Stage`),
         treatment = factor(Treatment),
         corn_type = factor(`Corn Type`, labels=c("N", "G"), levels=c("Non - GM Corn", "GM CORN")),
         incidence_hopper = as.numeric(incidence_hopper))


cor_hopper_wind_incidence <- cor(hopper_ev$mean_wind, hopper_ev$incidence_hopper, method = "pearson", use = "pairwise.complete.obs")

cor_hopper_temp_incidence <- cor(hopper_ev$mean_temp, hopper_ev$incidence_hopper, method = "pearson", use = "pairwise.complete.obs")

cor_hopper_humid_incidence <- cor(hopper_ev$mean_humid, hopper_ev$incidence_hopper, method = "pearson", use = "pairwise.complete.obs")

cor_hopper_rain_incidence <- cor(hopper_ev$mean_rain, hopper_ev$incidence_hopper, method = "pearson", use = "pairwise.complete.obs")



# lm
lm_rain_hopper  <- lm(incidence_hopper ~ mean_rain, data = hopper_joined_ev)
lm_wind_hopper  <- lm(incidence_hopper ~ mean_wind, data = hopper_joined_ev)
lm_humid_hopper <- lm(incidence_hopper ~ mean_humid, data = hopper_joined_ev)
lm_temp_hopper  <- lm(incidence_hopper ~ mean_temp, data = hopper_joined_ev)


temp_hopper_eqn <- sprintf(
    "italic(y) == %.3g %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_temp_hopper)[1],
    coef(lm_temp_hopper)[2],
    round(cor_hopper_temp_incidence, 3)
  )

rain_hopper_eqn <- sprintf(
    "italic(y) == %.3g %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_rain_hopper)[1],
    coef(lm_rain_hopper)[2],
    round(cor_hopper_rain_incidence, 3)
  )


wind_hopper_eqn <- sprintf(
    "italic(y) == %.3g + %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_wind_hopper)[1],
    coef(lm_wind_hopper)[2],
    round(cor_hopper_wind_incidence, 3)
  )


humid_hopper_eqn <- sprintf(
    "italic(y) == %.3g %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_humid_hopper)[1],
    coef(lm_humid_hopper)[2],
    round(cor_hopper_humid_incidence, 3)
  )


hopper_joined_ev %>%
  ggplot(aes(mean_temp, incidence_hopper)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.5) +
  labs(x = "Monthly Average temperature (C)", 
       y = "Incidence Earworm",
       title = "Temperature and Incidence of Corn Plant Hopper") +
  annotate("label", x = 27, y = 8,  
           label = temp_hopper_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_temperature", filename = "Corn Plant Hopper vs Temperature.png", dpi=plot_dpi)


hopper_joined_ev %>%
  ggplot(aes(mean_wind, incidence_hopper)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.5) +
  labs(x = "Monthly Average Wind Speed (km/h)", 
       y = "Incidence Earworm",
       title = "Wind Speed and Incidence of Corn Plant Hopper") +
  annotate("label", x = 7, y = 8,  
           label = wind_hopper_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_wind_speed", filename = "Corn Plant Hopper vs Wind.png", dpi=plot_dpi)


hopper_joined_ev %>%
  ggplot(aes(mean_humid, incidence_hopper)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.7) +
  labs(x = "Monthly Average Humidity (%)", 
       y = "Incidence Earworm",
       title = "Humidity and Incidence of Corn Plant Hopper") +
  annotate("label", x = 60, y = 8,  
           label = humid_hopper_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_humidity", filename = "Corn Plant Hopper vs Humidity.png", dpi=plot_dpi)


hopper_joined_ev %>%
  ggplot(aes(mean_rain, incidence_hopper)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.5) +
  labs(x = "Monthly Average Rainfall (mm)", 
       y = "Incidence Earworm",
       title = "Rainfall and Incidence of Corn Plant Hopper") +
  annotate("label", x = 0.4, y = 10,  
           label = rain_hopper_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_rainfall", filename = "Corn Plant Hopper vs Rain.png", dpi=plot_dpi)

# by corn type T-test
ttest_corn_hopper <- t.test(percent_incidence_hopper ~ factor_corn, summary_hopper)

DunnTest_corn_type_hopper <- DunnTest(percent_incidence_hopper ~ factor_corn, summary_hopper)
dunn_hopper_corn_type_groups <- dunnTest(percent_incidence_hopper ~ factor_corn, summary_hopper,
                                         method="none")
dunn_hopper_corn_type_groups <- dunn_hopper_corn_type_groups$res
cld_hopper_corn_type <- cldList(comparison = dunn_hopper_corn_type_groups$Comparison,
                                p.value = dunn_hopper_corn_type_groups$P.adj,
                                threshold = 0.05)[1:2]
cld_hopper_corn_type$factor_corn <- cld_borer_corn_type$Group
cld_hopper_corn_type <- as.data.frame.list(cld_borer_corn_type)

summary_hopper_corntype_bp <-
  summary_hopper %>% 
  group_by(factor_corn) %>% 
  summarise(w=mean(percent_incidence_hopper), sd = mean_sd(percent_incidence_hopper)) %>% 
  arrange(desc(w)) %>%
  left_join(cld_hopper_corn_type, by=c("factor_corn"))

summary_hopper %>%
  ggplot(aes(factor_corn, percent_incidence_hopper)) + 
  geom_boxplot(aes(fill=factor_corn), show.legend=FALSE) +
  geom_text(data = summary_hopper_corntype_bp, aes(label = Letter,
                y = sd$ymax), vjust = -1, hjust = -0.5, color="red", size = 5) +
  geom_text(data = summary_hopper_corntype_bp, aes(label = round(w, 2), y = sd$ymax-5), vjust = -1, hjust=-1, alpha = 0.75, color = "darkblue") +
  labs(x = "Corn Type (GM or Non-GM)", 
       y = "Percent Incidence Hopper",
       title = "Effect of Corn Type to Hopper Incidence") +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_corn_type",, filename = "Corn Plant Hopper Percent Incidence vs Corn Type.png", dpi=plot_dpi)



# by fertilizer treatment rate
summary_hopper_fert_bp <-
  summary_hopper %>% 
  group_by(order_treat) %>% 
  summarise(w=mean(percent_incidence_hopper), sd = mean_sd(percent_incidence_hopper)) %>% 
  arrange(desc(w))

summary_hopper_fert_bp$treatment_cld <- 
  as.data.frame.list(twoway_fert_corn_hopper_letters$order_treat)$Letters

summary_hopper %>%
  ggplot(aes(order_treat, percent_incidence_hopper)) + 
  geom_boxplot(aes(fill=order_treat), show.legend=FALSE) +
  geom_text(data = summary_hopper_fert_bp, aes(label = treatment_cld,
                y = sd$ymax), vjust = -1, hjust = -0.5, color="red", size = 5) +
  geom_text(data = summary_hopper_fert_bp, aes(label = round(w, 2), y = sd$ymax - 5), vjust = -1, hjust = -0.5, alpha = 0.75, color = "darkblue") +
  labs(x = "Fertilizer Treatment Rate", 
       y = "Percent Incidence Earworm",
       title = "Effect of Fertilizer Treatment Rate to Earworm Incidence") + 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_fertilizer_rate", filename = "Corn Plant Hopper Percent Incidence vs Fertilizer Treatment.png", dpi=plot_dpi)

# by province
# kruskall-wallis test by province
attach(summary_hopper)
kruskal_province_hopper<- kruskal.test(percent_incidence_hopper ~ factor(Province), 
                                        summary_hopper)
DunnTest_province_hopper <- DunnTest(percent_incidence_hopper ~ Province, summary_hopper)
dunn_hopper_province_groups <- dunnTest(percent_incidence_hopper ~ factor(Province),
                                         method="bonferroni")
dunn_hopper_province_groups <- dunn_hopper_province_groups$res
cld_hopper_province <- cldList(comparison = dunn_hopper_province_groups$Comparison,
                                p.value = dunn_hopper_province_groups$P.adj,
                                threshold = 0.05)[1:2]
cld_hopper_province$Province <- cld_hopper_province$Group
cld_hopper_province <- as.data.frame.list(cld_hopper_province)

#  values on boxplots geom_text

detach("package:MASS", unload = TRUE)
summary_hopper_province_bp <-
  summary_hopper %>% 
  group_by(Province) %>% 
  summarise(w=mean(percent_incidence_hopper), sd = mean_sd(percent_incidence_hopper)) %>% 
  arrange(desc(w)) %>%
  fuzzy_left_join(cld_hopper_province, 
                  by=c("Province"), 
                  match_fun = list(function(x, y) stringdist(x, y) < 2))  %>%
  mutate(Province = Province.x)
  
summary_hopper_province_bp <- summary_hopper_province_bp %>% select(-c(Province.x, Province.y))


summary_hopper <- summary_hopper %>% left_join(summary_hopper_province_bp, by=c("Province"))


summary_hopper %>%
  ggplot(aes(Province, percent_incidence_hopper)) + 
  geom_boxplot(aes(fill=Province), show.legend = FALSE) +
  geom_text(data = summary_hopper_province_bp, aes(y = sd$ymax, label = Letter), 
            vjust = -1, hjust = -0.5, color="red", size = 4) +
  geom_text(data = summary_hopper_province_bp, aes(label = round(w, 2), y = sd$ymax - 5), 
            vjust = -1, hjust = -0.5, alpha = 0.75, color = "darkblue") +
  labs(x = "Provinces", 
       y = "Percent Incidence Hopper",
       title = "Provinces to Hopper Incidence") + 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1") 
ggsave(path = "../pests_province", filename = "Corn Plant Hopper Percent Incidence vs Province.png", dpi=plot_dpi)



# by Crop stage
# kruskall-wallis test by corn stage
library("MASS")
attach(summary_hopper)
kruskal_crop_stage_hopper<- kruskal.test(percent_incidence_hopper ~ factor(crop_stage), 
                                        summary_hopper)
DunnTest_crop_stage_hopper <- DunnTest(percent_incidence_hopper ~ crop_stage, summary_hopper)
dunn_hopper_crop_stage_groups <- dunnTest(percent_incidence_hopper ~ factor(crop_stage),
                                         method="bonferroni")
dunn_hopper_crop_stage_groups <- dunn_hopper_crop_stage_groups$res
cld_hopper_crop_stage <- cldList(comparison = dunn_hopper_crop_stage_groups$Comparison,
                                p.value = dunn_hopper_crop_stage_groups$P.adj,
                                threshold = 0.05)[1:2]
cld_hopper_crop_stage$crop_stage <- cld_hopper_crop_stage$Group
cld_hopper_crop_stage <- as.data.frame.list(cld_hopper_crop_stage)

#  values on boxplots geom_text
summary_hopper_crop_stage_bp <-
  summary_hopper %>% 
  group_by(crop_stage) %>% 
  summarise(w=mean(percent_incidence_hopper), sd = mean_sd(percent_incidence_hopper)) %>% 
  arrange(desc(w)) %>%
  fuzzy_left_join(cld_hopper_crop_stage, 
                  by=c("crop_stage"), 
                  match_fun = list(function(x, y) stringdist(x, y) < 2))  %>%
  mutate(crop_stage = crop_stage.x) 

detach("package:MASS", unload = TRUE)
summary_hopper_crop_stage_bp <- summary_hopper_crop_stage_bp %>% select(-c(crop_stage.x, crop_stage.y))
summary_hopper <- summary_hopper %>% left_join(summary_hopper_crop_stage_bp, by=c("crop_stage")) %>% drop_na()


summary_hopper %>%
  ggplot(aes(crop_stage, percent_incidence_hopper)) + 
  geom_boxplot(aes(fill=`Crop Stage`), show.legend=FALSE) +
  geom_text(data = summary_hopper_crop_stage_bp, aes(label = Letter, y = sd$ymax ), 
            vjust = -1, hjust = -0.5, color="red", size = 4) +
  geom_text(data = summary_hopper_crop_stage_bp, aes(label = round(w, 2), y = sd$ymax - 5), 
            vjust = -1, hjust = -0.1, alpha = 0.75, color = "darkblue") +
  scale_x_discrete(limits = crop_growth_stages, labels = stage_labels) +
  labs(x = "Corn Growth Stages", 
       y = "Percent Incidence Hopper",
       title = "Corn Crop Growth Stages and Hopper Incidence",
       caption = "Emergence NOT COUNTED") + 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), ) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_crop_stage", filename = "Corn Plant Hopper Percent Incidence vs Crop Growth Stages.png", dpi=plot_dpi)

detach("package:agricolae", unload = TRUE)
detach("package:rcompanion", unload = TRUE)
detach("package:nortest", unload = TRUE)
detach("package:DescTools", unload = TRUE)
detach("package:stats", unload = TRUE)
```


```Rating of 1 is classified as No damage or No infestation ONLY```
```Corn Planthopper, borer, Leaf feeders(Armyworm, `cutworm`)```
```rating of 1 is not included in computation on damage rating and incidence```
```Cutworm```
```{r}
# Cutworm
cutworm_df_ev <- 
  insect_raw %>%
  select(FarmID, `Collection Date`, Province, Municipality, Barangay, `Crop Stage`, Treatment, `Corn Type`, Variety, contains("Cutworm - Damage Rating ")) %>%
  filter(Municipality != "Santa Rita" & Municipality != "Hilongos" & Municipality != "Tomas Oppus")

cutworm_df_ev$collect_date <- 
  as.Date(cutworm_df_ev$`Collection Date`, "%B %d, %Y")

cutworm_dmg_ev <-
  cutworm_df_ev %>% 
  mutate(Year = year(collect_date), Month = month(collect_date))

cutworm_joined_ev <-
  cutworm_dmg_ev %>% 
  left_join(monthly_averages, by=c('Year', 'Month')) %>%
  rowwise() %>%
  mutate(sum_no = sum(c_across(starts_with("Cutworm - Damage Rating ")) == "1"),
         sum_light = sum(c_across(starts_with("Cutworm - Damage Rating ")) == "3"),
         sum_moderate = sum(c_across(starts_with("Cutworm - Damage Rating ")) == "5"),
         sum_severe = sum(c_across(starts_with("Cutworm - Damage Rating ")) == "7"),
         sum_high = sum(c_across(starts_with("Cutworm - Damage Rating ")) == "9"),
         average_damage_cutworm = (((3 * sum_light) + (5 * sum_moderate) + (7 * sum_severe) + (9 * sum_high)) / (number_sampled_plants)),
         damage_rating_cutworm = (((3 * sum_light) + (5 * sum_moderate) + (7 * sum_severe) + (9 * sum_high)) / (number_sampled_plants * 9)) * percent_100,
         incidence_cutworm = ((sum(c_across(sum_light:sum_high))) * percent_100) / number_sampled_plants,
         )


#View(cutworm_joined_ev)

summary_cutworm <-
  cutworm_joined_ev %>%
  group_by(Year, Month, Province, Municipality, `Corn Type`,             
           Barangay, Treatment, `Crop Stage`) %>%
  select(-`Crop Stage`) %>%
  remove_missing(na.rm=TRUE) %>%
  summarise(total_count_samples_cutworm = n() * number_sampled_plants,
            sum_avg_dmg_cutworm = sum(average_damage_cutworm),
            sum_dmg_rate_cutworm = sum(damage_rating_cutworm),
            sum_incidence_cutworm = sum(incidence_cutworm),
            percent_incidence_cutworm = (sum_incidence_cutworm / total_count_samples_cutworm) * percent_100)

#View(summary_cutworm)


summary_cutworm$crop_stage <- 
  factor(summary_cutworm$`Crop Stage`, 
         levels = c("Early Whorl", "Late Whorl", "Maturity", "Mid Whorl", "Seedling (3 - 4 Leaves)",
                    "Silking", "Single Leaf", "Tasseling", "Emergence"),
         labels = c("early_whorl", "late_whorl", "maturity", "mid_whorl", "seedling", 
                    "silking", "single_leaf", "tasseling", "emergence"))

summary_cutworm$order_treat <- ordered(summary_cutworm$Treatment,
                                     levels = c("BRFR", "RFR", "ARFR"),
                                     labels = c("B", "R", "A"))

summary_cutworm$factor_corn <- factor(summary_cutworm$`Corn Type`, 
                                    labels=c("N", "G"), 
                                    levels = c("Non - GM Corn", "GM CORN"))

ggqqplot(summary_cutworm$percent_incidence_cutworm)

library("nortest")
library("rcompanion")
library("moments")
library("stats")
library("MASS")
library("agricolae")
library("DescTools")

# Kolmogorov Smirnov test for normality samples > 50
ks_test_cutworm <- ks.test(summary_cutworm$percent_incidence_cutworm, 'pnorm')

# Anderson-Darling Test is a goodness-of-fit test that determines how well your data fits a given distribution. 
# This test is most typically used to see if your data follow a normal distribution or not.
# It is a modification of the Kolmogorov-Smirnov (K-S) test and 
# gives more weight to the tails than does the K-S test.
ad_test_cutworm <- ad.test(summary_cutworm$percent_incidence_cutworm)

skew_cutworm <- skewness(summary_cutworm$percent_incidence_cutworm)
kurt_cutworm <- kurtosis(summary_cutworm$percent_incidence_cutworm)

# Jarque-Bera Normality Test performs a goodness-of-fit test that 
# determines whether or not sample data have skewness and 
# kurtosis that matches a normal distribution.
jarq_cutworm <- jarque.test(summary_cutworm$percent_incidence_cutworm)

# Kruskall Wallis applied to one-way, non-normal data with more than two groups
kruskal_fertilizer_cutworm <- kruskal.test(percent_incidence_cutworm ~ order_treat, summary_cutworm)

# Mann-Whitney U test for differences between two independent treatments or conditions.   
# The continuous response variable of interest is not normally distributed.
utest_corn_cutworm <- wilcox.test(percent_incidence_cutworm ~ factor_corn, summary_cutworm)

# The Friedman test determines if there are differences among groups for two-way data structured in a specific way, namely in an unreplicated complete block design.  
# In this design, one variable serves as the treatment or group variable, 
# and another variable serves as the blocking variable.
# fried_fert_corn_cutworm <- summary_cutworm %>% friedman_test(percent_incidence_cutworm ~ order_treat |factor_corn)


# Null hypothesis is variances across all samples are equal. 
# Leveneâs test is an alternative to Bartlettâs test when the data is not normally distributed.
levenes_fertilizer_cutworm <- leveneTest(percent_incidence_cutworm ~ Treatment, summary_cutworm)
levenes_corntype_cutworm <- leveneTest(percent_incidence_cutworm ~ `Corn Type`, summary_cutworm)
levenes_municipality_cutworm <- leveneTest(percent_incidence_cutworm ~ Municipality, summary_cutworm)
levenes_province_cutworm <- leveneTest(percent_incidence_cutworm ~ Province, summary_cutworm)
levenes_fert_corn_cutworm <- leveneTest(percent_incidence_cutworm ~ interaction(Treatment, `Corn Type`), summary_cutworm)
levenes_stage_cutworm <- leveneTest(percent_incidence_cutworm ~ `Crop Stage`, summary_cutworm)

# AnOVa
aov_fert_cutworm <- aov(percent_incidence_cutworm ~ order_treat, summary_cutworm)
aov_corn_cutworm <- aov(percent_incidence_cutworm ~ factor_corn, summary_cutworm)
ttest_corn_cutworm <- t.test(percent_incidence_cutworm ~ factor_corn, summary_cutworm)
aov_stage_cutworm <- aov(percent_incidence_cutworm ~ crop_stage, summary_cutworm)

# Two way AnOVa
twoway_fert_corn_cutworm <- aov(percent_incidence_cutworm ~ order_treat + factor_corn, summary_cutworm) 
tukey_fert_corn_cutworm <- TukeyHSD(twoway_fert_corn_cutworm)

# AnOVa with Interaction
aov_fert_corn_inter_cutworm <- aov(percent_incidence_cutworm ~ order_treat*factor_corn, summary_cutworm)
tukey_fert_corn_inter_cutworm <- TukeyHSD(aov_fert_corn_inter_cutworm)

aov_fert_cutworm %>% summary()
aov_corn_cutworm %>% summary()

ttest_corn_cutworm
twoway_fert_corn_cutworm %>% summary()
print(tukey_fert_corn_cutworm)
aov_fert_corn_inter_cutworm %>% summary()
print(tukey_fert_corn_inter_cutworm)

TukeyHSD(aov_fert_cutworm)
TukeyHSD(aov_corn_cutworm)

twoway_fert_corn_cutworm_letters <- multcompLetters4(twoway_fert_corn_cutworm, tukey_fert_corn_cutworm)
aov_fert_corn_cutworm_letters <- multcompLetters4(aov_fert_corn_inter_cutworm, tukey_fert_corn_inter_cutworm)
tukey_stage_cutworm <- TukeyHSD(aov_stage_cutworm)

# Create transformed objects using bestNormalize
library("bestNormalize")
bestNorm_cutworm <- predict(bestNormalize(summary_cutworm$percent_incidence_cutworm, out_of_sample = FALSE, loo = TRUE))
cutworm_joined_ev$trans_incidence_cutworm <- predict(bestNormalize(cutworm_joined_ev$incidence_cutworm, out_of_sample = FALSE, loo = TRUE))

cutworm_ev <-
  cutworm_joined_ev %>%
  mutate(Province = factor(Province),
         Municipality = factor(Municipality),
         crop_stage = factor(`Crop Stage`),
         treatment = factor(Treatment),
         corn_type = factor(`Corn Type`, labels=c("N", "G"), levels=c("Non - GM Corn", "GM CORN")),
         incidence_cutworm = as.numeric(incidence_cutworm))


cor_cutworm_wind_incidence <- cor(cutworm_ev$mean_wind, cutworm_ev$incidence_cutworm, method = "pearson", use = "pairwise.complete.obs")

cor_cutworm_temp_incidence <- cor(cutworm_ev$mean_temp, cutworm_ev$incidence_cutworm, method = "pearson", use = "pairwise.complete.obs")

cor_cutworm_humid_incidence <- cor(cutworm_ev$mean_humid, cutworm_ev$incidence_cutworm, method = "pearson", use = "pairwise.complete.obs")

cor_cutworm_rain_incidence <- cor(cutworm_ev$mean_rain, cutworm_ev$incidence_cutworm, method = "pearson", use = "pairwise.complete.obs")



# lm
lm_rain_cutworm  <- lm(incidence_cutworm ~ mean_rain, data = cutworm_joined_ev)
lm_wind_cutworm  <- lm(incidence_cutworm ~ mean_wind, data = cutworm_joined_ev)
lm_humid_cutworm <- lm(incidence_cutworm ~ mean_humid, data = cutworm_joined_ev)
lm_temp_cutworm  <- lm(incidence_cutworm ~ mean_temp, data = cutworm_joined_ev)


temp_cutworm_eqn <- sprintf(
    "italic(y) == %.3g + %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_temp_cutworm)[1],
    coef(lm_temp_cutworm)[2],
    round(cor_cutworm_temp_incidence, 3)
  )

rain_cutworm_eqn <- sprintf(
    "italic(y) == %.3g + %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_rain_cutworm)[1],
    coef(lm_rain_cutworm)[2],
    round(cor_cutworm_rain_incidence, 3)
  )


wind_cutworm_eqn <- sprintf(
    "italic(y) == %.3g %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_wind_cutworm)[1],
    coef(lm_wind_cutworm)[2],
    round(cor_cutworm_wind_incidence, 3)
  )


humid_cutworm_eqn <- sprintf(
    "italic(y) == %.3g + %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_humid_cutworm)[1],
    coef(lm_humid_cutworm)[2],
    round(cor_cutworm_humid_incidence, 3)
  )


cutworm_joined_ev %>%
  ggplot(aes(mean_temp, incidence_cutworm)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.5) +
  labs(x = "Monthly Average temperature (C)", 
       y = "Incidence Armyworm",
       title = "Temperature and Incidence of Cutworm") +
  annotate("label", x = 27, y = 8,  
           label = temp_cutworm_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_temperature", filename = "Cutworm vs Temperature.png", dpi=plot_dpi)


cutworm_joined_ev %>%
  ggplot(aes(mean_wind, incidence_cutworm)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.5) +
  labs(x = "Monthly Average Wind Speed (km/h)", 
       y = "Incidence Cutworm",
       title = "Wind Speed and Incidence of Cutworm") +
  annotate("label", x = 7, y = 8,  
           label = wind_cutworm_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_wind_speed", filename = "Cutworm vs Wind.png", dpi=plot_dpi)


cutworm_joined_ev %>%
  ggplot(aes(mean_humid, incidence_cutworm)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.7) +
  labs(x = "Monthly Average Humidity (%)", 
       y = "Incidence Cutworm",
       title = "Humidity and Incidence of Cutworm") +
  annotate("label", x = 60, y = 8,  
           label = humid_cutworm_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_humidity", filename = "Cutworm vs Humidity.png", dpi=plot_dpi)


cutworm_joined_ev %>%
  ggplot(aes(mean_rain, incidence_cutworm)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.5) +
  labs(x = "Monthly Average Rainfall (mm)", 
       y = "Incidence Cutworm",
       title = "Rainfall and Incidence of Cutworm") +
  annotate("label", x = 0.4, y = 10,  
           label = rain_cutworm_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_rainfall", filename = "Cutworm vs Rain.png", dpi=plot_dpi)

# by corn type T-test
ttest_corn_cutworm <- t.test(percent_incidence_cutworm ~ factor_corn, summary_cutworm)

DunnTest_corn_type_cutworm <- DunnTest(percent_incidence_cutworm ~ factor_corn, summary_cutworm)
dunn_cutworm_corn_type_groups <- dunnTest(percent_incidence_cutworm ~ factor_corn, summary_cutworm,
                                         method="none")
dunn_cutworm_corn_type_groups <- dunn_cutworm_corn_type_groups$res
cld_cutworm_corn_type <- cldList(comparison = dunn_cutworm_corn_type_groups$Comparison,
                                p.value = dunn_cutworm_corn_type_groups$P.adj,
                                threshold = 0.05)[1:2]
cld_cutworm_corn_type$factor_corn <- cld_borer_corn_type$Group
cld_cutworm_corn_type <- as.data.frame.list(cld_borer_corn_type)

summary_cutworm_corntype_bp <-
  summary_cutworm %>% 
  group_by(factor_corn) %>% 
  summarise(w=mean(percent_incidence_cutworm), sd = mean_sd(percent_incidence_cutworm)) %>% 
  arrange(desc(w)) %>%
  left_join(cld_cutworm_corn_type, by=c("factor_corn"))


summary_cutworm %>%
  ggplot(aes(factor_corn, percent_incidence_cutworm)) + 
  geom_boxplot(aes(fill=factor_corn), show.legend=FALSE) +
  geom_text(data = summary_cutworm_corntype_bp, aes(label = Letter,
                y = sd$ymax), vjust = -1, hjust = -0.5, color="red", size = 5) +
  geom_text(data = summary_cutworm_corntype_bp, aes(label = round(w, 2), y = sd$ymax-5), vjust = -1, hjust=-1, alpha = 0.75, color = "darkblue") +
  labs(x = "Corn Type (GM or Non-GM)", 
       y = "Percent Incidence Cutworm",
       title = "Effect of Corn Type to Cutworm Incidence") +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_corn_type", filename = "Cutworm Percent Incidence vs Corn Type.png", dpi=plot_dpi)


# by fertilizer treatment rate
summary_cutworm_fert_bp <-
  summary_cutworm %>% 
  group_by(order_treat) %>% 
  summarise(w=mean(percent_incidence_cutworm), sd = mean_sd(percent_incidence_cutworm)) %>% 
  arrange(desc(w))

summary_cutworm_fert_bp$treatment_cld <- 
  as.data.frame.list(twoway_fert_corn_cutworm_letters$order_treat)$Letters

summary_cutworm %>%
  ggplot(aes(order_treat, percent_incidence_cutworm)) + 
  geom_boxplot(aes(fill=order_treat), show.legend=FALSE) +
  geom_text(data = summary_cutworm_fert_bp, aes(label = treatment_cld,
                y = sd$ymax), vjust = -1, hjust = -0.5, color="red", size = 5) +
  geom_text(data = summary_cutworm_fert_bp, aes(label = round(w, 2), y = sd$ymax - 5), vjust = -1, hjust = -0.5, alpha = 0.75, color = "darkblue") +
  labs(x = "Fertilizer Treatment Rate", 
       y = "Percent Incidence Cutworm",
       title = "Effect of Fertilizer Treatment Rate to Cutworm Incidence") + 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_fertilizer_rate", filename = "Cutworm Percent Incidence vs Fertilizer Treatment.png", dpi=plot_dpi)

# by province
# kruskall-wallis test by province
attach(summary_cutworm)
kruskal_province_cutworm<- kruskal.test(percent_incidence_cutworm ~ factor(Province), 
                                        summary_cutworm)
DunnTest_province_cutworm <- DunnTest(percent_incidence_cutworm ~ Province, summary_cutworm)
dunn_cutworm_province_groups <- dunnTest(percent_incidence_cutworm ~ factor(Province),
                                         method="bonferroni")
dunn_cutworm_province_groups <- dunn_cutworm_province_groups$res
cld_cutworm_province <- cldList(comparison = dunn_cutworm_province_groups$Comparison,
                                p.value = dunn_cutworm_province_groups$P.adj,
                                threshold = 0.05)[1:2]
cld_cutworm_province$Province <- cld_cutworm_province$Group
cld_cutworm_province <- as.data.frame.list(cld_cutworm_province)

#  values on boxplots geom_text

detach("package:MASS", unload = TRUE)
summary_cutworm_province_bp <-
  summary_cutworm %>% 
  group_by(Province) %>% 
  summarise(w=mean(percent_incidence_cutworm), sd = mean_sd(percent_incidence_cutworm)) %>% 
  arrange(desc(w)) %>%
  fuzzy_left_join(cld_cutworm_province, 
                  by=c("Province"), 
                  match_fun = list(function(x, y) stringdist(x, y) < 2))  %>%
  mutate(Province = Province.x)
  
summary_cutworm_province_bp <- summary_cutworm_province_bp %>% select(-c(Province.x, Province.y))


summary_cutworm <- summary_cutworm %>% left_join(summary_cutworm_province_bp, by=c("Province"))


summary_cutworm %>%
  ggplot(aes(Province, percent_incidence_cutworm)) + 
  geom_boxplot(aes(fill=Province), show.legend = FALSE) +
  geom_text(data = summary_cutworm_province_bp, aes(y = sd$ymax, label = Letter), 
            vjust = -1, hjust = -0.5, color="red", size = 4) +
  geom_text(data = summary_cutworm_province_bp, aes(label = round(w, 2), y = sd$ymax - 5), 
            vjust = -1, hjust = -0.5, alpha = 0.75, color = "darkblue") +
  labs(x = "Provinces", 
       y = "Percent Incidence Cutworm",
       title = "Provinces to Cutworm Incidence") + 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1") 
ggsave(path = "../pests_province", filename = "Cutworm Percent Incidence vs Province.png", dpi=plot_dpi)



# by Crop stage
aov_stage_cutworm %>% summary()
tukey_crop_stage_cutworm_letters <- multcompLetters4(aov_stage_cutworm, tukey_stage_cutworm)

summary_cutworm_crop_stage_bp <-
  summary_cutworm %>% 
  group_by(crop_stage) %>% 
  summarise(w=mean(percent_incidence_cutworm), sd = mean_sd(percent_incidence_cutworm)) %>% 
  arrange(desc(w))

summary_cutworm_crop_stage_bp$crop_stage_cld <- 
  as.data.frame.list(tukey_crop_stage_cutworm_letters$crop_stage)$Letters


summary_cutworm %>%
  ggplot(aes(crop_stage, percent_incidence_cutworm)) + 
  geom_boxplot(aes(fill=`Crop Stage`), show.legend=FALSE) +
  geom_text(data = summary_cutworm_crop_stage_bp, aes(label = crop_stage_cld, y = sd$ymax ), 
            vjust = -1, hjust = -0.5, color="red", size = 4) +
  geom_text(data = summary_cutworm_crop_stage_bp, aes(label = round(w, 2), y = sd$ymax - 5), 
            vjust = -1, hjust = -0.1, alpha = 0.75, color = "darkblue") +
  scale_x_discrete(limits = crop_growth_stages, labels = stage_labels) +
  labs(x = "Corn Growth Stages", 
       y = "Percent Incidence Cutworm",
       title = "Corn Crop Growth Stages and Cutworm Incidence",
       caption = "Emergence NOT COUNTED") + 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), ) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_crop_stage", filename = "Cutworm Percent Incidence vs Crop Growth Stages.png", dpi=plot_dpi)

detach("package:agricolae", unload = TRUE)
detach("package:rcompanion", unload = TRUE)
detach("package:nortest", unload = TRUE)
detach("package:DescTools", unload = TRUE)
detach("package:stats", unload = TRUE)
```


```Rating of 1 is classified as No damage or No infestation ONLY```
```Corn Planthopper, aphids, Leaf feeders(Armyworm, cutworm)```
```rating of 1 is not included in computation on damage rating and incidence```
```Armyworm```
```{r}
# Corn leaf feeders: Armyworm
armyworm_df_ev <- 
  insect_raw %>%
  select(FarmID, `Collection Date`, Province, Municipality, Barangay, `Crop Stage`, Treatment, `Corn Type`, Variety, starts_with("Armyworm - Damage Rating ")) %>%
  filter(Municipality != "Santa Rita" & Municipality != "Hilongos" & Municipality != "Tomas Oppus")

armyworm_df_ev$collect_date <- 
  as.Date(armyworm_df_ev$`Collection Date`, "%B %d, %Y")

armyworm_dmg_ev <-
  armyworm_df_ev %>% 
  mutate(Year = year(collect_date), Month = month(collect_date))

number_sampled_plants <- 20


armyworm_joined_ev <-
  armyworm_dmg_ev %>% 
  left_join(monthly_averages, by=c('Year', 'Month')) %>%
  rowwise() %>%
    mutate(sum_no = sum(c_across(starts_with("Armyworm - Damage Rating ")) == "1"),
           sum_light = sum(c_across(starts_with("Armyworm - Damage Rating ")) == "3"),
           sum_moderate = sum(c_across(starts_with("Armyworm - Damage Rating ")) == "5"),
           sum_severe = sum(c_across(starts_with("Armyworm - Damage Rating ")) == "7"),
           sum_high = sum(c_across(starts_with("Armyworm - Damage Rating ")) == "9"),
           average_damage_armyworm = (((1 * sum_no) + (3 * sum_light) + (5 * sum_moderate) + (7 * sum_severe) + (9 * sum_high)) / (number_sampled_plants)),
           damage_rating_armyworm = (((1 * sum_no) + (3 * sum_light) + (5 * sum_moderate) + (7 * sum_severe) + (9 * sum_high)) / (number_sampled_plants * 9)) * percent_100,
           incidence_armyworm = ((sum(c_across(sum_light:sum_high))) * percent_100) / number_sampled_plants,
           )

#View(armyworm_joined_ev)

summary_armyworm <-
  armyworm_joined_ev %>%
  group_by(Year, Month, Province, Municipality, `Corn Type`,             
           Barangay, Treatment, `Crop Stage`) %>%
  remove_missing(na.rm=TRUE) %>%
  summarise(total_count_samples_armyworm = n() * number_sampled_plants,
            sum_avg_dmg_armyworm = sum(average_damage_armyworm),
            sum_dmg_rate_armyworm = sum(damage_rating_armyworm),
            sum_incidence_armyworm = sum(incidence_armyworm),
            percent_incidence_armyworm = (sum_incidence_armyworm / total_count_samples_armyworm) * percent_100)

#(summary_armyworm)


# summary_armyworm %>%
#   ggplot(aes(sum_incidence_armyworm)) +
#   geom_density()
# 
# summary_armyworm %>%
#   ggplot(aes(sum_incidence_armyworm)) +
#   geom_histogram()
# 
# summary_armyworm %>%
#   ggplot(aes(sample=sum_incidence_armyworm)) +
#   stat_qq() +
#   stat_qq_line()

summary_armyworm$crop_stage <- 
  factor(summary_armyworm$`Crop Stage`, 
         levels = c("Early Whorl", "Late Whorl", "Maturity", "Mid Whorl", "Seedling (3 - 4 Leaves)",
                    "Silking", "Single Leaf", "Tasseling", "Emergence"),
         labels = c("early_whorl", "late_whorl", "maturity", "mid_whorl", "seedling", 
                    "silking", "single_leaf", "tasseling", "emergence"))

summary_armyworm$order_treat <- ordered(summary_armyworm$Treatment,
                                     levels = c("BRFR", "RFR", "ARFR"),
                                     labels = c("B", "R", "A"))

summary_armyworm$factor_corn <- factor(summary_armyworm$`Corn Type`, 
                                    labels=c("N", "G"), 
                                    levels = c("Non - GM Corn", "GM CORN"))

library("rcompanion")
library("nortest")
library("moments")
library("stats")
library("MASS")
library("agricolae")
library("DescTools")

ggqqplot(summary_armyworm$sum_incidence_armyworm)

# Kolmogorov Smirnov test for normality samples > 50
ks_test_armyworm <- ks.test(summary_armyworm$sum_incidence_armyworm, 'pnorm')

# Anderson-Darling Test is a goodness-of-fit test that determines how well your data fits a given distribution. 
# This test is most typically used to see if your data follow a normal distribution or not.
ad_test_armyworm <- ad.test(summary_armyworm$sum_incidence_armyworm)

skew_armyworm <- skewness(summary_armyworm$sum_incidence_armyworm)
kurt_armyworm <- kurtosis(summary_armyworm$sum_incidence_armyworm)

# Jarque-Bera Normality Test performs a goodness-of-fit test that 
# determines whether or not sample data have skewness and 
# kurtosis that matches a normal distribution.
jarq_armyworm <- jarque.test(summary_armyworm$sum_incidence_armyworm)


# Kruskall Wallis applied to one-way, non-normal data with more than two groups
kruskal_fertilizer_armyworm <- kruskal.test(sum_incidence_armyworm ~ order_treat, summary_armyworm)

# Mann-Whitney U test for differences between two independent treatments or conditions.   
# The continuous response variable of interest is not normally distributed.
utest_corn_armyworm <- wilcox.test(sum_incidence_armyworm ~ factor_corn, summary_armyworm)

# Null hypothesis is variances across all samples are equal. 
# Leveneâs test is an alternative to Bartlettâs test when the data is not normally distributed.
levenes_fertilizer_armyworm <- leveneTest(sum_incidence_armyworm ~ Treatment, summary_armyworm)
levenes_corntype_armyworm <- leveneTest(sum_incidence_armyworm ~ `Corn Type`, summary_armyworm)
levenes_municipality_armyworm <- leveneTest(sum_incidence_armyworm ~ Municipality, summary_armyworm)
levenes_province_armyworm <- leveneTest(sum_incidence_armyworm ~ Province, summary_armyworm)
levenes_fert_corn_armyworm <- leveneTest(sum_incidence_armyworm ~ interaction(Treatment, `Corn Type`), summary_armyworm)
levenes_stage_armyworm <- leveneTest(sum_incidence_armyworm ~ crop_stage, summary_armyworm)


# AnOVa
aov_fert_armyworm <- aov(sum_incidence_armyworm ~ order_treat, summary_armyworm)
aov_province_armyworm <- aov(sum_incidence_armyworm ~ Province, summary_armyworm)

ttest_corn_armyworm <- t.test(sum_incidence_armyworm ~ factor_corn, summary_armyworm)

summmary_stats_armyworm_province <- 
  summary_armyworm %>% 
  group_by(Province) %>% 
  get_summary_stats(type="mean")
aov_province_armyworm %>% summary()

summmary_stats_armyworm_corntype <- 
  summary_armyworm %>% 
  group_by(`Corn Type`) %>% 
  get_summary_stats(type="mean")
ttest_corn_armyworm


summmary_stats_armyworm_fert <- 
  summary_armyworm %>% 
  group_by(order_treat) %>% 
  get_summary_stats(type="mean")
aov_fert_armyworm %>% summary()


# Kruskall-Wallis on corn type
kruskall_corn_armyworm <- kruskal.test(sum_incidence_armyworm ~ factor_corn, summary_armyworm)

# Two way AnOVa
twoway_fert_corn_armyworm <- aov(sum_incidence_armyworm ~ order_treat + factor_corn, summary_armyworm) 
tukey_fert_corn_armyworm <- TukeyHSD(twoway_fert_corn_armyworm)

# AnOVa with Interaction
aov_fert_corn_inter_armyworm <- aov(sum_incidence_armyworm ~ order_treat*factor_corn, summary_armyworm)
tukey_fert_corn_inter_armyworm <- TukeyHSD(aov_fert_corn_inter_armyworm)



ttest_corn_armyworm
twoway_fert_corn_armyworm %>% summary()
kruskall_corn_armyworm
print(tukey_fert_corn_armyworm)
aov_fert_corn_inter_armyworm %>% summary()
print(tukey_fert_corn_inter_armyworm)

twoway_fert_corn_armyworm_letters <- multcompLetters4(twoway_fert_corn_armyworm, tukey_fert_corn_armyworm)
interaction_fert_corn_armyworm_letters <- multcompLetters4(aov_fert_corn_inter_armyworm, tukey_fert_corn_inter_armyworm)
# detach("package:onewaytests", unload = TRUE)

armyworm_ev <-
  armyworm_joined_ev %>%
  mutate(Province = factor(Province),
         Municipality = factor(Municipality),
         crop_stage = factor(`Crop Stage`),
         treatment = factor(Treatment),
         corn_type = factor(`Corn Type`, labels=c("N", "G"), levels=c("Non - GM Corn", "GM CORN")),
         incidence_armyworm = as.numeric(incidence_armyworm))


cor_armyworm_wind_incidence <- cor(armyworm_ev$mean_wind, armyworm_ev$incidence_armyworm, method = "pearson", use = "pairwise.complete.obs")

cor_armyworm_temp_incidence <- cor(armyworm_ev$mean_temp, armyworm_ev$incidence_armyworm, method = "pearson", use = "pairwise.complete.obs")

cor_armyworm_humid_incidence <- cor(armyworm_ev$mean_humid, armyworm_ev$incidence_armyworm, method = "pearson", use = "pairwise.complete.obs")

cor_armyworm_rain_incidence <- cor(armyworm_ev$mean_rain, armyworm_ev$incidence_armyworm, method = "pearson", use = "pairwise.complete.obs")


# lm
lm_rain_armyworm  <- lm(incidence_armyworm ~ mean_rain, data = armyworm_joined_ev)
lm_wind_armyworm  <- lm(incidence_armyworm ~ mean_wind, data = armyworm_joined_ev)
lm_humid_armyworm <- lm(incidence_armyworm ~ mean_humid, data = armyworm_joined_ev)
lm_temp_armyworm  <- lm(incidence_armyworm ~ mean_temp, data = armyworm_joined_ev)


temp_armyworm_eqn <- sprintf(
    "italic(y) == %.3g + %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_temp_armyworm)[1],
    coef(lm_temp_armyworm)[2],
    round(cor_armyworm_temp_incidence, 3)
  )

rain_armyworm_eqn <- sprintf(
    "italic(y) == %.3g + %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_rain_armyworm)[1],
    coef(lm_rain_armyworm)[2],
    round(cor_armyworm_rain_incidence, 3)
  )


wind_armyworm_eqn <- sprintf(
    "italic(y) == %.3g %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_wind_armyworm)[1],
    coef(lm_wind_armyworm)[2],
    round(cor_armyworm_wind_incidence, 3)
  )


humid_armyworm_eqn <- sprintf(
    "italic(y) == %.3g + %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_humid_armyworm)[1],
    coef(lm_humid_armyworm)[2],
    round(cor_armyworm_humid_incidence, 3)
  )


armyworm_joined_ev %>%
  ggplot(aes(mean_temp, incidence_armyworm)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.5) +
  labs(x = "Monthly Average Temperature (C)", 
       y = "Incidence Armyworm",
       title = "Temperature vs Armyworm") +
  annotate("label", x = 28, y = 12,  
           label = temp_armyworm_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_temperature", filename = "Armyworm vs Temperature.png")


armyworm_joined_ev %>%
  ggplot(aes(mean_wind, incidence_armyworm)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.5) +
  labs(x = "Monthly Average Wind Speed (km/h)", 
       y = "Incidence Armyworm",
       title = "Wind Speed vs Armyworm") +
  annotate("label", x = 7.5, y = 12,  
           label = wind_armyworm_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_wind_speed", filename = "Armyworm vs Wind.png")


armyworm_joined_ev %>%
  ggplot(aes(mean_humid, incidence_armyworm)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.7) +
  labs(x = "Monthly Average Humidity (%)", 
       y = "Incidence Armyworm",
       title = "Humidity vs Armyworm") +
  annotate("label", x = 60, y = 12,  
           label = humid_armyworm_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_humidity", filename = "Armyworm vs Humidity.png")


armyworm_joined_ev %>%
  ggplot(aes(mean_rain, incidence_armyworm)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.5) +
  labs(x = "Monthly Average Rainfall (mm)", 
       y = "Incidence Armyworm",
       title = "Rainfall vs Armyworm") +
  annotate("label", x = 0.5, y = 12,  
           label = rain_armyworm_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_rainfall", filename = "Armyworm vs Rain.png")


# by corn type Mann-Whitney U test
utest_corn_armyworm <- wilcox.test(percent_incidence_armyworm ~ factor_corn, summary_armyworm)

DunnTest_corn_type_armyworm <- DunnTest(percent_incidence_armyworm ~ factor_corn, summary_armyworm)
dunn_armyworm_corn_type_groups <- dunnTest(percent_incidence_armyworm ~ factor_corn, summary_armyworm,
                                         method="none")
dunn_armyworm_corn_type_groups <- dunn_armyworm_corn_type_groups$res
cld_armyworm_corn_type <- cldList(comparison = dunn_armyworm_corn_type_groups$Comparison,
                                p.value = dunn_armyworm_corn_type_groups$P.adj,
                                threshold = 0.05)[1:2]
cld_armyworm_corn_type$factor_corn <- cld_armyworm_corn_type$Group
cld_armyworm_corn_type <- as.data.frame.list(cld_armyworm_corn_type)

summary_armyworm_corntype_bp <-
  summary_armyworm %>% 
  group_by(factor_corn) %>% 
  summarise(w=mean(percent_incidence_armyworm), sd = mean_sd(percent_incidence_armyworm)) %>% 
  arrange(desc(w)) %>% 
  left_join(cld_armyworm_corn_type, by=c("factor_corn"))

summary_armyworm %>%
  ggplot(aes(factor_corn, percent_incidence_armyworm)) + 
  geom_boxplot(aes(fill=factor_corn), show.legend=FALSE) +
  geom_text(data = summary_armyworm_corntype_bp, aes(label = Letter,
                y = sd$ymax), vjust = -1, hjust = -0.5, color="red", size = 5) +
  geom_text(data = summary_armyworm_corntype_bp, aes(label = round(w, 2), y = sd$ymax-5), vjust = -1, hjust=-1, alpha = 0.75, color = "darkblue") +
  labs(x = "Corn Type (GM or Non-GM)", 
       y = "Percent Incidence Armyworm",
       title = "Effect of Corn Type to Armyworm Incidence") +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_corn_type", filename = "Armyworm Percent Incidence vs Corn Type.png")



# by fertilizer treatment rate
summary_armyworm_fert_bp <-
  summary_armyworm %>% 
  group_by(order_treat) %>% 
  summarise(w=mean(percent_incidence_armyworm), sd = mean_sd(percent_incidence_armyworm)) %>% 
  arrange(desc(w))

summary_armyworm_fert_bp$treatment_cld <- 
  as.data.frame.list(twoway_fert_corn_armyworm_letters$order_treat)$Letters

summary_armyworm %>%
  ggplot(aes(order_treat, percent_incidence_armyworm)) + 
  geom_boxplot(aes(fill = order_treat), show.legend = FALSE) +
  geom_text(data = summary_armyworm_fert_bp, aes(label = treatment_cld,
                y = w + sd$ymax), hjust = -1, vjust = -1, color="red", size = 5) +
  geom_text(data = summary_armyworm_fert_bp, aes(label = round(w, 2), y = sd$y), vjust = -3, hjust = -1, alpha = 0.75, color = "darkblue") +
  labs(x = "Fertilizer Treatment Rate", 
       y = "Percent Incidence Armyworm",
       title = "Effect of Fertilizer Treatment Rate on Armyworm Incidence") + 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1") 
ggsave(path = "../ggplot_files/pests_fertilizer_rate", filename = "Armyworm Percent Incidence vs Fertilizer Treatment.png")

# by province
# kruskall-wallis test by province
attach(summary_armyworm)
kruskal_province_armyworm <- kruskal.test(percent_incidence_armyworm ~ factor(Province), 
                                        summary_armyworm)
DunnTest_province_armyworm <- DunnTest(percent_incidence_armyworm ~ Province, summary_armyworm)
dunn_armyworm_province_groups <- dunnTest(percent_incidence_armyworm ~ factor(Province),
                                         method="bonferroni")
dunn_armyworm_province_groups <- dunn_armyworm_province_groups$res
cld_armyworm_province <- cldList(comparison = dunn_armyworm_province_groups$Comparison,
                                p.value = dunn_armyworm_province_groups$P.adj,
                                threshold = 0.05)[1:2]
cld_armyworm_province$Province <- cld_armyworm_province$Group
cld_armyworm_province <- as.data.frame.list(cld_armyworm_province)

#  values on boxplots geom_text

detach("package:MASS", unload = TRUE)
summary_armyworm_province_bp <-
  summary_armyworm %>% 
  group_by(Province) %>% 
  summarise(w=mean(percent_incidence_armyworm), sd = mean_sd(percent_incidence_armyworm)) %>% 
  arrange(desc(w)) %>%
  fuzzy_left_join(cld_armyworm_province, 
                  by=c("Province"), 
                  match_fun = list(function(x, y) stringdist(x, y) < 2))  %>%
  mutate(Province = Province.x)
  
summary_armyworm_province_bp <- summary_armyworm_province_bp %>% select(-c(Province.x, Province.y))


summary_armyworm <- summary_armyworm %>% left_join(summary_armyworm_province_bp, by=c("Province"))


summary_armyworm %>%
  ggplot(aes(Province, percent_incidence_armyworm)) + 
  geom_boxplot(aes(fill=Province), show.legend = FALSE) +
  geom_text(data = summary_armyworm_province_bp, aes(y = sd$ymax, label = Letter), 
            vjust = -1, hjust = -1, color="red", size = 4) +
  geom_text(data = summary_armyworm_province_bp, aes(label = round(w, 2), y = sd$ymax - 5), 
            vjust = -1, hjust = -1, alpha = 0.75, color = "darkblue") +
  labs(x = "Provinces", 
       y = "Percent Incidence Armyworm",
       title = "Provinces to Armyworm Incidence") + 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1") 
ggsave(path = "../pests_province", filename = "Armyworm Percent Incidence vs Province.png", dpi=plot_dpi)



# by Crop stage
# kruskall-wallis test by corn stage
library("MASS")
attach(summary_armyworm)
kruskal_crop_stage_armyworm<- kruskal.test(percent_incidence_armyworm ~ factor(crop_stage), 
                                        summary_armyworm)
DunnTest_crop_stage_armyworm <- DunnTest(percent_incidence_armyworm ~ crop_stage, summary_armyworm)
dunn_armyworm_crop_stage_groups <- dunnTest(percent_incidence_armyworm ~ factor(crop_stage),
                                         method="bonferroni")
dunn_armyworm_crop_stage_groups <- dunn_armyworm_crop_stage_groups$res
cld_armyworm_crop_stage <- cldList(comparison = dunn_armyworm_crop_stage_groups$Comparison,
                                p.value = dunn_armyworm_crop_stage_groups$P.adj,
                                threshold = 0.05)[1:2]
cld_armyworm_crop_stage$crop_stage <- cld_armyworm_crop_stage$Group
cld_armyworm_crop_stage <- as.data.frame.list(cld_armyworm_crop_stage)

#  values on boxplots geom_text
summary_armyworm_crop_stage_bp <-
  summary_armyworm %>% 
  group_by(crop_stage) %>% 
  summarise(w=mean(percent_incidence_armyworm), sd = mean_sd(percent_incidence_armyworm)) %>% 
  arrange(desc(w)) %>%
  fuzzy_left_join(cld_armyworm_crop_stage, 
                  by=c("crop_stage"), 
                  match_fun = list(function(x, y) stringdist(x, y) < 2))  %>%
  mutate(crop_stage = crop_stage.x) 

detach("package:MASS", unload = TRUE)
summary_armyworm_crop_stage_bp <- summary_armyworm_crop_stage_bp %>% select(-c(crop_stage.x, crop_stage.y))
summary_armyworm <- summary_armyworm %>% left_join(summary_armyworm_crop_stage_bp, by=c("crop_stage")) %>% drop_na()


summary_armyworm %>%
  ggplot(aes(crop_stage, percent_incidence_armyworm)) + 
  geom_boxplot(aes(fill=`Crop Stage`), show.legend=FALSE) +
  geom_text(data = summary_armyworm_crop_stage_bp, aes(label = Letter, y = sd$ymax ), 
            vjust = -1, hjust = -1, color="red", size = 4) +
  geom_text(data = summary_armyworm_crop_stage_bp, aes(label = round(w, 2), y = sd$ymax - 5), 
            vjust = -1, hjust = -0.5, alpha = 0.75, color = "darkblue") +
  scale_x_discrete(limits = crop_growth_stages, labels = stage_labels) +
  labs(x = "Corn Growth Stages", 
       y = "Percent Incidence Armyworm",
       title = "Corn Crop Growth Stages and Armyworm Incidence",
       caption = "Emergence NOT COUNTED") + 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), ) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_crop_stage", filename = "Armyworm Percent Incidence vs Crop Growth Stages.png", dpi=plot_dpi)

detach("package:agricolae", unload = TRUE)
detach("package:rcompanion", unload = TRUE)
detach("package:nortest", unload = TRUE)
detach("package:DescTools", unload = TRUE)
detach("package:stats", unload = TRUE)
```


```Rating of 1 is classified as No damage or No infestation ONLY```
```Corn Planthopper, aphids, Leaf feeders(Armyworm, cutworm)```
```rating of 1 is not included in computation on damage rating and incidence```
```Aphids```
```{r}
# Aphids
aphids_df_ev <- 
  insect_raw %>%
  select(FarmID, `Collection Date`, Province, Municipality, Barangay, `Crop Stage`, Treatment, `Corn Type`, Variety, starts_with("Aphids - Damage Rating ")) %>%
  filter(Municipality != "Santa Rita" & Municipality != "Hilongos" & Municipality != "Tomas Oppus") 

aphids_df_ev$collect_date <- 
  as.Date(aphids_df_ev$`Collection Date`, "%B %d, %Y")

aphids_dmg_ev <-
  aphids_df_ev %>% 
  mutate(Year = year(collect_date), Month = month(collect_date))


aphids_joined_ev <-
  aphids_dmg_ev %>% 
  left_join(monthly_averages, by=c('Year', 'Month')) %>%
  # mutate_at(c(9:28), as.factor) %>%
  rowwise() %>%
    mutate(sum_no = sum(c_across(starts_with("Aphids - Damage Rating ")) == "1"),
           sum_light = sum(c_across(starts_with("Aphids - Damage Rating ")) == "3"),
           sum_moderate = sum(c_across(starts_with("Aphids - Damage Rating ")) == "5"),
           sum_severe = sum(c_across(starts_with("Aphids - Damage Rating ")) == "7"),
           sum_high = sum(c_across(starts_with("Aphids - Damage Rating ")) == "9"),
           average_damage_aphids = ((1 * sum_no) + (3 * sum_light) + (5 * sum_moderate) + (7 * sum_severe) + (9 * sum_high)) / (number_sampled_plants),
           damage_rating_aphids = (((1 * sum_no) + (3 * sum_light) + (5 * sum_moderate) + (7 * sum_severe) + (9 * sum_high)) / (number_sampled_plants * 9)) * percent_100,
           incidence_aphids = ((sum(c_across(sum_light:sum_high))) * percent_100) / number_sampled_plants,
           )

#View(aphids_joined_ev)

summary_aphids <-
  aphids_joined_ev %>%
  group_by(Year, Month, Province, Municipality, `Corn Type`, 
           Barangay, Treatment, `Crop Stage`) %>%
  remove_missing(na.rm=TRUE) %>%
  summarise(total_count_samples_aphids = n() * number_sampled_plants,
            sum_avg_dmg_aphids = sum(average_damage_aphids),
            sum_dmg_rate_aphids = sum(damage_rating_aphids),
            sum_incidence_aphids = sum(incidence_aphids),
            percent_incidence_aphids = (sum_incidence_aphids / total_count_samples_aphids) * percent_100)

# View(summary_aphids)
# 
# 
# summary_aphids %>%
#   ggplot(aes(sum_incidence_aphids)) +
#   geom_density()
# 
# summary_aphids %>%
#   ggplot(aes(sum_incidence_aphids)) +
#   geom_histogram()
# 
# summary_aphids %>%
#   ggplot(aes(sample=sum_incidence_aphids)) +
#   stat_qq() +
#   stat_qq_line()

summary_aphids$crop_stage <- 
  factor(summary_aphids$`Crop Stage`, 
         levels = c("Early Whorl", "Late Whorl", "Maturity", "Mid Whorl", "Seedling (3 - 4 Leaves)",
                    "Silking", "Single Leaf", "Tasseling", "Emergence"),
         labels = c("early_whorl", "late_whorl", "maturity", "mid_whorl", "seedling", 
                    "silking", "single_leaf", "tasseling", "emergence"))

summary_aphids$order_treat <- ordered(summary_aphids$Treatment,
                         levels = c("BRFR", "RFR", "ARFR"),
                         labels = c("B", "R", "A"))

summary_aphids$factor_corn <- factor(labels=c("N", "G"), levels=c("Non - GM Corn", "GM CORN"), summary_aphids$`Corn Type`)

library("nortest")
library("rcompanion")
library("moments")
library("stats")
library("MASS")
library("agricolae")
library("DescTools")


ggqqplot(summary_aphids$sum_incidence_aphids)

# Kolmogorov Smirnov test for normality samples > 50
ks_test_aphids <- ks.test(summary_aphids$sum_incidence_aphids, 'pnorm')

# Anderson-Darling Test is a goodness-of-fit test that determines how well your data fits a given distribution. 
# This test is most typically used to see if your data follow a normal distribution or not.
ad_test_aphids <- ad.test(summary_aphids$sum_incidence_aphids)

skew_aphids <- skewness(summary_aphids$sum_incidence_aphids)
kurt_aphids <- kurtosis(summary_aphids$sum_incidence_aphids)

# Jarque-Bera Normality Test performs a goodness-of-fit test that 
# determines whether or not sample data have skewness and 
# kurtosis that matches a normal distribution.
jarq_aphids <- jarque.test(summary_aphids$sum_incidence_aphids)

# Kruskall Wallis applied to one-way, non-normal data with more than two groups
kruskal_fertilizer_aphids <- kruskal.test(sum_incidence_aphids ~ order_treat, summary_aphids)

# Mann-Whitney U test for differences between two independent treatments or conditions.   
# The continuous response variable of interest is not normally distributed.
utest_corn_aphids <- wilcox.test(sum_incidence_aphids ~ factor_corn, summary_aphids)

# Null hypothesis is variances across all samples are equal. 
# Leveneâs test is an alternative to Bartlettâs test when the data is not normally distributed.
levenes_fertilizer_aphids <- leveneTest(sum_incidence_aphids ~ Treatment, summary_aphids)
levenes_corntype_aphids <- leveneTest(sum_incidence_aphids ~ `Corn Type`, summary_aphids)
levenes_municipality_aphids <- leveneTest(sum_incidence_aphids ~ Municipality, summary_aphids)
levenes_province_aphids <- leveneTest(sum_incidence_aphids ~ Province, summary_aphids)
levenes_fert_corn_aphids <- leveneTest(sum_incidence_aphids ~ interaction(Treatment, `Corn Type`), summary_aphids)
levenes_crop_stage_aphids <- leveneTest(sum_incidence_aphids ~ crop_stage, summary_aphids)


# AnOVa
aov_fert_aphids <- aov(sum_incidence_aphids ~ order_treat, summary_aphids)
aov_corn_aphids <- aov(sum_incidence_aphids ~ factor_corn, summary_aphids)
ttest_corn_aphids <- t.test(sum_incidence_aphids ~ factor_corn, summary_aphids)

# Kruskall-Wallis on corn type
kruskall_corn_aphids <- kruskal.test(sum_incidence_aphids ~ factor_corn, summary_aphids)

# Two way AnOVa
twoway_fert_corn_aphids <- aov(sum_incidence_aphids ~ order_treat + factor_corn, summary_aphids) 
tukey_fert_corn_aphids <- TukeyHSD(twoway_fert_corn_aphids)

# AnOVa with Interaction
aov_fert_corn_inter_aphids <- aov(sum_incidence_aphids ~ order_treat*factor_corn, summary_aphids)
tukey_fert_corn_inter_aphids <- TukeyHSD(aov_fert_corn_inter_aphids)

aov_fert_aphids %>% summary()
aov_corn_aphids %>% summary()

ttest_corn_aphids
twoway_fert_corn_aphids %>% summary()
print(tukey_fert_corn_aphids)
aov_fert_corn_inter_aphids %>% summary()
print(tukey_fert_corn_inter_aphids)

twoway_fert_corn_aphids_letters <- multcompLetters4(twoway_fert_corn_aphids, tukey_fert_corn_aphids)
interaction_fert_corn_aphids_letters <- multcompLetters4(aov_fert_corn_inter_aphids, tukey_fert_corn_inter_aphids)
# detach("package:onewaytests", unload = TRUE)

aphids_ev <-
  aphids_joined_ev %>%
  mutate(Province = factor(Province),
         Municipality = factor(Municipality),
         crop_stage = factor(`Crop Stage`),
         treatment = factor(Treatment),
         corn_type = factor(`Corn Type`, labels=c("N", "G"), levels=c("Non - GM Corn", "GM CORN")),
         incidence_aphids = as.numeric(incidence_aphids))


cor_aphids_wind_incidence <- cor(aphids_ev$mean_wind, aphids_ev$incidence_aphids, method = "pearson", use = "pairwise.complete.obs")

cor_aphids_temp_incidence <- cor(aphids_ev$mean_temp, aphids_ev$incidence_aphids, method = "pearson", use = "pairwise.complete.obs")

cor_aphids_humid_incidence <- cor(aphids_ev$mean_humid, aphids_ev$incidence_aphids, method = "pearson", use = "pairwise.complete.obs")

cor_aphids_rain_incidence <- cor(aphids_ev$mean_rain, aphids_ev$incidence_aphids, method = "pearson", use = "pairwise.complete.obs")


# lm
lm_rain_aphids  <- lm(incidence_aphids ~ mean_rain, data = aphids_joined_ev)
lm_wind_aphids  <- lm(incidence_aphids ~ mean_wind, data = aphids_joined_ev)
lm_humid_aphids <- lm(incidence_aphids ~ mean_humid, data = aphids_joined_ev)
lm_temp_aphids  <- lm(incidence_aphids ~ mean_temp, data = aphids_joined_ev)


temp_aphids_eqn <- sprintf(
    "italic(y) == %.3g + %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_temp_aphids)[1],
    coef(lm_temp_aphids)[2],
    round(cor_aphids_temp_incidence, 3)
  )

rain_aphids_eqn <- sprintf(
    "italic(y) == %.3g + %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_rain_aphids)[1],
    coef(lm_rain_aphids)[2],
    round(cor_aphids_rain_incidence, 3)
  )


wind_aphids_eqn <- sprintf(
    "italic(y) == %.3g + %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_wind_aphids)[1],
    coef(lm_wind_aphids)[2],
    round(cor_aphids_wind_incidence, 3)
  )


humid_aphids_eqn <- sprintf(
    "italic(y) == %.3g + %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_humid_aphids)[1],
    coef(lm_humid_aphids)[2],
    round(cor_aphids_humid_incidence, 3)
  )


aphids_joined_ev %>%
  ggplot(aes(mean_temp, incidence_aphids)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.5) +
  labs(x = "Monthly Average Temperature (C)", 
       y = "Incidence Aphids",
       title = "Temperature vs Aphids") +
  annotate("label", x = 27.5, y = 12,  
           label = temp_aphids_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_temperature", filename = "Aphids vs Temperature.png")


aphids_joined_ev %>%
  ggplot(aes(mean_wind, incidence_aphids)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.5) +
  labs(x = "Monthly Average Wind Speed (km/h)", 
       y = "Incidence Aphids",
       title = "Wind Speed vs Aphids") +
  annotate("label", x = 7.5, y = 8,  
           label = wind_aphids_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_wind_speed", filename = "Aphids vs Wind.png")


aphids_joined_ev %>%
  ggplot(aes(mean_humid, incidence_aphids)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.7) +
  labs(x = "Monthly Average Humidity (%)", 
       y = "Incidence Aphids",
       title = "Humidity vs Aphids") +
  annotate("label", x = 60, y = 8,  
           label = humid_aphids_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_humidity", filename = "Aphids vs Humidity.png")

aphids_joined_ev %>%
  ggplot(aes(mean_rain, incidence_aphids)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.5) +
  labs(x = "Monthly Average Rainfall (mm)", 
       y = "Incidence Aphids",
       title = "Rainfall vs Aphids") +
  annotate("label", x = 0.5, y = 11,  
           label = rain_aphids_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_rainfall", filename = "Aphids vs Rain.png")


# by corn type Mann-Whitney U test
utest_corn_aphids <- wilcox.test(percent_incidence_aphids ~ factor_corn, summary_aphids)

DunnTest_corn_type_aphids <- DunnTest(percent_incidence_aphids ~ factor_corn, summary_aphids)
dunn_aphids_corn_type_groups <- dunnTest(percent_incidence_aphids ~ factor_corn, summary_aphids,
                                         method="none")
dunn_aphids_corn_type_groups <- dunn_aphids_corn_type_groups$res
cld_aphids_corn_type <- cldList(comparison = dunn_aphids_corn_type_groups$Comparison,
                                p.value = dunn_aphids_corn_type_groups$P.adj,
                                threshold = 0.05)[1:2]
cld_aphids_corn_type$factor_corn <- cld_aphids_corn_type$Group
cld_aphids_corn_type <- as.data.frame.list(cld_aphids_corn_type)

summary_aphids_corntype_bp <-
  summary_aphids %>% 
  group_by(factor_corn) %>% 
  summarise(w=mean(percent_incidence_aphids), sd = mean_sd(percent_incidence_aphids)) %>% 
  arrange(desc(w)) %>% 
  left_join(cld_aphids_corn_type, by=c("factor_corn"))

summary_aphids %>%
  ggplot(aes(factor_corn, percent_incidence_aphids)) + 
  geom_boxplot(aes(fill=factor_corn), show.legend=FALSE) +
  geom_text(data = summary_aphids_corntype_bp, aes(label = Letter,
                y = sd$ymax), vjust = -1, hjust = -0.5, color="red", size = 5) +
  geom_text(data = summary_aphids_corntype_bp, aes(label = round(w, 2), y = sd$ymax-5), vjust = -1, hjust=-1, alpha = 0.75, color = "darkblue") +
  labs(x = "Corn Type (GM or Non-GM)", 
       y = "Percent Incidence Aphids",
       title = "Effect of Corn Type to Aphids Incidence") +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_corn_type", filename = "Aphids Percent Incidence vs Corn Type.png")


# by fretilizer treatment rate
summary_aphids_fert_bp <-
  summary_aphids %>% 
  group_by(order_treat) %>% 
  summarise(w=mean(percent_incidence_aphids), sd = mean_sd(percent_incidence_aphids)) %>% 
  arrange(desc(w))

summary_aphids_fert_bp$treatment_cld <- 
  as.data.frame.list(twoway_fert_corn_aphids_letters$order_treat)$Letters

summary_aphids %>%
  ggplot(aes(order_treat, percent_incidence_aphids)) + 
  geom_boxplot(aes(fill=order_treat), show.legend = FALSE) +
  geom_text(data = summary_aphids_fert_bp, aes(label = treatment_cld,
                y = w + sd$ymax), vjust = -1, hjust = -1, color="red", size = 5) +
  geom_text(data = summary_aphids_fert_bp, aes(label = round(w, 2), y = sd$y), vjust = -1, hjust = -1, alpha = 0.75, color = "darkblue") +
  labs(x = "Fertilizer Treatment Rate", 
       y = "Percent Incidence Aphids",
       title = "Effect of Fertilizer Treatment Rate on Aphids Incidence") + 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_fertilizer_rate", filename = "Aphids Percent Incidence vs Fertilizer Treatment.png")

# by province
# kruskall-wallis test by province
attach(summary_aphids)
kruskal_province_aphids<- kruskal.test(percent_incidence_aphids ~ factor(Province), 
                                        summary_aphids)
DunnTest_province_aphids <- DunnTest(percent_incidence_aphids ~ Province, summary_aphids)
dunn_aphids_province_groups <- dunnTest(percent_incidence_aphids ~ factor(Province),
                                         method="bonferroni")
dunn_aphids_province_groups <- dunn_aphids_province_groups$res
cld_aphids_province <- cldList(comparison = dunn_aphids_province_groups$Comparison,
                                p.value = dunn_aphids_province_groups$P.adj,
                                threshold = 0.05)[1:2]
cld_aphids_province$Province <- cld_aphids_province$Group
cld_aphids_province <- as.data.frame.list(cld_aphids_province)

#  values on boxplots geom_text

detach("package:MASS", unload = TRUE)
summary_aphids_province_bp <-
  summary_aphids %>% 
  group_by(Province) %>% 
  summarise(w=mean(percent_incidence_aphids), sd = mean_sd(percent_incidence_aphids)) %>% 
  arrange(desc(w)) %>%
  fuzzy_left_join(cld_aphids_province, 
                  by=c("Province"), 
                  match_fun = list(function(x, y) stringdist(x, y) < 2))  %>%
  mutate(Province = Province.x)
  
summary_aphids_province_bp <- summary_aphids_province_bp %>% select(-c(Province.x, Province.y))


summary_aphids <- summary_aphids %>% left_join(summary_aphids_province_bp, by=c("Province"))


summary_aphids %>%
  ggplot(aes(Province, percent_incidence_aphids)) + 
  geom_boxplot(aes(fill=Province), show.legend = FALSE) +
  geom_text(data = summary_aphids_province_bp, aes(y = sd$ymax, label = Letter), 
            vjust = -1, hjust = -0.5, color="red", size = 4) +
  geom_text(data = summary_aphids_province_bp, aes(label = round(w, 2), y = sd$ymax - 5), 
            vjust = -1, hjust = -0.5, alpha = 0.75, color = "darkblue") +
  labs(x = "Provinces", 
       y = "Percent Incidence Aphids",
       title = "Provinces to Aphids Incidence") + 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1") 
ggsave(path = "../pests_province", filename = "Aphids Percent Incidence vs Province.png", dpi=plot_dpi)



# by Crop stage
# kruskall-wallis test by corn stage
library("MASS")
attach(summary_aphids)
kruskal_crop_stage_aphids<- kruskal.test(percent_incidence_aphids ~ factor(crop_stage), 
                                        summary_aphids)
DunnTest_crop_stage_aphids <- DunnTest(percent_incidence_aphids ~ crop_stage, summary_aphids)
dunn_aphids_crop_stage_groups <- dunnTest(percent_incidence_aphids ~ factor(crop_stage),
                                         method="bonferroni")
dunn_aphids_crop_stage_groups <- dunn_aphids_crop_stage_groups$res
cld_aphids_crop_stage <- cldList(comparison = dunn_aphids_crop_stage_groups$Comparison,
                                p.value = dunn_aphids_crop_stage_groups$P.adj,
                                threshold = 0.05)[1:2]
cld_aphids_crop_stage$crop_stage <- cld_aphids_crop_stage$Group
cld_aphids_crop_stage <- as.data.frame.list(cld_aphids_crop_stage)

#  values on boxplots geom_text
summary_aphids_crop_stage_bp <-
  summary_aphids %>% 
  group_by(crop_stage) %>% 
  summarise(w=mean(percent_incidence_aphids), sd = mean_sd(percent_incidence_aphids)) %>% 
  arrange(desc(w)) %>%
  fuzzy_left_join(cld_aphids_crop_stage, 
                  by=c("crop_stage"), 
                  match_fun = list(function(x, y) stringdist(x, y) < 2))  %>%
  mutate(crop_stage = crop_stage.x) 

detach("package:MASS", unload = TRUE)
summary_aphids_crop_stage_bp <- summary_aphids_crop_stage_bp %>% select(-c(crop_stage.x, crop_stage.y))
summary_aphids <- summary_aphids %>% left_join(summary_aphids_crop_stage_bp, by=c("crop_stage")) %>% drop_na()


summary_aphids %>%
  ggplot(aes(crop_stage, percent_incidence_aphids)) + 
  geom_boxplot(aes(fill=`Crop Stage`), show.legend=FALSE) +
  geom_text(data = summary_aphids_crop_stage_bp, aes(label = Letter, y = sd$ymax ), 
            vjust = -1, hjust = -0.5, color="red", size = 4) +
  geom_text(data = summary_aphids_crop_stage_bp, aes(label = round(w, 2), y = sd$ymax - 5), 
            vjust = -1, hjust = -0.1, alpha = 0.75, color = "darkblue") +
  scale_x_discrete(limits = crop_growth_stages, labels = stage_labels) +
  labs(x = "Corn Growth Stages", 
       y = "Percent Incidence Aphids",
       title = "Corn Crop Growth Stages and Aphids Incidence",
       caption = "Emergence NOT COUNTED") + 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), ) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_crop_stage", filename = "Aphids Percent Incidence vs Crop Growth Stages.png", dpi=plot_dpi)

detach("package:agricolae", unload = TRUE)
detach("package:rcompanion", unload = TRUE)
detach("package:nortest", unload = TRUE)
detach("package:DescTools", unload = TRUE)
detach("package:stats", unload = TRUE)
```


```Fall armyworm has different rating scale (according to dashboard)```
```{r}
# Fall Armyworm
faw_df_ev <- 
  insect_raw %>%
  select(FarmID, `Collection Date`, Province, Municipality, Barangay, `Crop Stage`, Treatment, `Corn Type`, Variety, contains("Fall Armyworm - Damage Rating"))%>%
  filter(Municipality != "Santa Rita" & Municipality != "Hilongos" & Municipality != "Tomas Oppus") 

faw_df_ev$collect_date <- 
  as.Date(faw_df_ev$`Collection Date`, "%B %d, %Y")

faw_dmg_ev <-
  faw_df_ev %>% 
  mutate(Year = year(collect_date), Month = month(collect_date))

faw_joined_ev <-
  faw_dmg_ev %>% 
  left_join(monthly_averages, by=c('Year', 'Month')) %>%
  rowwise() %>%
  mutate(sum_0 = sum(c_across(starts_with("Fall Armyworm - Damage Rating ")) == "0"),
         sum_1 = sum(c_across(starts_with("Fall Armyworm - Damage Rating ")) == "1"),
         sum_2 = sum(c_across(starts_with("Fall Armyworm - Damage Rating ")) == "2"),
         sum_3 = sum(c_across(starts_with("Fall Armyworm - Damage Rating ")) == "3"),
         sum_4 = sum(c_across(starts_with("Fall Armyworm - Damage Rating ")) == "4"),
         sum_5 = sum(c_across(starts_with("Fall Armyworm - Damage Rating ")) == "5"),
         sum_6 = sum(c_across(starts_with("Fall Armyworm - Damage Rating ")) == "6"),
         sum_7 = sum(c_across(starts_with("Fall Armyworm - Damage Rating ")) == "7"),
         sum_8 = sum(c_across(starts_with("Fall Armyworm - Damage Rating ")) == "8"),
         sum_9 = sum(c_across(starts_with("Fall Armyworm - Damage Rating ")) == "9"),
         average_damage_faw = (((1 * sum_1) + (3 * sum_3) + (5 * sum_5) + (7 * sum_7) + (9 * sum_9) + (2 * sum_2) + (4 * sum_4) + (6 * sum_6) + (8 * sum_8)) / (number_sampled_plants)),
         damage_rating_faw = (((1 * sum_1) + (3 * sum_3) + (5 * sum_5) + (7 * sum_7) + (9 * sum_9) + (2 * sum_2) + (4 * sum_4) + (6 * sum_6) + (8 * sum_8)) / (number_sampled_plants * 9)) * percent_100,
         incidence_faw = ((sum(c_across(sum_1:sum_9)))* percent_100) / number_sampled_plants,
         )

#View(faw_joined_ev)

summary_faw <-
  faw_joined_ev %>%
  group_by(Year, Month, Province, Municipality, `Corn Type`,             
           Barangay, Treatment, `Crop Stage`) %>%
  remove_missing(na.rm=TRUE) %>%
  summarise(total_count_samples_faw = n() * number_sampled_plants,
            sum_avg_dmg_faw = sum(average_damage_faw),
            sum_dmg_rate_faw = sum(damage_rating_faw),
            sum_incidence_faw = sum(incidence_faw),
            percent_incidence_faw = (sum_incidence_faw / total_count_samples_faw) * percent_100)

#View(summary_faw)

# summary_faw %>%
#   ggplot(aes(percent_incidence_faw)) +
#   geom_density()
# 
# summary_faw %>%
#   ggplot(aes(percent_incidence_faw)) +
#   geom_histogram()
# 
# summary_faw %>%
#   ggplot(aes(sample=percent_incidence_faw)) +
#   stat_qq() +
#   stat_qq_line()

summary_faw$crop_stage <- 
  factor(summary_faw$`Crop Stage`, 
         levels = c("Early Whorl", "Late Whorl", "Maturity", "Mid Whorl", "Seedling (3 - 4 Leaves)",
                    "Silking", "Single Leaf", "Tasseling", "Emergence"),
         labels = c("early_whorl", "late_whorl", "maturity", "mid_whorl", "seedling", 
                    "silking", "single_leaf", "tasseling", "emergence"))

summary_faw$order_treat <- ordered(summary_faw$Treatment,
                         levels = c("BRFR", "RFR", "ARFR"),
                         labels = c("B", "R", "A"))

summary_faw$factor_corn <- factor(labels=c("N", "G"), levels=c("Non - GM Corn", "GM CORN"), summary_faw$`Corn Type`)

library("nortest")
library("rcompanion")
library("moments")
library("stats")
library("MASS")
library("agricolae")
library("DescTools")


ggqqplot(summary_faw$percent_incidence_faw)

# Kolmogorov Smirnov test for normality samples > 50
ks_test_faw <- ks.test(summary_faw$percent_incidence_faw, 'pnorm')

# Anderson-Darling Test is a goodness-of-fit test that determines how well your data fits a given distribution. 
# This test is most typically used to see if your data follow a normal distribution or not.
ad_test_faw <- ad.test(summary_faw$percent_incidence_faw)

skew_faw <- skewness(summary_faw$percent_incidence_faw)
kurt_faw <- kurtosis(summary_faw$percent_incidence_faw)

# Jarque-Bera Normality Test performs a goodness-of-fit test that 
# determines whether or not sample data have skewness and 
# kurtosis that matches a normal distribution.
jarq_faw <- jarque.test(summary_faw$percent_incidence_faw)

# Kruskall Wallis applied to one-way, non-normal data with more than two groups
kruskal_fertilizer_faw <- kruskal.test(percent_incidence_faw ~ order_treat, summary_faw)

# Mann-Whitney U test for differences between two independent treatments or conditions.   
# The continuous response variable of interest is not normally distributed.
utest_corn_faw <- wilcox.test(percent_incidence_faw ~ factor_corn, summary_faw)

# Null hypothesis is variances across all samples are equal. 
# Leveneâs test is an alternative to Bartlettâs test when the data is not normally distributed.
levenes_fertilizer_faw <- leveneTest(percent_incidence_faw ~ Treatment, summary_faw)
levenes_corntype_faw <- leveneTest(percent_incidence_faw ~ `Corn Type`, summary_faw)
levenes_municipality_faw <- leveneTest(percent_incidence_faw ~ Municipality, summary_faw)
levenes_province_faw <- leveneTest(percent_incidence_faw ~ Province, summary_faw)
levenes_fert_corn_faw <- leveneTest(percent_incidence_faw ~ interaction(Treatment, `Corn Type`), summary_faw)
levenes_crop_stage_faw <- leveneTest(percent_incidence_faw ~ crop_stage, summary_faw)

# AnOVa
aov_fert_faw <- aov(percent_incidence_faw ~ order_treat, summary_faw)
aov_province_faw <- aov(percent_incidence_faw ~ Province, summary_faw)
aov_crop_stage_faw <- aov(percent_incidence_faw ~ crop_stage, summary_faw)

ttest_corn_faw <- t.test(percent_incidence_faw ~ factor_corn, summary_faw)


summmary_stats_faw_province <- 
  summary_faw %>% 
  group_by(Province) %>% 
  get_summary_stats(type="mean")
aov_province_faw %>% summary()

summmary_stats_faw_corntype <- 
  summary_faw %>% 
  group_by(`Corn Type`) %>% 
  get_summary_stats(type="mean")
ttest_corn_faw


summmary_stats_faw_fert <- 
  summary_faw %>% 
  group_by(order_treat) %>% 
  get_summary_stats(type="mean")
aov_fert_faw %>% summary()

aov_fert_faw %>% summary()
aov_province_faw %>% summary()
ttest_corn_faw
# # Kruskall-Wallis on corn type
# kruskall_corn_faw <- kruskal.test(percent_incidence_faw ~ factor_corn, summary_faw)

# Two way AnOVa
twoway_fert_corn_faw <- aov(percent_incidence_faw ~ order_treat + factor_corn, summary_faw) 
tukey_fert_corn_faw <- TukeyHSD(twoway_fert_corn_faw)
tukey_stage_faw <- TukeyHSD(aov_crop_stage_faw)

# AnOVa with Interaction
aov_fert_corn_inter_faw <- aov(percent_incidence_faw ~ order_treat*factor_corn, summary_faw)
tukey_fert_corn_inter_faw <- TukeyHSD(aov_fert_corn_inter_faw)



# Results print
aov_fert_faw %>% summary()
ttest_corn_faw
aov_corn_faw %>% summary()

twoway_fert_corn_faw %>% summary()
kruskal_fertilizer_faw
utest_corn_faw

print(tukey_fert_corn_faw)
aov_fert_corn_inter_faw %>% summary()
print(tukey_fert_corn_inter_faw)

twoway_fert_corn_faw_letters <- multcompLetters4(twoway_fert_corn_faw, tukey_fert_corn_faw)
interaction_fert_corn_faw_letters <- multcompLetters4(aov_fert_corn_inter_faw, tukey_fert_corn_inter_faw)
# detach("package:onewaytests", unload = TRUE)

faw_ev <-
  faw_joined_ev %>%
  mutate(Province = factor(Province),
         Municipality = factor(Municipality),
         crop_stage = factor(`Crop Stage`),
         treatment = factor(Treatment),
         corn_type = factor(`Corn Type`, labels=c("N", "G"), levels=c("Non - GM Corn", "GM CORN")),
         incidence_faw = as.numeric(incidence_faw))


cor_faw_wind_incidence <- cor(faw_ev$mean_wind, faw_ev$incidence_faw, method = "pearson", use = "pairwise.complete.obs")

cor_faw_temp_incidence <- cor(faw_ev$mean_temp, faw_ev$incidence_faw, method = "pearson", use = "pairwise.complete.obs")

cor_faw_humid_incidence <- cor(faw_ev$mean_humid, faw_ev$incidence_faw, method = "pearson", use = "pairwise.complete.obs")

cor_faw_rain_incidence <- cor(faw_ev$mean_rain, faw_ev$incidence_faw, method = "pearson", use = "pairwise.complete.obs")

# lm
lm_rain_faw  <- lm(incidence_faw ~ mean_rain, data = faw_joined_ev)
lm_wind_faw  <- lm(incidence_faw ~ mean_wind, data = faw_joined_ev)
lm_humid_faw <- lm(incidence_faw ~ mean_humid, data = faw_joined_ev)
lm_temp_faw  <- lm(incidence_faw ~ mean_temp, data = faw_joined_ev)


temp_faw_eqn <- sprintf(
    "italic(y) == %.3g + %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_temp_faw)[1],
    coef(lm_temp_faw)[2],
    round(cor_faw_temp_incidence, 3)
  )

rain_faw_eqn <- sprintf(
    "italic(y) == %.3g %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_rain_faw)[1],
    coef(lm_rain_faw)[2],
    round(cor_faw_rain_incidence, 3)
  )


wind_faw_eqn <- sprintf(
    "italic(y) == %.3g %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_wind_faw)[1],
    coef(lm_wind_faw)[2],
    round(cor_faw_wind_incidence, 3)
  )


humid_faw_eqn <- sprintf(
    "italic(y) == %.3g %.3g * italic(x) * ',' ~~ r ~ '=' ~ %.2g",
    coef(lm_humid_faw)[1],
    coef(lm_humid_faw)[2],
    round(cor_faw_humid_incidence, 3)
  )


faw_joined_ev %>%
  ggplot(aes(mean_temp, incidence_faw)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.5) +
  labs(x = "Monthly Average Temperature (C)", 
       y = "Incidence FAW",
       title = "Temperature vs FAW") +
  annotate("label", x = 27.5, y = 25,  
           label = temp_faw_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_temperature", filename = "FAW vs Temperature.png")


faw_joined_ev %>%
  ggplot(aes(mean_wind, incidence_faw)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.5) +
  labs(x = "Monthly Average Wind Speed (km/h)", 
       y = "Incidence FAW",
       title = "Wind Speed vs FAW") +
  annotate("label", x = 7.5, y = 25,  
           label = wind_faw_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_wind_speed", filename = "FAW vs Wind.png")


faw_joined_ev %>%
  ggplot(aes(mean_humid, incidence_faw)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.7) +
  labs(x = "Monthly Average Humidity (%)", 
       y = "Incidence FAW",
       title = "Humidity vs FAW") +
  annotate("label", x = 60, y = 35,  
           label = humid_faw_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_humidity", filename = "FAW vs Humidity.png")

faw_joined_ev %>%
  ggplot(aes(mean_rain, incidence_faw)) +
  geom_point(color = "gray", show.legend = FALSE) +
  geom_smooth(formula = "y~x", method="lm", se=FALSE, size = 1.5) +
  labs(x = "Monthly Average Rainfall (mm)", 
       y = "Incidence FAW",
       title = "Rainfall vs FAW") +
  annotate("label", x = 0.4, y = 25,  
           label = rain_faw_eqn,
           parse = TRUE, color = "red", size = 5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_rainfall", filename = "FAW vs Rain.png")

# by corn type T-test
ttest_corn_faw <- t.test(percent_incidence_faw ~ factor_corn, summary_faw)

DunnTest_corn_type_faw <- DunnTest(percent_incidence_faw ~ factor_corn, summary_faw)
dunn_faw_corn_type_groups <- dunnTest(percent_incidence_faw ~ factor_corn, summary_faw,
                                         method="none")
dunn_faw_corn_type_groups <- dunn_faw_corn_type_groups$res
cld_faw_corn_type <- cldList(comparison = dunn_faw_corn_type_groups$Comparison,
                                p.value = dunn_faw_corn_type_groups$P.adj,
                                threshold = 0.05)[1:2]
cld_faw_corn_type$factor_corn <- cld_borer_corn_type$Group
cld_faw_corn_type <- as.data.frame.list(cld_borer_corn_type)

summary_faw_corntype_bp <-
  summary_faw %>% 
  group_by(factor_corn) %>% 
  summarise(w=mean(percent_incidence_faw), sd = mean_sd(percent_incidence_faw)) %>% 
  arrange(desc(w)) %>%
  left_join(cld_faw_corn_type, by=c("factor_corn"))

summary_faw %>%
  ggplot(aes(factor_corn, percent_incidence_faw)) + 
  geom_boxplot(aes(fill=factor_corn), show.legend=FALSE) +
  geom_text(data = summary_faw_corntype_bp, aes(label = Letter,
                y = sd$ymax), vjust = -1, hjust = -0.5, color="red", size = 5) +
  geom_text(data = summary_faw_corntype_bp, aes(label = round(w, 2), y = sd$ymax-5), vjust = -1, hjust=-1, alpha = 0.75, color = "darkblue") +
  labs(x = "Corn Type (GM or Non-GM)", 
       y = "Percent Incidence FAW",
       title = "Effect of Corn Type to FAW Incidence") +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_corn_type", filename = "FAW Percent Incidence vs Corn Type.png", dpi=plot_dpi)


# by fertilizer treatment rate

summary_faw_fert_bp <-
  summary_faw %>% 
  group_by(order_treat) %>% 
  summarise(w=mean(percent_incidence_faw), sd = mean_sd(percent_incidence_faw)) %>% 
  arrange(desc(w))

summary_faw_fert_bp$treatment_cld <- 
  as.data.frame.list(twoway_fert_corn_faw_letters$order_treat)$Letters

summary_faw %>%
  ggplot(aes(order_treat, percent_incidence_faw)) + 
  geom_boxplot(aes(fill=order_treat), show.legend = FALSE) +
  geom_text(data = summary_faw_fert_bp, aes(label = treatment_cld,
                y = w + sd$y), vjust = -1, hjust = -1, color="red", size = 5) +
  geom_text(data = summary_faw_fert_bp, aes(label = round(w, 2), y = sd$y), vjust = -5, hjust = -1, alpha = 0.75, color = "darkblue") +
  labs(x = "Fertilizer Treatment Rate", 
       y = "Percent Incidence FAW",
       title = "Effect of Fertilizer Treatment Rate on FAW Incidence") + 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_fertilizer_rate", filename = "FAW Percent Incidence vs Fertilizer Treatment.png")

# by province
# kruskall-wallis test by province
attach(summary_faw)
kruskal_province_faw<- kruskal.test(percent_incidence_faw ~ factor(Province), 
                                        summary_faw)
DunnTest_province_faw <- DunnTest(percent_incidence_faw ~ Province, summary_faw)
dunn_faw_province_groups <- dunnTest(percent_incidence_faw ~ factor(Province),
                                         method="bonferroni")
dunn_faw_province_groups <- dunn_faw_province_groups$res
cld_faw_province <- cldList(comparison = dunn_faw_province_groups$Comparison,
                                p.value = dunn_faw_province_groups$P.adj,
                                threshold = 0.05)[1:2]
cld_faw_province$Province <- cld_faw_province$Group
cld_faw_province <- as.data.frame.list(cld_faw_province)

#  values on boxplots geom_text

detach("package:MASS", unload = TRUE)
summary_faw_province_bp <-
  summary_faw %>% 
  group_by(Province) %>% 
  summarise(w=mean(percent_incidence_faw), sd = mean_sd(percent_incidence_faw)) %>% 
  arrange(desc(w)) %>%
  fuzzy_left_join(cld_faw_province, 
                  by=c("Province"), 
                  match_fun = list(function(x, y) stringdist(x, y) < 2))  %>%
  mutate(Province = Province.x)
  
summary_faw_province_bp <- summary_faw_province_bp %>% select(-c(Province.x, Province.y))


summary_faw <- summary_faw %>% left_join(summary_faw_province_bp, by=c("Province"))


summary_faw %>%
  ggplot(aes(Province, percent_incidence_faw)) + 
  geom_boxplot(aes(fill=Province), show.legend = FALSE) +
  geom_text(data = summary_faw_province_bp, aes(y = sd$ymax, label = Letter), 
            vjust = -1, hjust = -0.5, color="red", size = 4) +
  geom_text(data = summary_faw_province_bp, aes(label = round(w, 2), y = sd$ymax - 5), 
            vjust = -1, hjust = -0.5, alpha = 0.75, color = "darkblue") +
  labs(x = "Provinces", 
       y = "Percent Incidence FAW",
       title = "Provinces to FAW Incidence") + 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_brewer(palette = "Pastel1") 
ggsave(path = "../pests_province", filename = "FAW Percent Incidence vs Province.png", dpi=plot_dpi)



# by Crop stage
# anova by corn stage
tukey_crop_stage_faw_letters <- multcompLetters4(aov_crop_stage_faw, tukey_stage_faw)

summary_faw_crop_stage_bp <-
  summary_faw %>% 
  group_by(crop_stage) %>% 
  summarise(w=mean(percent_incidence_faw), sd = mean_sd(percent_incidence_faw)) %>% 
  arrange(desc(w))

summary_faw_crop_stage_bp$crop_stage_cld <- 
  as.data.frame.list(tukey_crop_stage_faw_letters$crop_stage)$Letters

summary_faw %>%
  ggplot(aes(crop_stage, percent_incidence_faw)) + 
  geom_boxplot(aes(fill=`Crop Stage`), show.legend=FALSE) +
  geom_text(data = summary_faw_crop_stage_bp, aes(label = crop_stage_cld, y = sd$ymax ), 
            vjust = -1, hjust = -0.5, color="red", size = 4) +
  geom_text(data = summary_faw_crop_stage_bp, aes(label = round(w, 2), y = sd$ymax - 5), 
            vjust = -0.5, hjust = -0.1, alpha = 0.75, color = "darkblue") +
  scale_x_discrete(limits = crop_growth_stages, labels = stage_labels) +
  labs(x = "Corn Growth Stages", 
       y = "Percent Incidence FAW",
       title = "Corn Crop Growth Stages and FAW Incidence",
       caption = "Emergence NOT COUNTED") + 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), ) +
  scale_fill_brewer(palette = "Pastel1")
ggsave(path = "../pests_crop_stage", filename = "FAW Percent Incidence vs Crop Growth Stages.png", dpi=plot_dpi)

detach("package:nortest", unload = TRUE)
detach("package:agricolae", unload = TRUE)
detach("package:rcompanion", unload = TRUE)
detach("package:DescTools", unload = TRUE)
detach("package:stats", unload = TRUE)
```

```Insect Pests Summary```
```{r}
insects_summary <-
  summary_borer %>%
  full_join(summary_semilooper) %>%
  full_join(summary_cutworm) %>%
  full_join(summary_earworm) %>%
  full_join(summary_hopper) %>%
  full_join(summary_armyworm) %>%
  full_join(summary_aphids) %>%
  full_join(summary_faw)

write.csv(insects_summary, "../Insect PESTS Summary Corn.csv")
```


```{r}
# municipality summaries
# borer
municipality_borer_summary <-
  insects_summary %>%
  select(Year, Municipality, percent_incidence_borer) %>%
  group_by(Year, Municipality)

municipality_borer_mean_summary <- 
  municipality_borer_summary %>%
  summarise(municipality_mean_incidence = mean(percent_incidence_borer)) 

municipality_yearly_incidence_summary_borer <-
  municipality_borer_mean_summary %>%
  arrange(desc(municipality_mean_incidence))

# semilooper
municipality_semilooper_summary <-
  insects_summary %>%
  select(Year, Municipality, percent_incidence_semilooper) %>%
  group_by(Year, Municipality)

municipality_semilooper_mean_summary <- 
  municipality_semilooper_summary %>%
  summarise(municipality_mean_incidence = mean(percent_incidence_semilooper)) 

municipality_yearly_incidence_summary_semilooper <-
  municipality_semilooper_mean_summary %>%
  arrange(desc(municipality_mean_incidence))

# cutworm
municipality_cutworm_summary <-
  insects_summary %>%
  select(Year, Municipality, percent_incidence_cutworm) %>%
  group_by(Year, Municipality)

municipality_cutworm_mean_summary <- 
  municipality_cutworm_summary %>%
  summarise(municipality_mean_incidence = mean(percent_incidence_cutworm)) 

municipality_yearly_incidence_summary_cutworm <-
  municipality_cutworm_mean_summary %>%
  arrange(desc(municipality_mean_incidence))

# earworm
municipality_earworm_summary <-
  insects_summary %>%
  select(Year, Municipality, percent_incidence_earworm) %>%
  group_by(Year, Municipality)

municipality_earworm_mean_summary <- 
  municipality_earworm_summary %>%
  summarise(municipality_mean_incidence = mean(percent_incidence_earworm)) 

municipality_yearly_incidence_summary_earworm <-
  municipality_earworm_mean_summary %>%
  arrange(desc(municipality_mean_incidence))

# hopper
municipality_hopper_summary <-
  insects_summary %>%
  select(Year, Municipality, percent_incidence_hopper) %>%
  group_by(Year, Municipality)

municipality_hopper_mean_summary <- 
  municipality_hopper_summary %>%
  summarise(municipality_mean_incidence = mean(percent_incidence_hopper)) 

municipality_yearly_incidence_summary_hopper <-
  municipality_hopper_mean_summary %>%
  arrange(desc(municipality_mean_incidence))

# armyworm
municipality_armyworm_summary <-
  insects_summary %>%
  select(Year, Municipality, percent_incidence_armyworm) %>%
  group_by(Year, Municipality)

municipality_armyworm_mean_summary <- 
  municipality_armyworm_summary %>%
  summarise(municipality_mean_incidence = mean(percent_incidence_armyworm)) 

municipality_yearly_incidence_summary_armyworm <-
  municipality_armyworm_mean_summary %>%
  arrange(desc(municipality_mean_incidence))


# aphids
municipality_aphids_summary <-
  insects_summary %>%
  select(Year, Municipality, percent_incidence_aphids) %>%
  group_by(Year, Municipality)

municipality_aphids_mean_summary <- 
  municipality_aphids_summary %>%
  summarise(municipality_mean_incidence = mean(percent_incidence_aphids)) 

municipality_yearly_incidence_summary_aphids <-
  municipality_aphids_mean_summary %>%
  arrange(desc(municipality_mean_incidence))


# faw
municipality_faw_summary <-
  insects_summary %>%
  select(Year, Municipality, percent_incidence_faw) %>%
  group_by(Year, Municipality)

municipality_faw_mean_summary <- 
  municipality_faw_summary %>%
  summarise(municipality_mean_incidence = mean(percent_incidence_faw)) 

municipality_yearly_incidence_summary_faw <-
  municipality_faw_mean_summary %>%
  arrange(desc(municipality_mean_incidence))


insects_summary %>%
  summarise(mean(percent_incidence_borer))

```


```{r}
barangay_hopper_summary <-
  insects_summary %>%
  select(Municipality, Barangay, percent_incidence_hopper) %>%
  group_by(Municipality, Barangay) 

barangay_hopper_mean_summary <-
  barangay_hopper_summary %>%
  summarise(barangay_incidence = mean(percent_incidence_hopper)) %>%
  arrange(desc(barangay_incidence)) 


barangay_hopper_count_summary <- 
  barangay_hopper_summary %>%
  summarise(incidence_count = n()) %>%
  arrange(desc(incidence_count))

```


``` Correlation: Pest Incidence vs Weather Parameters```
```{r}
# faw, hopper, cutworm, armyworm, aphids, borer, earworm, semilooper
library("correlation")

# earworm
earworm_cor_test_wind <- cor_test(earworm_ev, "mean_wind", "incidence_earworm")
earworm_cor_test_temp <- cor_test(earworm_ev, "mean_temp", "incidence_earworm")
earworm_cor_test_humid <- cor_test(earworm_ev, "mean_humid", "incidence_earworm")
earworm_cor_test_rain <- cor_test(earworm_ev, "mean_rain", "incidence_earworm")

corr_earworm_df <- data.frame(
  weather_parameter = c(earworm_cor_test_wind$Parameter1, earworm_cor_test_temp$Parameter1, earworm_cor_test_humid$Parameter1, earworm_cor_test_rain$Parameter1),
  incidence = c(earworm_cor_test_wind$Parameter2, earworm_cor_test_temp$Parameter2, earworm_cor_test_humid$Parameter2, earworm_cor_test_rain$Parameter2),
  r_coef = c(earworm_cor_test_wind$r, earworm_cor_test_temp$r, earworm_cor_test_humid$r, earworm_cor_test_rain$r),
  p_val  = c(earworm_cor_test_wind$p, earworm_cor_test_temp$p, earworm_cor_test_humid$p, earworm_cor_test_rain$p)
) %>% mutate(r_coef = round(r_coef, 3),
             p_val = round(p_val, 4))



# borer
borer_cor_test_wind <- cor_test(borer_ev, "mean_wind", "incidence_borer")
borer_cor_test_temp <- cor_test(borer_ev, "mean_temp", "incidence_borer")
borer_cor_test_humid <- cor_test(borer_ev, "mean_humid", "incidence_borer")
borer_cor_test_rain <- cor_test(borer_ev, "mean_rain", "incidence_borer")

corr_borer_df <- data.frame(
  weather_parameter = c(borer_cor_test_wind$Parameter1, borer_cor_test_temp$Parameter1, borer_cor_test_humid$Parameter1, borer_cor_test_rain$Parameter1),
  incidence = c(borer_cor_test_wind$Parameter2, borer_cor_test_temp$Parameter2, borer_cor_test_humid$Parameter2, borer_cor_test_rain$Parameter2),
  r_coef = c(borer_cor_test_wind$r, borer_cor_test_temp$r, borer_cor_test_humid$r, borer_cor_test_rain$r),
  p_val  = c(borer_cor_test_wind$p, borer_cor_test_temp$p, borer_cor_test_humid$p, borer_cor_test_rain$p)
) %>% mutate(r_coef = round(r_coef, 3),
             p_val = round(p_val, 4))


# semilooper
semilooper_cor_test_wind <- cor_test(semilooper_ev, "mean_wind", "incidence_semilooper")
semilooper_cor_test_temp <- cor_test(semilooper_ev, "mean_temp", "incidence_semilooper")
semilooper_cor_test_humid <- cor_test(semilooper_ev, "mean_humid", "incidence_semilooper")
semilooper_cor_test_rain <- cor_test(semilooper_ev, "mean_rain", "incidence_semilooper")

corr_semilooper_df <- data.frame(
  weather_parameter = c(semilooper_cor_test_wind$Parameter1, semilooper_cor_test_temp$Parameter1, semilooper_cor_test_humid$Parameter1, semilooper_cor_test_rain$Parameter1),
  incidence = c(semilooper_cor_test_wind$Parameter2, semilooper_cor_test_temp$Parameter2, semilooper_cor_test_humid$Parameter2, semilooper_cor_test_rain$Parameter2),
  r_coef = c(semilooper_cor_test_wind$r, semilooper_cor_test_temp$r, semilooper_cor_test_humid$r, semilooper_cor_test_rain$r),
  p_val  = c(semilooper_cor_test_wind$p, semilooper_cor_test_temp$p, semilooper_cor_test_humid$p, semilooper_cor_test_rain$p)
) %>% mutate(r_coef = round(r_coef, 3),
             p_val = round(p_val, 4))


# cutworm
cutworm_cor_test_wind <- cor_test(cutworm_ev, "mean_wind", "incidence_cutworm")
cutworm_cor_test_temp <- cor_test(cutworm_ev, "mean_temp", "incidence_cutworm")
cutworm_cor_test_humid <- cor_test(cutworm_ev, "mean_humid", "incidence_cutworm")
cutworm_cor_test_rain <- cor_test(cutworm_ev, "mean_rain", "incidence_cutworm")

corr_cutworm_df <- data.frame(
  weather_parameter = c(cutworm_cor_test_wind$Parameter1, cutworm_cor_test_temp$Parameter1, cutworm_cor_test_humid$Parameter1, cutworm_cor_test_rain$Parameter1),
  incidence = c(cutworm_cor_test_wind$Parameter2, cutworm_cor_test_temp$Parameter2, cutworm_cor_test_humid$Parameter2, cutworm_cor_test_rain$Parameter2),
  r_coef = c(cutworm_cor_test_wind$r, cutworm_cor_test_temp$r, cutworm_cor_test_humid$r, cutworm_cor_test_rain$r),
  p_val  = c(cutworm_cor_test_wind$p, cutworm_cor_test_temp$p, cutworm_cor_test_humid$p, cutworm_cor_test_rain$p)
) %>% mutate(r_coef = round(r_coef, 3),
             p_val = round(p_val, 4))



# hopper
hopper_cor_test_wind <- cor_test(hopper_ev, "mean_wind", "incidence_hopper")
hopper_cor_test_temp <- cor_test(hopper_ev, "mean_temp", "incidence_hopper")
hopper_cor_test_humid <- cor_test(hopper_ev, "mean_humid", "incidence_hopper")
hopper_cor_test_rain <- cor_test(hopper_ev, "mean_rain", "incidence_hopper")

corr_hopper_df <- data.frame(
  weather_parameter = c(hopper_cor_test_wind$Parameter1, hopper_cor_test_temp$Parameter1, hopper_cor_test_humid$Parameter1, hopper_cor_test_rain$Parameter1),
  incidence = c(hopper_cor_test_wind$Parameter2, hopper_cor_test_temp$Parameter2, hopper_cor_test_humid$Parameter2, hopper_cor_test_rain$Parameter2),
  r_coef = c(hopper_cor_test_wind$r, hopper_cor_test_temp$r, hopper_cor_test_humid$r, hopper_cor_test_rain$r),
  p_val  = c(hopper_cor_test_wind$p, hopper_cor_test_temp$p, hopper_cor_test_humid$p, hopper_cor_test_rain$p)
) %>% mutate(r_coef = round(r_coef, 3),
             p_val = round(p_val, 4))




# aphids
aphids_cor_test_wind <- cor_test(aphids_ev, "mean_wind", "incidence_aphids")
aphids_cor_test_temp <- cor_test(aphids_ev, "mean_temp", "incidence_aphids")
aphids_cor_test_humid <- cor_test(aphids_ev, "mean_humid", "incidence_aphids")
aphids_cor_test_rain <- cor_test(aphids_ev, "mean_rain", "incidence_aphids")

corr_aphids_df <- data.frame(
  weather_parameter = c(aphids_cor_test_wind$Parameter1, aphids_cor_test_temp$Parameter1, aphids_cor_test_humid$Parameter1, aphids_cor_test_rain$Parameter1),
  incidence = c(aphids_cor_test_wind$Parameter2, aphids_cor_test_temp$Parameter2, aphids_cor_test_humid$Parameter2, aphids_cor_test_rain$Parameter2),
  r_coef = c(aphids_cor_test_wind$r, aphids_cor_test_temp$r, aphids_cor_test_humid$r, aphids_cor_test_rain$r),
  p_val  = c(aphids_cor_test_wind$p, aphids_cor_test_temp$p, aphids_cor_test_humid$p, aphids_cor_test_rain$p)
) %>% mutate(r_coef = round(r_coef, 3),
             p_val = round(p_val, 4))



# armyworm
armyworm_cor_test_wind <- cor_test(armyworm_ev, "mean_wind", "incidence_armyworm")
armyworm_cor_test_temp <- cor_test(armyworm_ev, "mean_temp", "incidence_armyworm")
armyworm_cor_test_humid <- cor_test(armyworm_ev, "mean_humid", "incidence_armyworm")
armyworm_cor_test_rain <- cor_test(armyworm_ev, "mean_rain", "incidence_armyworm")

corr_armyworm_df <- data.frame(
  weather_parameter = c(armyworm_cor_test_wind$Parameter1, armyworm_cor_test_temp$Parameter1, armyworm_cor_test_humid$Parameter1, armyworm_cor_test_rain$Parameter1),
  incidence = c(armyworm_cor_test_wind$Parameter2, armyworm_cor_test_temp$Parameter2, armyworm_cor_test_humid$Parameter2, armyworm_cor_test_rain$Parameter2),
  r_coef = c(armyworm_cor_test_wind$r, armyworm_cor_test_temp$r, armyworm_cor_test_humid$r, armyworm_cor_test_rain$r),
  p_val  = c(armyworm_cor_test_wind$p, armyworm_cor_test_temp$p, armyworm_cor_test_humid$p, armyworm_cor_test_rain$p)
) %>% mutate(r_coef = round(r_coef, 3),
             p_val = round(p_val, 4))



# faw
faw_cor_test_wind <- cor_test(faw_ev, "mean_wind", "incidence_faw")
faw_cor_test_temp <- cor_test(faw_ev, "mean_temp", "incidence_faw")
faw_cor_test_humid <- cor_test(faw_ev, "mean_humid", "incidence_faw")
faw_cor_test_rain <- cor_test(faw_ev, "mean_rain", "incidence_faw")

corr_faw_df <- data.frame(
  weather_parameter = c(faw_cor_test_wind$Parameter1, faw_cor_test_temp$Parameter1, faw_cor_test_humid$Parameter1, faw_cor_test_rain$Parameter1),
  incidence = c(faw_cor_test_wind$Parameter2, faw_cor_test_temp$Parameter2, faw_cor_test_humid$Parameter2, faw_cor_test_rain$Parameter2),
  r_coef = c(faw_cor_test_wind$r, faw_cor_test_temp$r, faw_cor_test_humid$r, faw_cor_test_rain$r),
  p_val  = c(faw_cor_test_wind$p, faw_cor_test_temp$p, faw_cor_test_humid$p, faw_cor_test_rain$p)
) %>% mutate(r_coef = round(r_coef, 3),
             p_val = round(p_val, 4))



weather_pest_corr <-
  corr_faw_df %>% 
  full_join(corr_hopper_df) %>% 
  full_join(corr_cutworm_df) %>% 
  full_join(corr_armyworm_df) %>%
  full_join(corr_aphids_df) %>%
  full_join(corr_borer_df) %>%
  full_join(corr_earworm_df) %>%
  full_join(corr_semilooper_df)

weather_pest_corr

write.csv(weather_pest_corr, "Weather_Pest_Correlation.csv")

detach("package:rstatix", unload = TRUE)
detach("package:FSA", unload = TRUE)
detach("package:rcompanion", unload = TRUE)
detach("package:dunn.test", unload = TRUE)
detach("package:ggpubr", unload = TRUE)
detach("package:correlation", unload = TRUE)
```

```By province incidence```
```{r}
library(stats)
library(agricolae)


attach(summary_borer)
levenes_province_borer
kruskal_province_borer     <- kruskal.test(percent_incidence_borer ~ Province, summary_borer)
kruskal_borer_province_groups <- kruskal(percent_incidence_borer, Province, p.adj = "bonferroni")$groups
levenes_stage_borer        <- leveneTest(percent_incidence_borer ~ `Crop Stage`, summary_borer)
kruskal_stage_borer        <- kruskal.test(percent_incidence_borer ~ `Crop Stage`, summary_borer)
kruskal_stage_groups <- kruskal(percent_incidence_borer, crop_stage, p.adj = "bonferroni")$groups
detach(summary_borer)


attach(summary_aphids)
levenes_province_aphids
kruskal_province_aphids   <- kruskal.test(percent_incidence_aphids ~ Province, summary_aphids)
kruskal_aphids_province_groups <- kruskal(percent_incidence_aphids, Province, p.adj = "bonferroni")$groups
levenes_stage_aphids      <- leveneTest(percent_incidence_aphids ~ `Crop Stage`, summary_aphids)
kruskal_stage_aphids      <- kruskal.test(percent_incidence_aphids ~ `Crop Stage`, summary_aphids)
kruskal_stage_groups <- kruskal(percent_incidence_aphids, crop_stage, p.adj = "bonferroni")$groups
detach(summary_aphids)

attach(summary_armyworm)
levenes_province_armyworm
kruskal_province_armyworm   <- kruskal.test(percent_incidence_armyworm ~ Province, summary_armyworm)
kruskal_armyworm_province_groups <- kruskal(percent_incidence_armyworm, Province, p.adj = "bonferroni")$groups
levenes_stage_armyworm      <- leveneTest(percent_incidence_armyworm ~ `Crop Stage`, summary_armyworm)
kruskal_stage_armyworm      <- kruskal.test(percent_incidence_armyworm ~ `Crop Stage`, summary_armyworm)
kruskal_stage_groups <- kruskal(percent_incidence_armyworm, crop_stage, p.adj = "bonferroni")$groups
detach(summary_armyworm)

attach(summary_cutworm)
levenes_province_cutworm
kruskal_province_cutworm   <- kruskal.test(percent_incidence_cutworm ~ Province, summary_cutworm)
kruskal_cutworm_province_groups <- kruskal(percent_incidence_cutworm, Province, p.adj = "bonferroni")$groups
levenes_stage_cutworm        <- leveneTest(percent_incidence_cutworm ~ `Crop Stage`, summary_cutworm)
aov_stage_cutworm    <- aov(percent_incidence_cutworm ~ `Crop Stage`, summary_cutworm)
detach(summary_cutworm)

attach(summary_hopper)
levenes_province_hopper
kruskal_province_hopper   <- kruskal.test(percent_incidence_hopper ~ Province, summary_hopper)
kruskal_hopper_province_groups <- kruskal(percent_incidence_hopper, Province, p.adj = "bonferroni")$groups
levenes_stage_hopper      <- leveneTest(percent_incidence_hopper ~ `Crop Stage`, summary_hopper)
kruskal_stage_hopper      <- kruskal.test(percent_incidence_hopper ~ `Crop Stage`, summary_hopper)
kruskal_stage_groups <- kruskal(percent_incidence_hopper, crop_stage, p.adj = "bonferroni")$groups
detach(summary_hopper)


attach(summary_faw)
levenes_province_faw
kruskal_province_faw   <- kruskal.test(percent_incidence_faw ~ Province, summary_faw)
kruskal_faw_province_groups <- kruskal(percent_incidence_faw, Province, p.adj = "bonferroni")$groups
levenes_stage_faw   <- leveneTest(percent_incidence_faw ~ `Crop Stage`, summary_faw)
aov_stage_faw   <- aov(percent_incidence_faw ~ `Crop Stage`, summary_faw)
detach(summary_faw)


attach(summary_earworm)
levenes_province_earworm
kruskal_province_earworm   <- kruskal.test(percent_incidence_earworm ~ Province, summary_earworm)
kruskal_earworm_province_groups <- kruskal(percent_incidence_earworm, Province, p.adj = "bonferroni")$groups
levenes_stage_earworm      <- leveneTest(percent_incidence_earworm ~ `Crop Stage`, summary_earworm)
kruskal_stage_earworm      <- kruskal.test(percent_incidence_earworm ~ `Crop Stage`, summary_earworm)
kruskal_stage_groups <- kruskal(percent_incidence_earworm, crop_stage, p.adj = "bonferroni")$groups
detach(summary_earworm)


levenes_province_semilooper
aov_province_semilooper     <- aov(percent_incidence_semilooper ~ Province, summary_semilooper)
levenes_stage_semilooper <- leveneTest(percent_incidence_semilooper ~ `Crop Stage`, summary_semilooper)
aov_stage_semilooper   <- aov(percent_incidence_faw ~ `Crop Stage`, summary_faw)


detach("package:stats", unload = T)
```

```Levene's tests on pests```
```{r}
levenes_p_val_fert_hopper <- levenes_fertilizer_hopper$`Pr(>F)`[1]
levenes_f_val_fert_hopper <- levenes_fertilizer_hopper$`F value`[1]

levenes_p_val_corn_hopper <- levenes_corntype_hopper$`Pr(>F)`[1]
levenes_f_val_corn_hopper <- levenes_corntype_hopper$`F value`[1]

levenes_p_val_prov_hopper <- levenes_province_hopper$`Pr(>F)`[1]
levenes_f_val_prov_hopper <- levenes_province_hopper$`F value`[1]

levenes_p_val_stage_hopper <- levenes_stage_hopper$`Pr(>F)`[1]
levenes_f_val_stage_hopper <- levenes_stage_hopper$`F value`[1]

levenes_p_val_fert_borer <- levenes_fertilizer_borer$`Pr(>F)`[1]
levenes_f_val_fert_borer <- levenes_fertilizer_borer$`F value`[1]

levenes_p_val_corn_borer <- levenes_corntype_borer$`Pr(>F)`[1]
levenes_f_val_corn_borer <- levenes_corntype_borer$`F value`[1]

levenes_p_val_prov_borer <- levenes_province_borer$`Pr(>F)`[1]
levenes_f_val_prov_borer <- levenes_province_borer$`F value`[1]

levenes_p_val_stage_borer <- levenes_stage_borer$`Pr(>F)`[1]
levenes_f_val_stage_borer <- levenes_stage_borer$`F value`[1]


levenes_p_val_fert_semilooper <- levenes_fertilizer_semilooper$`Pr(>F)`[1]
levenes_f_val_fert_semilooper <- levenes_fertilizer_semilooper$`F value`[1]

levenes_p_val_corn_semilooper <- levenes_corntype_semilooper$`Pr(>F)`[1]
levenes_f_val_corn_semilooper <- levenes_corntype_semilooper$`F value`[1]

levenes_p_val_prov_semilooper <- levenes_province_semilooper$`Pr(>F)`[1]
levenes_f_val_prov_semilooper <- levenes_province_semilooper$`F value`[1]

levenes_p_val_stage_semilooper <- levenes_stage_semilooper$`Pr(>F)`[1]
levenes_f_val_stage_semilooper <- levenes_stage_semilooper$`F value`[1]

levenes_p_val_fert_faw <- levenes_fertilizer_faw$`Pr(>F)`[1]
levenes_f_val_fert_faw <- levenes_fertilizer_faw$`F value`[1]

levenes_p_val_corn_faw <- levenes_corntype_faw$`Pr(>F)`[1]
levenes_f_val_corn_faw <- levenes_corntype_faw$`F value`[1]

levenes_p_val_prov_faw <- levenes_province_faw$`Pr(>F)`[1]
levenes_f_val_prov_faw <- levenes_province_faw$`F value`[1]

levenes_p_val_crop_stage_faw <- levenes_crop_stage_faw$`Pr(>F)`[1]
levenes_f_val_crop_stage_faw <- levenes_crop_stage_faw$`F value`[1]


levenes_p_val_fert_aphids <- levenes_fertilizer_aphids$`Pr(>F)`[1]
levenes_f_val_fert_aphids <- levenes_fertilizer_aphids$`F value`[1]

levenes_p_val_corn_aphids <- levenes_corntype_aphids$`Pr(>F)`[1]
levenes_f_val_corn_aphids <- levenes_corntype_aphids$`F value`[1]

levenes_p_val_prov_aphids <- levenes_province_aphids$`Pr(>F)`[1]
levenes_f_val_prov_aphids <- levenes_province_aphids$`F value`[1]

levenes_p_val_crop_stage_aphids <- levenes_crop_stage_aphids$`Pr(>F)`[1]
levenes_f_val_crop_stage_aphids <- levenes_crop_stage_aphids$`F value`[1]



levenes_p_val_fert_earworm <- levenes_fertilizer_earworm$`Pr(>F)`[1]
levenes_f_val_fert_earworm <- levenes_fertilizer_earworm$`F value`[1]

levenes_p_val_corn_earworm <- levenes_corntype_earworm$`Pr(>F)`[1]
levenes_f_val_corn_earworm <- levenes_corntype_earworm$`F value`[1]

levenes_p_val_prov_earworm <- levenes_province_earworm$`Pr(>F)`[1]
levenes_f_val_prov_earworm <- levenes_province_earworm$`F value`[1]

levenes_p_val_crop_stage_earworm <- levenes_stage_earworm$`Pr(>F)`[1]
levenes_f_val_crop_stage_earworm <- levenes_stage_earworm$`F value`[1]



levenes_p_val_fert_armyworm <- levenes_fertilizer_armyworm$`Pr(>F)`[1]
levenes_f_val_fert_armyworm <- levenes_fertilizer_armyworm$`F value`[1]

levenes_p_val_corn_armyworm <- levenes_corntype_armyworm$`Pr(>F)`[1]
levenes_f_val_corn_armyworm <- levenes_corntype_armyworm$`F value`[1]

levenes_p_val_prov_armyworm <- levenes_province_armyworm$`Pr(>F)`[1]
levenes_f_val_prov_armyworm <- levenes_province_armyworm$`F value`[1]

levenes_p_val_crop_stage_armyworm <- levenes_stage_armyworm$`Pr(>F)`[1]
levenes_f_val_crop_stage_armyworm <- levenes_stage_armyworm$`F value`[1]



levenes_p_val_fert_cutworm <- levenes_fertilizer_cutworm$`Pr(>F)`[1]
levenes_f_val_fert_cutworm <- levenes_fertilizer_cutworm$`F value`[1]

levenes_p_val_corn_cutworm <- levenes_corntype_cutworm$`Pr(>F)`[1]
levenes_f_val_corn_cutworm <- levenes_corntype_cutworm$`F value`[1]

levenes_p_val_prov_cutworm <- levenes_province_cutworm$`Pr(>F)`[1]
levenes_f_val_prov_cutworm <- levenes_province_cutworm$`F value`[1]

levenes_p_val_crop_stage_cutworm <- levenes_stage_cutworm$`Pr(>F)`[1]
levenes_f_val_crop_stage_cutworm <- levenes_stage_cutworm$`F value`[1]


levenes_pest_values <-
  data.frame(
    Pests = c("Plant Hopper", "Semilooper", "Corn Borer","FAW", "Aphids", "Earworm", "Armyworm", "Cutworm"),
    `Fertilizer F-value` = c(levenes_f_val_fert_hopper, levenes_f_val_fert_semilooper, levenes_f_val_fert_borer, levenes_f_val_fert_faw, levenes_f_val_fert_aphids, levenes_f_val_fert_earworm, levenes_f_val_fert_armyworm, levenes_f_val_fert_cutworm),
    
    `Fertilizer p-value` = c(levenes_p_val_fert_hopper, levenes_p_val_fert_semilooper, levenes_p_val_fert_borer, levenes_p_val_fert_faw, levenes_p_val_fert_aphids, levenes_p_val_fert_earworm, levenes_p_val_fert_armyworm, levenes_p_val_fert_cutworm),
    
    `Corn Type F-value` = c(levenes_f_val_corn_hopper, levenes_f_val_corn_semilooper, levenes_f_val_corn_borer, levenes_f_val_corn_faw, levenes_f_val_corn_aphids, levenes_f_val_corn_earworm, levenes_f_val_corn_armyworm, levenes_f_val_corn_cutworm),
    
    `Corn Type p-value` = c(levenes_p_val_corn_hopper, levenes_p_val_corn_semilooper, levenes_p_val_corn_borer, levenes_p_val_corn_faw, levenes_p_val_corn_aphids, levenes_p_val_corn_earworm, levenes_p_val_corn_armyworm, levenes_p_val_corn_cutworm),
    
    `Province F-value` = c(levenes_f_val_prov_hopper, levenes_f_val_prov_semilooper, levenes_f_val_prov_borer, levenes_f_val_prov_faw, levenes_f_val_prov_aphids, levenes_f_val_prov_earworm, levenes_f_val_prov_armyworm, levenes_f_val_prov_cutworm),
    
    `Province p-value` = c(levenes_p_val_prov_hopper, levenes_p_val_prov_semilooper, levenes_p_val_prov_borer, levenes_p_val_prov_faw, levenes_p_val_prov_aphids, levenes_p_val_prov_earworm, levenes_p_val_prov_armyworm, levenes_p_val_prov_cutworm),
    
    `Corn Stage F-value` = c(levenes_f_val_stage_hopper, levenes_f_val_stage_semilooper, levenes_f_val_stage_borer, levenes_f_val_crop_stage_faw, levenes_f_val_crop_stage_aphids, levenes_f_val_crop_stage_earworm, levenes_f_val_crop_stage_armyworm, levenes_f_val_crop_stage_cutworm),
    
    `Corn Stage p-value` = c(levenes_p_val_stage_hopper, levenes_p_val_stage_semilooper, levenes_p_val_stage_borer, levenes_p_val_crop_stage_faw, levenes_p_val_crop_stage_aphids, levenes_p_val_crop_stage_earworm, levenes_p_val_crop_stage_armyworm, levenes_p_val_crop_stage_cutworm)
  )


write.csv(levenes_pest_values, "../Levenes_Values_Pests.csv")


```

```Values on Anova or Kruskal-Wallis Tests on Pests by Different Parameters```
```{r}

# anova or kruskal-wallis values
# Borer
p_val_borer_fertilizer <- summary(aov_fert_borer)[[1]][["Pr(>F)"]][[1]]
stat_val_borer_fertilizer <- summary(aov_fert_borer)[[1]][["F value"]][[1]] # test statistic

p_val_borer_corntype <- utest_corn_borer$p.value
stat_val_borer_corntype <- utest_corn_borer$statistic

p_val_borer_province <- kruskal_province_borer$p.value
stat_val_borer_province <- kruskal_province_borer$statistic[[1]]

p_val_borer_cropstage <- kruskal_stage_borer$p.value
stat_val_borer_cropstage <- kruskal_stage_borer$statistic[[1]]


# Semi-looper
p_val_semilooper_fertilizer <- summary(aov_fert_semilooper)[[1]][["Pr(>F)"]][[1]]
stat_val_semilooper_fertilizer <- summary(aov_fert_semilooper)[[1]][["F value"]][[1]] # test statistic

p_val_semilooper_corntype <- ttest_corn_semilooper$p.value[[1]]
stat_val_semilooper_corntype <- ttest_corn_semilooper$statistic[[1]]

p_val_semilooper_province <- summary(aov_province_semilooper)[[1]][["Pr(>F)"]][[1]]
stat_val_semilooper_province <- summary(aov_province_semilooper)[[1]][["F value"]][[1]]

p_val_semilooper_cropstage <- summary(aov_stage_semilooper)[[1]][["Pr(>F)"]][[1]]
stat_val_semilooper_cropstage <- summary(aov_stage_semilooper)[[1]][["F value"]][[1]]


# Earworm
p_val_earworm_fertilizer <- summary(aov_fert_earworm)[[1]][["Pr(>F)"]][[1]]
stat_val_earworm_fertilizer <- summary(aov_fert_earworm)[[1]][["F value"]][[1]] # test statistic

p_val_earworm_corntype <- ttest_corn_earworm$p.value[[1]]
stat_val_earworm_corntype <- ttest_corn_earworm$statistic[[1]]

p_val_earworm_province <- kruskal_province_earworm$p.value
stat_val_earworm_province <- kruskal_province_earworm$statistic[[1]]

p_val_earworm_cropstage <- kruskal_crop_stage_earworm$p.value
stat_val_earworm_cropstage <- kruskal_crop_stage_earworm$statistic[[1]]


# Hopper
p_val_hopper_fertilizer <- summary(aov_fert_hopper)[[1]][["Pr(>F)"]][[1]]
stat_val_hopper_fertilizer <- summary(aov_fert_hopper)[[1]][["F value"]][[1]] # test statistic

p_val_hopper_corntype <- ttest_corn_hopper$p.value[[1]]
stat_val_hopper_corntype <- ttest_corn_hopper$statistic[[1]]

p_val_hopper_province <- kruskal_province_hopper$p.value
stat_val_hopper_province <- kruskal_province_hopper$statistic[[1]]

p_val_hopper_cropstage <- kruskal_crop_stage_hopper$p.value
stat_val_hopper_cropstage <- kruskal_crop_stage_hopper$statistic[[1]]


# Cutworm
p_val_cutworm_fertilizer <- summary(aov_fert_cutworm)[[1]][["Pr(>F)"]][[1]]
stat_val_cutworm_fertilizer <- summary(aov_fert_cutworm)[[1]][["F value"]][[1]] # test statistic

p_val_cutworm_corntype <- ttest_corn_cutworm$p.value[[1]]
stat_val_cutworm_corntype <- ttest_corn_cutworm$statistic[[1]]

p_val_cutworm_province <- kruskal_province_cutworm$p.value
stat_val_cutworm_province <- kruskal_province_cutworm$statistic[[1]]

p_val_cutworm_cropstage <- summary(aov_stage_cutworm)[[1]][["Pr(>F)"]][[1]]
stat_val_cutworm_cropstage <- summary(aov_stage_cutworm)[[1]][["F value"]][[1]]


# Armyworm
p_val_armyworm_fertilizer <- summary(aov_fert_armyworm)[[1]][["Pr(>F)"]][[1]]
stat_val_armyworm_fertilizer <- summary(aov_fert_armyworm)[[1]][["F value"]][[1]] # test statistic

p_val_armyworm_corntype <- utest_corn_armyworm$p.value
stat_val_armyworm_corntype <- utest_corn_armyworm$statistic

p_val_armyworm_province <- kruskal_province_armyworm$p.value
stat_val_armyworm_province <- kruskal_province_armyworm$statistic[[1]]

p_val_armyworm_cropstage <- kruskal_crop_stage_armyworm$p.value
stat_val_armyworm_cropstage <- kruskal_crop_stage_armyworm$statistic[[1]]


# Aphids
p_val_aphids_fertilizer <- summary(aov_fert_aphids)[[1]][["Pr(>F)"]][[1]]
stat_val_aphids_fertilizer <- summary(aov_fert_aphids)[[1]][["F value"]][[1]] # test statistic

p_val_aphids_corntype <- utest_corn_aphids$p.value
stat_val_aphids_corntype <- utest_corn_aphids$statistic

p_val_aphids_province <- kruskal_province_aphids$p.value
stat_val_aphids_province <- kruskal_province_aphids$statistic[[1]]

p_val_aphids_cropstage <- kruskal_crop_stage_aphids$p.value
stat_val_aphids_cropstage <- kruskal_crop_stage_aphids$statistic[[1]]

# FAW
p_val_faw_fertilizer <- summary(aov_fert_faw)[[1]][["Pr(>F)"]][[1]]
stat_val_faw_fertilizer <- summary(aov_fert_faw)[[1]][["F value"]][[1]] # test statistic

p_val_faw_corntype <- ttest_corn_faw$p.value[[1]]
stat_val_faw_corntype <- ttest_corn_faw$statistic[[1]]

p_val_faw_province <- kruskal_province_faw$p.value
stat_val_faw_province <- kruskal_province_faw$statistic[[1]]

p_val_faw_cropstage <- summary(aov_crop_stage_faw)[[1]][["Pr(>F)"]][[1]]
stat_val_faw_cropstage <- summary(aov_crop_stage_faw)[[1]][["F value"]][[1]]


# anova or kruskal-wallis values
pests_test_values <-
  tibble(
    Pests = c("Corn Borer", "Semilooper", "Earworm", "Plant Hopper", "Cutworm", "Armyworm", "Aphids", "FAW"),
    
    P_Fertilizer = c(p_val_borer_fertilizer, p_val_semilooper_fertilizer, p_val_earworm_fertilizer, p_val_hopper_fertilizer, p_val_cutworm_fertilizer, p_val_armyworm_fertilizer, p_val_aphids_fertilizer, p_val_faw_fertilizer),
    
    Stat_Fertilizer = c(stat_val_borer_fertilizer, stat_val_semilooper_fertilizer, stat_val_earworm_fertilizer, stat_val_hopper_fertilizer, stat_val_cutworm_fertilizer, stat_val_armyworm_fertilizer, stat_val_aphids_fertilizer, stat_val_faw_fertilizer),
    
    
    P_CornType = c(p_val_borer_corntype, p_val_semilooper_corntype, p_val_earworm_corntype, p_val_hopper_corntype, p_val_cutworm_corntype, p_val_armyworm_corntype, p_val_aphids_corntype, p_val_faw_corntype),
    
    Stat_CornType = c(stat_val_borer_corntype, stat_val_semilooper_corntype, stat_val_earworm_corntype, stat_val_hopper_corntype, stat_val_cutworm_corntype, stat_val_armyworm_corntype, stat_val_aphids_corntype, stat_val_faw_corntype),
    
    
    P_Province = c(p_val_borer_province, p_val_semilooper_province, p_val_earworm_province, p_val_hopper_province, p_val_cutworm_province, p_val_armyworm_province, p_val_aphids_province, p_val_faw_province),
    
    Stat_Province = c(stat_val_borer_province, stat_val_semilooper_province, stat_val_earworm_province, stat_val_hopper_province, stat_val_cutworm_province, stat_val_armyworm_province, stat_val_aphids_province, stat_val_faw_province),
    
    
    P_CropStage = c(p_val_borer_cropstage, p_val_semilooper_cropstage, p_val_earworm_cropstage, p_val_hopper_cropstage, p_val_cutworm_cropstage, p_val_armyworm_cropstage, p_val_aphids_cropstage, p_val_faw_cropstage),
    
    Stat_CropStage = c(stat_val_borer_cropstage, stat_val_semilooper_cropstage, stat_val_earworm_cropstage, stat_val_hopper_cropstage, stat_val_cutworm_cropstage, stat_val_armyworm_cropstage, stat_val_aphids_cropstage, stat_val_faw_cropstage),
  )


write_csv(pests_test_values, "../Anova_KruskalWallis_Test_Values_on_Pests.csv")

lakw <- levenes_pest_values %>% left_join(pests_test_values, by = c("Pests"))
write.csv(lakw, "../lakw.csv")
```


```Pest correlation with rstatix package```
```{r}
# faw, hopper, cutworm, armyworm, aphids, borer, earworm, semilooper
library("rstatix")

# earworm
earworm_cor_windx <- cor_test(earworm_ev, "mean_wind", "incidence_earworm")
earworm_cor_tempx <- cor_test(earworm_ev, "mean_temp", "incidence_earworm")
earworm_cor_humidx <- cor_test(earworm_ev, "mean_humid", "incidence_earworm")
earworm_cor_rainx <- cor_test(earworm_ev, "mean_rain", "incidence_earworm")

corr_earworm_dfx <- data.frame(
  weather_parameter = c(earworm_cor_windx$var1, earworm_cor_tempx$var1, earworm_cor_humidx$var1, earworm_cor_rainx$var1),
  incidence = c(earworm_cor_windx$var2, earworm_cor_tempx$var2, earworm_cor_humidx$var2, earworm_cor_rainx$var2),
  r_coef = c(earworm_cor_windx$cor, earworm_cor_tempx$cor, earworm_cor_humidx$cor, earworm_cor_rainx$cor),
  p_val  = c(earworm_cor_windx$p, earworm_cor_tempx$p, earworm_cor_humidx$p, earworm_cor_rainx$p)
) %>% mutate(r_coef = round(r_coef, 3),
             p_val = round(p_val, 4))



# borer
borer_cor_windx <- cor_test(borer_ev, "mean_wind", "incidence_borer")
borer_cor_tempx <- cor_test(borer_ev, "mean_temp", "incidence_borer")
borer_cor_humidx <- cor_test(borer_ev, "mean_humid", "incidence_borer")
borer_cor_rainx <- cor_test(borer_ev, "mean_rain", "incidence_borer")

corr_borer_dfx <- data.frame(
  weather_parameter = c(borer_cor_windx$var1, borer_cor_tempx$var1, borer_cor_humidx$var1, borer_cor_rainx$var1),
  incidence = c(borer_cor_windx$var2, borer_cor_tempx$var2, borer_cor_humidx$var2, borer_cor_rainx$var2),
  r_coef = c(borer_cor_windx$cor, borer_cor_tempx$cor, borer_cor_humidx$cor, borer_cor_rainx$cor),
  p_val  = c(borer_cor_windx$p, borer_cor_tempx$p, borer_cor_humidx$p, borer_cor_rainx$p)
) %>% mutate(r_coef = round(r_coef, 3),
             p_val = round(p_val, 4))


# semilooper
semilooper_cor_windx <- cor_test(semilooper_ev, "mean_wind", "incidence_semilooper")
semilooper_cor_tempx <- cor_test(semilooper_ev, "mean_temp", "incidence_semilooper")
semilooper_cor_humidx <- cor_test(semilooper_ev, "mean_humid", "incidence_semilooper")
semilooper_cor_rainx <- cor_test(semilooper_ev, "mean_rain", "incidence_semilooper")

corr_semilooper_dfx <- data.frame(
  weather_parameter = c(semilooper_cor_windx$var1, semilooper_cor_tempx$var1, semilooper_cor_humidx$var1, semilooper_cor_rainx$var1),
  incidence = c(semilooper_cor_windx$var2, semilooper_cor_tempx$var2, semilooper_cor_humidx$var2, semilooper_cor_rainx$var2),
  r_coef = c(semilooper_cor_windx$cor, semilooper_cor_tempx$cor, semilooper_cor_humidx$cor, semilooper_cor_rainx$cor),
  p_val  = c(semilooper_cor_windx$p, semilooper_cor_tempx$p, semilooper_cor_humidx$p, semilooper_cor_rainx$p)
) %>% mutate(r_coef = round(r_coef, 3),
             p_val = round(p_val, 4))


# cutworm
cutworm_cor_windx <- cor_test(cutworm_ev, "mean_wind", "incidence_cutworm")
cutworm_cor_tempx <- cor_test(cutworm_ev, "mean_temp", "incidence_cutworm")
cutworm_cor_humidx <- cor_test(cutworm_ev, "mean_humid", "incidence_cutworm")
cutworm_cor_rainx <- cor_test(cutworm_ev, "mean_rain", "incidence_cutworm")

corr_cutworm_dfx <- data.frame(
  weather_parameter = c(cutworm_cor_windx$var1, cutworm_cor_tempx$var1, cutworm_cor_humidx$var1, cutworm_cor_rainx$var1),
  incidence = c(cutworm_cor_windx$var2, cutworm_cor_tempx$var2, cutworm_cor_humidx$var2, cutworm_cor_rainx$var2),
  r_coef = c(cutworm_cor_windx$cor, cutworm_cor_tempx$cor, cutworm_cor_humidx$cor, cutworm_cor_rainx$cor),
  p_val  = c(cutworm_cor_windx$p, cutworm_cor_tempx$p, cutworm_cor_humidx$p, cutworm_cor_rainx$p)
) %>% mutate(r_coef = round(r_coef, 3),
             p_val = round(p_val, 4))



# hopper
hopper_cor_windx <- cor_test(hopper_ev, "mean_wind", "incidence_hopper")
hopper_cor_tempx <- cor_test(hopper_ev, "mean_temp", "incidence_hopper")
hopper_cor_humidx <- cor_test(hopper_ev, "mean_humid", "incidence_hopper")
hopper_cor_rainx <- cor_test(hopper_ev, "mean_rain", "incidence_hopper")

corr_hopper_dfx <- data.frame(
  weather_parameter = c(hopper_cor_windx$var1, hopper_cor_tempx$var1, hopper_cor_humidx$var1, hopper_cor_rainx$var1),
  incidence = c(hopper_cor_windx$var2, hopper_cor_tempx$var2, hopper_cor_humidx$var2, hopper_cor_rainx$var2),
  r_coef = c(hopper_cor_windx$cor, hopper_cor_tempx$cor, hopper_cor_humidx$cor, hopper_cor_rainx$cor),
  p_val  = c(hopper_cor_windx$p, hopper_cor_tempx$p, hopper_cor_humidx$p, hopper_cor_rainx$p)
) %>% mutate(r_coef = round(r_coef, 3),
             p_val = round(p_val, 4))




# aphids
aphids_cor_windx <- cor_test(aphids_ev, "mean_wind", "incidence_aphids")
aphids_cor_tempx <- cor_test(aphids_ev, "mean_temp", "incidence_aphids")
aphids_cor_humidx <- cor_test(aphids_ev, "mean_humid", "incidence_aphids")
aphids_cor_rainx <- cor_test(aphids_ev, "mean_rain", "incidence_aphids")

corr_aphids_dfx <- data.frame(
  weather_parameter = c(aphids_cor_windx$var1, aphids_cor_tempx$var1, aphids_cor_humidx$var1, aphids_cor_rainx$var1),
  incidence = c(aphids_cor_windx$var2, aphids_cor_tempx$var2, aphids_cor_humidx$var2, aphids_cor_rainx$var2),
  r_coef = c(aphids_cor_windx$cor, aphids_cor_tempx$cor, aphids_cor_humidx$cor, aphids_cor_rainx$cor),
  p_val  = c(aphids_cor_windx$p, aphids_cor_tempx$p, aphids_cor_humidx$p, aphids_cor_rainx$p)
) %>% mutate(r_coef = round(r_coef, 3),
             p_val = round(p_val, 4))



# armyworm
armyworm_cor_windx <- cor_test(armyworm_ev, "mean_wind", "incidence_armyworm")
armyworm_cor_tempx <- cor_test(armyworm_ev, "mean_temp", "incidence_armyworm")
armyworm_cor_humidx <- cor_test(armyworm_ev, "mean_humid", "incidence_armyworm")
armyworm_cor_rainx <- cor_test(armyworm_ev, "mean_rain", "incidence_armyworm")

corr_armyworm_dfx <- data.frame(
  weather_parameter = c(armyworm_cor_windx$var1, armyworm_cor_tempx$var1, armyworm_cor_humidx$var1, armyworm_cor_rainx$var1),
  incidence = c(armyworm_cor_windx$var2, armyworm_cor_tempx$var2, armyworm_cor_humidx$var2, armyworm_cor_rainx$var2),
  r_coef = c(armyworm_cor_windx$cor, armyworm_cor_tempx$cor, armyworm_cor_humidx$cor, armyworm_cor_rainx$cor),
  p_val  = c(armyworm_cor_windx$p, armyworm_cor_tempx$p, armyworm_cor_humidx$p, armyworm_cor_rainx$p)
) %>% mutate(r_coef = round(r_coef, 3),
             p_val = round(p_val, 4))



# faw
faw_cor_windx <- cor_test(faw_ev, "mean_wind", "incidence_faw")
faw_cor_tempx <- cor_test(faw_ev, "mean_temp", "incidence_faw")
faw_cor_humidx <- cor_test(faw_ev, "mean_humid", "incidence_faw")
faw_cor_rainx <- cor_test(faw_ev, "mean_rain", "incidence_faw")

corr_faw_dfx <- data.frame(
  weather_parameter = c(faw_cor_windx$var1, faw_cor_tempx$var1, faw_cor_humidx$var1, faw_cor_rainx$var1),
  incidence = c(faw_cor_windx$var2, faw_cor_tempx$var2, faw_cor_humidx$var2, faw_cor_rainx$var2),
  r_coef = c(faw_cor_windx$cor, faw_cor_tempx$cor, faw_cor_humidx$cor, faw_cor_rainx$cor),
  p_val  = c(faw_cor_windx$p, faw_cor_tempx$p, faw_cor_humidx$p, faw_cor_rainx$p)
) %>% mutate(r_coef = round(r_coef, 3),
             p_val = round(p_val, 4))



weather_pest_corrstatix <-
  corr_faw_dfx %>% 
  full_join(corr_hopper_dfx) %>% 
  full_join(corr_cutworm_dfx) %>% 
  full_join(corr_armyworm_dfx) %>%
  full_join(corr_aphids_dfx) %>%
  full_join(corr_borer_dfx) %>%
  full_join(corr_earworm_dfx) %>%
  full_join(corr_semilooper_dfx)

weather_pest_corrstatix



detach("package:ggpubr", unload = TRUE)
detach("package:rstatix", unload = TRUE)
```


```{r}
# faw
print(paste(round(correlation::cor_to_p(cor_faw_wind_incidence, sample_size_corr)$p, decimal_places), "correlation p-value of wind speed and FAW incidence."))
print(paste(round(correlation::cor_to_p(cor_faw_temp_incidence, sample_size_corr)$p, decimal_places), "correlation p-value of temperature and FAW incidence."))
print(paste(round(correlation::cor_to_p(cor_faw_humid_incidence, sample_size_corr)$p, decimal_places), "correlation p-value of humidity and FAW incidence."))
print(paste(round(correlation::cor_to_p(cor_faw_rain_incidence, sample_size_corr)$p, decimal_places), "correlation p-value of rainfall and FAW incidence."))

# aphids
print(paste(round(correlation::cor_to_p(cor_aphids_wind_incidence, sample_size_corr)$p, decimal_places), "correlation p-value of wind speed and aphids incidence."))
print(paste(round(correlation::cor_to_p(cor_aphids_temp_incidence, sample_size_corr)$p, decimal_places), "correlation p-value of temperature and aphids incidence."))
print(paste(round(correlation::cor_to_p(cor_aphids_humid_incidence, sample_size_corr)$p, decimal_places), "correlation p-value of humidity and aphids incidence."))
print(paste(round(correlation::cor_to_p(cor_aphids_rain_incidence, sample_size_corr)$p, decimal_places), "correlation p-value of rainfall and aphids incidence."))


# borer
print(paste(round(correlation::cor_to_p(cor_borer_wind_incidence, sample_size_corr)$p, decimal_places), "correlation p-value of wind speed and borer incidence."))
print(paste(round(correlation::cor_to_p(cor_borer_temp_incidence, sample_size_corr)$p, decimal_places), "correlation p-value of temperature and borer incidence."))
print(paste(round(correlation::cor_to_p(cor_borer_humid_incidence, sample_size_corr)$p, decimal_places), "correlation p-value of humidity and borer incidence."))
print(paste(round(correlation::cor_to_p(cor_borer_rain_incidence, sample_size_corr)$p, decimal_places), "correlation p-value of rainfall and borer incidence."))


# earworm
print(paste(round(correlation::cor_to_p(cor_earworm_wind_incidence, sample_size_corr)$p, decimal_places), "correlation p-value of wind speed and earworm incidence."))
print(paste(round(correlation::cor_to_p(cor_earworm_temp_incidence, sample_size_corr)$p, decimal_places), "correlation p-value of temperature and earworm incidence."))
print(paste(round(correlation::cor_to_p(cor_earworm_humid_incidence, sample_size_corr)$p, decimal_places), "correlation p-value of humidity and earworm incidence."))
print(paste(round(correlation::cor_to_p(cor_earworm_rain_incidence, sample_size_corr)$p, decimal_places), "correlation p-value of rainfall and earworm incidence."))


# Armyworm
print(paste(round(correlation::cor_to_p(cor_armyworm_wind_incidence, sample_size_corr)$p, decimal_places), "correlation p-value of wind speed and armyworm incidence."))
print(paste(round(correlation::cor_to_p(cor_armyworm_temp_incidence, sample_size_corr)$p, decimal_places), "correlation p-value of temperature and armyworm incidence."))
print(paste(round(correlation::cor_to_p(cor_armyworm_humid_incidence, sample_size_corr)$p, decimal_places), "correlation p-value of humidity and armyworm incidence."))
print(paste(round(correlation::cor_to_p(cor_armyworm_rain_incidence, sample_size_corr)$p, decimal_places), "correlation p-value of rainfall and armyworm incidence."))


# Cutworm
print(paste(round(correlation::cor_to_p(cor_cutworm_wind_incidence, sample_size_corr)$p, decimal_places), "correlation p-value of wind speed and cutworm incidence."))
print(paste(round(correlation::cor_to_p(cor_cutworm_temp_incidence, sample_size_corr)$p, decimal_places), "correlation p-value of temperature and cutworm incidence."))
print(paste(round(correlation::cor_to_p(cor_cutworm_humid_incidence, sample_size_corr)$p, decimal_places), "correlation p-value of humidity and cutworm incidence."))
print(paste(round(correlation::cor_to_p(cor_cutworm_rain_incidence, sample_size_corr)$p, decimal_places), "correlation p-value of rainfall and cutworm incidence."))

# Hopper
print(paste(round(correlation::cor_to_p(cor_hopper_wind_incidence, sample_size_corr)$p, decimal_places), "correlation p-value of wind speed and hopper incidence."))
print(paste(round(correlation::cor_to_p(cor_hopper_temp_incidence, sample_size_corr)$p, decimal_places), "correlation p-value of temperature and hopper incidence."))
print(paste(round(correlation::cor_to_p(cor_hopper_humid_incidence, sample_size_corr)$p, decimal_places), "correlation p-value of humidity and hopper incidence."))
print(paste(round(correlation::cor_to_p(cor_hopper_rain_incidence, sample_size_corr)$p, decimal_places), "correlation p-value of rainfall and hopper incidence."))



```


```{r}
# library("bestNormalize")
# bestNorm_semilooper <- predict(bestNormalize(summary_semilooper$percent_incidence_semilooper, out_of_sample = FALSE, loo = TRUE))
# detach("package:bestNormalize", unload = TRUE)

# 
# # center_scale(x) tranformation according to bestNormalize
# summary_semilooper$orq <- bestNorm_semilooper
# 
# # Test of Normality after transformation
# ks_test_semilooper_trans <- ks.test(summary_semilooper$orq, 'pnorm')
# ad_test_semilooper_trans <- ad.test(summary_semilooper$orq)
# skew_semilooper_trans <- skewness(summary_semilooper$orq)
# kurt_semilooper_trans <- kurtosis(summary_semilooper$orq)
# jarq_semilooper_trans <- jarque.test(summary_semilooper$orq)
# 
# 
# # Test of Homoskedasticity after transformation
# levenes_fertilizer_semilooper_trans <- leveneTest(orq ~ Treatment, summary_semilooper)
# levenes_corntype_semilooper_trans <- leveneTest(orq ~ `Corn Type`, summary_semilooper)
# levenes_municipality_semilooper_trans <- leveneTest(orq ~ Municipality, summary_semilooper)
# levenes_province_semilooper_trans <- leveneTest(orq ~ Province, summary_semilooper)
# levenes_fert_corn_semilooper_trans <- leveneTest(orq ~ interaction(Treatment, `Corn Type`), summary_semilooper)
# 
# summary_semilooper %>%
#   ggplot(aes(orq)) +
#   geom_density()
# 
# # anova on Transformation
# aov_fert_semilooper_yj <- aov(orq ~ order_treat, summary_semilooper) %>% summary()
# aov_corn_semilooper_yj <- aov(orq ~ factor_corn, summary_semilooper) %>% summary()
# # Two way AnOVa
# 
# twoway_fert_corn_semilooper_yj <- aov(orq ~ order_treat + factor_corn, summary_semilooper) 
# tukey_fert_corn_semilooper <- TukeyHSD(twoway_fert_corn_semilooper_yj)
# 
# # AnOVa with Interaction
# aov_fert_corn_inter_semilooper_yj <- aov(orq ~ order_treat*factor_corn, summary_semilooper)  %>% summary()
```













